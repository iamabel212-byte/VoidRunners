<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no">
<title>VOID RUNNERS</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=Exo+2:wght@300;400;700;900&family=Orbitron:wght@400;700;900&display=swap');
:root{--c:#00f5ff;--o:#ff6a00;--g:#ffd700;--p:#9b59ff;--r:#ff3366;--gr:#39ff8a;--bg:#02020a;}
*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent;user-select:none;}
html,body{width:100%;height:100%;background:var(--bg);overflow:hidden;font-family:'Exo 2',sans-serif;touch-action:none;}
canvas{position:fixed;top:0;left:0;width:100%;height:100%;}
#hud{position:fixed;top:0;left:0;right:0;padding:10px 14px 0;pointer-events:none;z-index:10;}
#topRow{display:flex;justify-content:space-between;align-items:flex-start;gap:10px;}
.bg{flex:1;}.bl{font-size:9px;letter-spacing:3px;color:#334;margin-bottom:3px;font-family:'Orbitron',sans-serif;}
.bt{height:7px;background:rgba(255,255,255,0.04);overflow:hidden;border:1px solid rgba(0,245,255,0.12);}
.bf{height:100%;transition:width .15s;}
#hpF{background:linear-gradient(90deg,#ff3366,#ff6a00);}
#xpF{background:linear-gradient(90deg,#0af,var(--c));}
#cs{text-align:center;line-height:1.3;}
#td{font-family:'Orbitron',sans-serif;font-size:18px;color:var(--c);letter-spacing:3px;text-shadow:0 0 10px var(--c);}
#wd{font-size:10px;color:#334;letter-spacing:3px;}
#chd{font-size:9px;color:var(--o);letter-spacing:2px;min-height:14px;}
#bb{position:fixed;bottom:175px;left:50%;transform:translateX(-50%);width:min(360px,85vw);display:none;z-index:10;pointer-events:none;}
#bbl{font-family:'Orbitron',sans-serif;font-size:10px;color:var(--g);letter-spacing:2px;text-align:center;margin-bottom:4px;text-shadow:0 0 12px var(--g);}
#btr{height:11px;background:rgba(255,255,255,0.05);border:1px solid rgba(255,215,0,0.3);}
#bf2{height:100%;background:linear-gradient(90deg,#ff6a00,var(--g));transition:width .1s;}
#ab{position:fixed;bottom:130px;right:14px;display:flex;flex-direction:column;gap:8px;z-index:10;touch-action:none;}
.abn{width:62px;height:62px;border-radius:50%;border:2px solid rgba(0,245,255,0.2);background:rgba(2,2,16,0.9);display:flex;flex-direction:column;align-items:center;justify-content:center;cursor:pointer;position:relative;overflow:hidden;}
.abn .ic{font-size:22px;line-height:1;}.abn .cl{font-size:8px;font-family:'Orbitron',sans-serif;color:rgba(0,245,255,0.5);margin-top:2px;}
.abn .co{position:absolute;bottom:0;left:0;right:0;background:rgba(0,0,0,0.7);}
.abn.rdy{border-color:var(--c);box-shadow:0 0 14px rgba(0,245,255,0.35);}
.abn.upg{border-color:var(--g);}.abn.upg.rdy{box-shadow:0 0 18px rgba(255,215,0,0.5);}
#jz{position:fixed;bottom:20px;left:20px;width:140px;height:140px;z-index:10;touch-action:none;}
#jb{width:100%;height:100%;border-radius:50%;background:rgba(0,245,255,0.03);border:2px solid rgba(0,245,255,0.1);}
#jk{width:52px;height:52px;border-radius:50%;background:radial-gradient(circle at 35% 35%,rgba(0,245,255,0.35),rgba(0,245,255,0.08));border:2px solid rgba(0,245,255,0.25);position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);}
#brow{position:fixed;top:68px;left:14px;display:flex;gap:5px;flex-wrap:wrap;max-width:calc(100vw - 90px);z-index:10;pointer-events:none;}
.bch{background:rgba(2,2,16,0.9);border:1px solid rgba(0,245,255,0.18);padding:3px 7px;font-size:10px;display:flex;align-items:center;gap:4px;border-radius:2px;}
.bch .bt2{color:var(--g);font-family:'Orbitron',sans-serif;font-size:8px;}
#prow{position:fixed;top:68px;right:14px;display:flex;flex-direction:column;gap:3px;z-index:10;pointer-events:none;align-items:flex-end;}
.pch{background:rgba(10,2,20,0.9);border:1px solid rgba(155,89,255,0.4);padding:2px 7px;font-size:9px;color:var(--p);font-family:'Orbitron',sans-serif;letter-spacing:1px;border-radius:2px;}
#galaxyBadge{position:fixed;top:36px;left:50%;transform:translateX(-50%);font-family:'Orbitron',sans-serif;font-size:9px;letter-spacing:3px;pointer-events:none;z-index:10;color:#334;}
#warpOverlay{position:fixed;inset:0;z-index:45;pointer-events:none;opacity:0;transition:opacity .4s;display:flex;flex-direction:column;align-items:center;justify-content:center;}
#warpTitle{font-family:'Orbitron',sans-serif;font-size:clamp(18px,5vw,32px);font-weight:900;letter-spacing:6px;text-align:center;margin-bottom:6px;}
#warpSub{font-family:'Orbitron',sans-serif;font-size:11px;letter-spacing:4px;text-align:center;opacity:.7;}
.ov{position:fixed;inset:0;display:flex;flex-direction:column;align-items:center;justify-content:center;background:rgba(2,2,10,0.96);z-index:50;padding:0 0 20px;}
.ov h1{font-family:'Orbitron',sans-serif;font-size:clamp(28px,7vw,52px);font-weight:900;color:var(--c);text-shadow:0 0 40px var(--c),0 0 80px rgba(0,245,255,0.3);letter-spacing:6px;margin-bottom:4px;}
.tl{color:#223;font-size:11px;letter-spacing:4px;margin-bottom:24px;font-family:'Orbitron',sans-serif;}
.btn{font-family:'Orbitron',sans-serif;font-size:15px;letter-spacing:3px;padding:16px 0;width:min(88vw,400px);background:transparent;border:1px solid var(--c);color:var(--c);cursor:pointer;transition:background .15s,box-shadow .15s;margin:5px 0;display:block;text-align:center;border-radius:3px;}
.btn:active{background:rgba(0,245,255,0.12);box-shadow:0 0 20px var(--c);}
.btng{border-color:var(--g);color:var(--g);}.btng:active{background:rgba(255,215,0,0.12);box-shadow:0 0 20px var(--g);}
.btno{border-color:var(--o);color:var(--o);}.btno:active{background:rgba(255,106,0,0.12);box-shadow:0 0 20px var(--o);}
#lup{position:fixed;inset:0;display:none;flex-direction:column;align-items:center;justify-content:center;background:rgba(2,2,10,0.95);z-index:40;pointer-events:all;}
#lup h2{font-family:'Orbitron',sans-serif;color:var(--c);font-size:22px;letter-spacing:4px;text-shadow:0 0 20px var(--c);margin-bottom:3px;}
#lup .sub{color:#223;font-size:9px;letter-spacing:3px;margin-bottom:20px;}
#uc{display:flex;gap:11px;flex-wrap:wrap;justify-content:center;max-width:420px;}
.uc{width:114px;padding:12px 8px;border:1px solid rgba(0,245,255,0.18);background:rgba(4,12,24,0.95);cursor:pointer;text-align:center;transition:all .2s;border-radius:3px;}
.uc:hover,.uc:active{border-color:var(--c);box-shadow:0 0 16px rgba(0,245,255,0.25);transform:translateY(-3px);}
.uc .ui{font-size:22px;margin-bottom:6px;}.uc .un{font-family:'Orbitron',sans-serif;font-size:8px;color:var(--c);letter-spacing:1px;margin-bottom:3px;}.uc .ud{font-size:8px;color:#2a4;line-height:1.4;}
#pp{position:fixed;inset:0;display:none;flex-direction:column;align-items:center;background:rgba(2,2,10,0.98);z-index:60;pointer-events:all;padding:18px 0 24px;overflow-y:auto;}
#pp h2{font-family:'Orbitron',sans-serif;color:var(--g);font-size:clamp(13px,4vw,20px);letter-spacing:4px;text-shadow:0 0 20px var(--g);margin-bottom:3px;}
.sub2{color:#332200;font-size:9px;letter-spacing:3px;margin-bottom:8px;}
.ptabs{display:flex;gap:0;margin-bottom:16px;width:min(92vw,460px);}
.ptab{font-family:'Orbitron',sans-serif;font-size:11px;letter-spacing:2px;padding:12px 0;flex:1;border:1px solid rgba(255,215,0,0.15);color:#443300;cursor:pointer;background:transparent;text-align:center;}
.ptab.act{border-color:var(--g);color:var(--g);background:rgba(255,215,0,0.08);}
/* Badge styles */
#badgeGrid{display:flex;gap:8px;flex-wrap:wrap;justify-content:center;max-width:520px;margin-bottom:16px;}
.bdg{width:96px;padding:10px 6px;border-radius:4px;text-align:center;border:1px solid rgba(255,255,255,0.08);background:rgba(6,6,20,0.97);position:relative;transition:all .2s;}
.bdg.locked{opacity:0.38;filter:grayscale(0.7);}
.bdg.unlocked{border-color:var(--bdgCol,#888);box-shadow:0 0 14px var(--bdgGlow,rgba(255,255,255,0.15));}
.bdg .bdgIcon{font-size:26px;line-height:1;margin-bottom:4px;}
.bdg .bdgName{font-family:'Orbitron',sans-serif;font-size:7px;color:var(--bdgCol,#444);letter-spacing:1px;margin-bottom:2px;}
.bdg .bdgDesc{font-size:7px;color:#334;line-height:1.4;margin-bottom:4px;}
.bdg .bdgProg{font-family:'Orbitron',sans-serif;font-size:7px;color:#446;}
.bdg .bdgTier{position:absolute;top:3px;right:4px;font-size:9px;}
.bdg.bronze{--bdgCol:#cd7f32;--bdgGlow:rgba(205,127,50,0.3);}
.bdg.silver{--bdgCol:#c0c0c0;--bdgGlow:rgba(192,192,192,0.3);}
.bdg.gold{--bdgCol:#ffd700;--bdgGlow:rgba(255,215,0,0.4);}
.bdg.plat{--bdgCol:#e5e4e2;--bdgGlow:rgba(180,255,255,0.5);background:rgba(10,10,30,0.97);}
#badgeCount{font-family:'Orbitron',sans-serif;font-size:10px;color:#446;letter-spacing:2px;margin-bottom:12px;}
#pcoins{font-family:'Orbitron',sans-serif;color:var(--g);font-size:13px;letter-spacing:2px;margin-bottom:14px;}
#pcards{display:flex;flex-direction:column;gap:0;width:min(92vw,460px);margin-bottom:16px;}
.pcards{display:flex;flex-direction:column;gap:0;width:min(92vw,460px);margin-bottom:16px;}
.pcard{width:100%;padding:14px 16px;cursor:pointer;display:flex;align-items:center;gap:14px;border:none;border-bottom:1px solid rgba(155,89,255,0.1);background:rgba(10,4,20,0.95);position:relative;box-sizing:border-box;}
.pcard:active{background:rgba(155,89,255,0.08);}
.pcard.mx{opacity:0.3;pointer-events:none;}
.pcard.glocked{opacity:0.35;pointer-events:none;}
.pcard .pi{font-size:26px;flex-shrink:0;width:34px;text-align:center;}
.pcard .pmid{flex:1;min-width:0;}
.pcard .pn{font-family:'Orbitron',sans-serif;font-size:11px;color:var(--p);letter-spacing:1px;margin-bottom:3px;}
.pcard .pd{font-size:10px;color:#446;line-height:1.3;}
.pcard .pright{text-align:right;flex-shrink:0;}
.pcard .prk{font-family:'Orbitron',sans-serif;font-size:10px;color:var(--p);margin-bottom:4px;}
.pcard .pc2{font-family:'Orbitron',sans-serif;font-size:11px;color:var(--g);}
#sp{position:fixed;inset:0;display:none;flex-direction:column;align-items:center;background:rgba(2,2,10,0.98);z-index:60;pointer-events:all;padding:18px 0 24px;overflow-y:auto;}
#sp h2{font-family:'Orbitron',sans-serif;color:var(--o);font-size:clamp(13px,4vw,20px);letter-spacing:4px;text-shadow:0 0 20px var(--o);margin-bottom:4px;}
#sg{display:flex;flex-direction:column;gap:0;width:min(92vw,460px);margin-bottom:16px;}
.sk{width:100%;padding:16px 18px;display:flex;align-items:center;gap:14px;border:none;border-bottom:1px solid rgba(255,255,255,0.06);background:transparent;cursor:pointer;box-sizing:border-box;}
.sk:active{background:rgba(255,255,255,0.04);}
.sk.sel{background:rgba(255,215,0,0.04);}
.sk .skdot{width:14px;height:14px;border-radius:50%;flex-shrink:0;}
.sk .skmid{flex:1;min-width:0;}
.sk .sn{font-family:'Orbitron',sans-serif;font-size:13px;letter-spacing:2px;margin-bottom:3px;}
.sk .sd{font-size:10px;color:#446;line-height:1.3;}
.sk .skright{text-align:right;flex-shrink:0;font-family:'Orbitron',sans-serif;font-size:11px;}
#wa{position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);font-family:'Orbitron',sans-serif;font-size:clamp(14px,4vw,22px);color:var(--r);text-shadow:0 0 20px var(--r);letter-spacing:4px;pointer-events:none;opacity:0;z-index:30;transition:opacity .5s;text-align:center;white-space:pre-line;line-height:1.6;}
#kf{position:fixed;top:84px;left:50%;transform:translateX(-50%);font-family:'Orbitron',sans-serif;font-size:12px;color:var(--g);pointer-events:none;opacity:0;z-index:20;transition:opacity .4s;letter-spacing:3px;}
#pf{position:fixed;top:42%;left:50%;transform:translate(-50%,-50%);font-family:'Orbitron',sans-serif;font-size:14px;pointer-events:none;opacity:0;z-index:20;transition:opacity .5s;text-align:center;}
#pauseBtn{position:fixed;top:44px;right:12px;width:44px;height:28px;border-radius:14px;border:1px solid rgba(0,245,255,0.3);background:rgba(2,2,16,0.9);display:none;align-items:center;justify-content:center;cursor:pointer;z-index:20;font-size:13px;color:rgba(0,245,255,0.7);letter-spacing:1px;}
#pauseBtn:active{background:rgba(0,245,255,0.15);}
#miningRing{position:fixed;border-radius:50%;border:2px solid #00f5ff;pointer-events:none;z-index:8;display:none;}
#pauseMenu{position:fixed;inset:0;display:none;flex-direction:column;align-items:center;justify-content:center;background:rgba(2,2,10,0.92);z-index:35;pointer-events:all;}
#pauseMenu h2{font-family:'Orbitron',sans-serif;font-size:28px;color:var(--c);letter-spacing:6px;text-shadow:0 0 20px var(--c);margin-bottom:24px;}
#shieldRow{display:flex;flex-direction:column;gap:2px;margin-top:4px;}
#shieldLbl{font-size:9px;letter-spacing:3px;color:#88aaff;font-family:'Orbitron',sans-serif;display:none;}
#shieldBar{height:5px;background:rgba(255,255,255,0.04);overflow:hidden;border:1px solid rgba(100,150,255,0.3);display:none;}
#shieldF{height:100%;background:linear-gradient(90deg,#6688ff,#aaccff);transition:width .2s;}
#bshop{position:fixed;inset:0;display:none;flex-direction:column;align-items:center;background:rgba(2,2,10,0.98);z-index:60;pointer-events:all;padding:18px 0 24px;overflow-y:auto;}
#bshop h2{font-family:'Orbitron',sans-serif;color:#00f5ff;font-size:clamp(13px,4vw,20px);letter-spacing:4px;text-shadow:0 0 20px #00f5ff;margin-bottom:4px;}
#bshopCoins{font-family:'Orbitron',sans-serif;color:var(--g);font-size:13px;letter-spacing:2px;margin-bottom:14px;}
#bshopCards{display:flex;flex-direction:column;gap:0;width:min(92vw,460px);margin-bottom:16px;}
#miningBar{position:fixed;bottom:168px;left:50%;transform:translateX(-50%);width:min(180px,50vw);display:none;z-index:12;pointer-events:none;}
#miningLbl{font-family:'Orbitron',sans-serif;font-size:8px;color:#00f5ff;letter-spacing:2px;text-align:center;margin-bottom:2px;}
#miningTrack{height:6px;background:rgba(255,255,255,0.05);border:1px solid rgba(0,245,255,0.3);}
#miningFill{height:100%;background:linear-gradient(90deg,#00f5ff,#ffffff);width:0%;transition:width .05s;}
/* Relic orb & portal */
#relicNotif{position:fixed;top:90px;left:50%;transform:translateX(-50%) translateY(-20px);background:rgba(2,2,16,0.97);border:1px solid #9b59ff;border-radius:4px;padding:8px 18px;font-family:'Orbitron',sans-serif;font-size:10px;letter-spacing:2px;opacity:0;z-index:26;pointer-events:none;transition:opacity .4s,transform .4s;white-space:nowrap;text-align:center;color:#9b59ff;}
.relic-hud{display:inline-flex;align-items:center;gap:3px;font-size:8px;background:rgba(155,89,255,0.12);border:1px solid rgba(155,89,255,0.3);border-radius:2px;padding:2px 5px;color:#9b59ff;font-family:'Orbitron',sans-serif;}
#relicRow{position:fixed;top:52px;left:50%;transform:translateX(-50%);display:flex;gap:4px;z-index:12;pointer-events:none;flex-wrap:wrap;justify-content:center;max-width:320px;}
/* Relic panel cards */
.rcards,#relicPanelCards{display:flex;flex-direction:column;gap:0;width:min(92vw,460px);margin-bottom:16px;}
.rcard{width:100%;padding:14px 18px;display:flex;align-items:center;gap:14px;border:none;border-bottom:1px solid rgba(155,89,255,0.12);background:rgba(8,4,22,0.97);box-sizing:border-box;}
.rcard .rcIcon{font-size:26px;flex-shrink:0;width:34px;text-align:center;}
.rcard .rcMid{flex:1;min-width:0;}
.rcard .rcName{font-family:'Orbitron',sans-serif;font-size:11px;color:#9b59ff;letter-spacing:1px;margin-bottom:3px;}
.rcard .rcDesc{font-size:10px;color:#446;line-height:1.4;}
.rcard .rcStack{font-family:'Orbitron',sans-serif;font-size:11px;color:#cc88ff;flex-shrink:0;}
/* Galaxy-lock card */

/* Sector progress meter */
#sectorMeter{position:fixed;bottom:175px;left:50%;transform:translateX(-50%);width:min(320px,80vw);display:none;z-index:12;pointer-events:none;}
#sectorMeterLbl{font-family:'Orbitron',sans-serif;font-size:8px;color:#00f5ff;letter-spacing:2px;text-align:center;margin-bottom:3px;display:flex;justify-content:space-between;}
#sectorMeterTrack{height:8px;background:rgba(255,255,255,0.05);border:1px solid rgba(0,245,255,0.2);border-radius:2px;overflow:hidden;}
#sectorMeterFill{height:100%;background:linear-gradient(90deg,#00f5ff,#9b59ff);width:0%;transition:width .3s;}
/* Beam overheat bar */
#beamHeatBar{position:fixed;bottom:188px;right:14px;width:8px;height:120px;display:none;z-index:12;pointer-events:none;flex-direction:column-reverse;align-items:center;gap:2px;}
#beamHeatTrack{width:8px;flex:1;background:rgba(255,255,255,0.05);border:1px solid rgba(0,245,255,0.2);border-radius:2px;overflow:hidden;position:relative;}
#beamHeatFill{position:absolute;bottom:0;left:0;right:0;background:linear-gradient(0deg,#00f5ff,#ff3366);transition:height .05s;}
#beamHeatLbl{font-family:'Orbitron',sans-serif;font-size:7px;color:#00f5ff;letter-spacing:1px;writing-mode:vertical-rl;text-orientation:mixed;}
/* Galaxy select panel */
#galaxySelect{position:fixed;inset:0;display:none;flex-direction:column;align-items:center;background:rgba(2,2,10,0.98);z-index:60;pointer-events:all;padding:18px 12px;overflow-y:auto;}
#galaxySelect h2{font-family:'Orbitron',sans-serif;color:#00f5ff;font-size:clamp(13px,4vw,20px);letter-spacing:4px;text-shadow:0 0 20px #00f5ff;margin-bottom:4px;}
#galaxyGrid{display:flex;flex-direction:column;gap:0;width:min(92vw,460px);margin-bottom:16px;}
.gsel{width:100%;padding:14px 18px;border:none;border-bottom:1px solid rgba(255,255,255,0.06);cursor:pointer;display:flex;align-items:center;gap:12px;background:rgba(4,4,18,0.97);box-sizing:border-box;}
.gsel:active{background:rgba(255,255,255,0.04);}
.gsel.locked{opacity:0.25;pointer-events:none;filter:grayscale(1);}
.gsel .gselNum{font-family:'Orbitron',sans-serif;font-size:11px;letter-spacing:2px;flex-shrink:0;width:80px;}
.gsel .gselName{font-family:'Orbitron',sans-serif;font-size:13px;letter-spacing:1px;flex:1;}
.gsel .gselDiff{font-size:10px;color:#446;flex-shrink:0;}

/* ‚îÄ‚îÄ Tutorial bubbles ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
.tut-bubble{position:fixed;z-index:80;pointer-events:none;max-width:220px;font-family:'Orbitron',sans-serif;font-size:10px;line-height:1.5;letter-spacing:0.5px;color:#fff;background:rgba(2,6,28,0.97);border:1px solid rgba(0,245,255,0.5);border-radius:6px;padding:10px 13px;box-shadow:0 0 18px rgba(0,245,255,0.2);transition:opacity 0.4s;opacity:0;}
.tut-bubble.show{opacity:1;}
.tut-bubble .tut-title{color:#00f5ff;font-size:9px;letter-spacing:2px;margin-bottom:4px;}
.tut-bubble .tut-arrow{display:block;font-size:16px;margin-bottom:4px;}
.tut-bubble button.tut-ok{margin-top:8px;display:block;width:100%;font-family:'Orbitron',monospace;font-size:9px;letter-spacing:2px;padding:5px 0;background:transparent;border:1px solid rgba(0,245,255,0.4);color:#00f5ff;cursor:pointer;border-radius:2px;pointer-events:all;}
</style>
</head>
<body>


<canvas id="gc"></canvas>
<div id="hud"><div id="topRow">
  <div class="bg"><div class="bl">HULL</div><div class="bt"><div class="bf" id="hpF" style="width:100%"></div></div><div class="bl" id="shieldLbl" style="margin-top:3px;display:none">SHIELD</div><div class="bt" id="shieldBar" style="display:none"><div class="bf" id="shieldF" style="width:100%;background:linear-gradient(90deg,#33aaff,#00f5ff)"></div></div></div>
  <div id="cs"><div id="td">00:00</div><div id="wd">SECTOR 1</div><div id="chd"></div></div>
  <div class="bg"><div class="bl" style="text-align:right">RANK <span id="lvl">1</span></div><div class="bt"><div class="bf" id="xpF" style="width:0%"></div></div></div>
</div></div>
<div id="bb"><div id="bbl">‚ö† OVERLORD ‚ö†</div><div id="btr"><div id="bf2" style="width:100%"></div></div></div>
<div id="sectorMeter">
  <div id="sectorMeterLbl"><span id="sectorMeterTxt">KILLS TO BOSS</span><span id="sectorMeterCount">0/50</span></div>
  <div id="sectorMeterTrack"><div id="sectorMeterFill"></div></div>
</div>
<div id="beamHeatBar"><div id="beamHeatLbl">HEAT</div><div id="beamHeatTrack"><div id="beamHeatFill" style="height:0%"></div></div></div>
<div id="galaxySelect">
  <h2>üåå GALAXY SELECT</h2>
  <div style="font-size:9px;color:#334;letter-spacing:2px;margin-bottom:14px;">CHOOSE YOUR ENTRY POINT</div>
  <div id="galaxyGrid"></div>
  <button class="btn" id="galaxySelectClose">‚Üê BACK</button>
</div>
<div id="brow"></div><div id="prow"></div><div id="ab"></div>
<div id="jz"><div id="jb"><div id="jk"></div></div></div>
<div id="galaxyBadge">ANDROMEDA ¬∑ GALAXY 1</div>
<div id="warpOverlay">
  <canvas id="warpCanvas" style="position:absolute;inset:0;width:100%;height:100%;"></canvas>
  <div id="warpTitle">WARP JUMP</div>
  <div id="warpSub">ENTERING NEW GALAXY</div>
</div>
<div id="wa"></div><div id="kf"></div><div id="pf"></div>
<div id="relicNotif"></div>
<div id="relicRow"></div>
<div id="badgeNotif" style="position:fixed;top:56px;left:50%;transform:translateX(-50%) translateY(-20px);background:rgba(2,2,16,0.96);border:1px solid #888;border-radius:4px;padding:8px 16px;font-family:'Orbitron',sans-serif;font-size:11px;letter-spacing:2px;opacity:0;z-index:25;pointer-events:none;transition:opacity .4s,transform .4s;white-space:nowrap;display:flex;align-items:center;gap:8px;"></div>
<div id="pauseBtn">‚è∏</div>
<div id="beamSelector" style="display:none;position:fixed;bottom:108px;left:50%;transform:translateX(-50%);z-index:15;display:none;flex-direction:row;gap:6px;align-items:center;pointer-events:all;"></div>
<div id="singBtn" style="display:none;position:fixed;bottom:60px;left:50%;transform:translateX(-50%);font-family:'Orbitron',monospace;font-size:10px;letter-spacing:2px;padding:8px 18px;background:rgba(0,10,30,0.9);border:1px solid #00f5ff;color:#00f5ff;cursor:pointer;border-radius:3px;z-index:15;pointer-events:all;align-items:center;justify-content:center;">‚ö° SING</div>
<div id="miningRing"></div>
<div id="miningBar" style="display:none;"><div id="miningLbl">‚õè MINING</div><div id="miningTrack"><div id="miningFill"></div></div></div>
<div id="pauseMenu">
  <h2>PAUSED</h2>
  <button class="btn" id="resumeBtn">‚ñ∂ RESUME</button>
  <button class="btng btn" id="pauseUpgBtn">‚¨° UPGRADES</button>
  <button class="btno btn" id="pauseHangarBtn">‚óà HANGAR</button>
  <button class="btn" id="pauseBeamBtn" style="border-color:#00f5ff;color:#00f5ff;">‚ö° BEAMS</button>
  <button class="btn" id="pauseGalaxyBtn" style="border-color:#9b59ff;color:#9b59ff;">üåå GALAXY WARP</button>
  <button class="btn" id="pauseDevBtn" style="border-color:#334;color:#334;font-size:11px;margin-top:4px;">‚óà DEV</button>
</div>

<div class="ov" id="menu">
  <h1>VOID RUNNERS</h1>
  <div class="tl" style="margin-bottom:18px;">DEEP SPACE SURVIVAL</div>
  <button class="btn" id="sBtn">‚ñ∂ LAUNCH</button>
  <button class="btn" id="mGBtn" style="border-color:#9b59ff;color:#9b59ff;">üåå GALAXY SELECT</button>
  <button class="btng btn" id="mPBtn">‚¨° UPGRADES</button>
  <button class="btno btn" id="mHBtn">‚óà HANGAR</button>
  <button class="btn" id="mBBtn" style="border-color:#00f5ff;color:#00f5ff;">‚ö° BEAMS</button>
  <button class="btn" id="mGRBtn" style="border-color:#ffd700;color:#ffd700;">üíé GEM RUSH</button>
  <div id="mcd" style="font-family:'Orbitron',sans-serif;font-size:13px;color:var(--g);margin-top:14px;letter-spacing:2px;"></div>
  <div style="font-size:10px;color:#334;letter-spacing:2px;margin-top:8px;">JOYSTICK ¬∑ AUTO-FIRE ¬∑ Q/E/R/F</div>
  <button class="btn" id="mVoidBtn" style="border-color:#aa00ff;color:#aa00ff;margin-top:8px;">‚ú¶ VOID ASCENSION</button>
  <button class="btn" id="menuDevBtn" style="border-color:#334;color:#334;font-size:11px;margin-top:4px;">‚óà DEV</button>
</div>
<div id="bshop" style="position:fixed;inset:0;display:none;flex-direction:column;align-items:center;justify-content:center;background:rgba(2,2,10,0.97);z-index:60;pointer-events:all;padding:18px 12px;overflow-y:auto;">

<!-- RELIC PANEL -->
<div id="relicPanel" style="position:fixed;inset:0;display:none;flex-direction:column;align-items:center;background:rgba(2,2,10,0.98);z-index:60;pointer-events:all;overflow-y:auto;padding:18px 0 32px;">
  <h2 style="font-family:'Orbitron',sans-serif;color:#9b59ff;font-size:18px;letter-spacing:4px;text-shadow:0 0 20px #9b59ff;margin:0 0 4px 0;">üíú RELICS</h2>
  <div id="relicPanelCap" style="font-family:'Orbitron',sans-serif;font-size:9px;color:#446;letter-spacing:2px;margin-bottom:14px;"></div>
  <div id="relicPanelCards" style="width:min(92vw,460px);display:flex;flex-direction:column;margin-bottom:16px;"></div>
  <button class="btn" id="relicPanelClose">‚Üê BACK</button>
</div>
  <h2 style="font-family:Orbitron,sans-serif;color:#00f5ff;font-size:clamp(14px,4vw,22px);letter-spacing:4px;text-shadow:0 0 20px #00f5ff;margin-bottom:4px;">‚ö° BEAM ARSENAL</h2>
  <div style="color:#223;font-size:9px;letter-spacing:3px;margin-bottom:6px;">BUY ONE ¬∑ COMMIT FOREVER ¬∑ UPGRADE INFINITELY</div>
  <div id="bshopCoins" style="font-family:Orbitron,sans-serif;font-size:13px;color:#ffd700;letter-spacing:2px;margin-bottom:14px;"></div>
  <div id="bshopCards"></div>
  <button class="btn" id="bshopClose">‚Üê BACK</button>
</div>
<div id="lup"><h2>RANK UP</h2><div class="sub">SELECT UPGRADE</div><div id="uc"></div></div>
<div id="pp">
  <h2>‚¨° DEEP UPGRADES</h2><div class="sub2">PERSIST ACROSS ALL RUNS</div>
  <div id="pcoins"></div><div class="ptabs" id="ptabs"></div>
  <div id="pcards"></div>
  <div id="badgeCount" style="display:none"></div>
  <div id="badgeGrid" style="display:none"></div>
  <button class="btn" id="pclose">‚Üê BACK</button>
</div>
<div id="sp">
  <h2>‚óà HANGAR BAY</h2>
  <div id="scoins" style="font-family:'Orbitron',sans-serif;font-size:13px;color:var(--g);margin-bottom:16px;letter-spacing:2px;"></div>

  <div id="sg"></div>
  <button class="btn" id="sclose" style="width:min(92vw,460px);margin-top:8px;">‚Üê BACK</button>
</div>

<div id="gemRush" style="display:none;position:fixed;inset:0;z-index:75;flex-direction:column;align-items:center;justify-content:flex-start;background:rgba(0,0,0,0.92);pointer-events:all;">
  <div style="font-family:Orbitron,sans-serif;font-size:clamp(14px,4vw,22px);color:#ffd700;letter-spacing:4px;text-shadow:0 0 20px #ffd700;margin-top:16px;">üíé GEM RUSH</div>
  <div style="font-family:Orbitron,sans-serif;font-size:10px;color:#446;letter-spacing:3px;margin-bottom:6px;">TAP GEMS BEFORE THE WARP</div>
  <div style="display:flex;gap:18px;margin-bottom:8px;align-items:center;">
    <div id="grTimer" style="font-family:Orbitron,sans-serif;font-size:clamp(20px,6vw,32px);color:#00f5ff;text-shadow:0 0 16px #00f5ff;letter-spacing:3px;min-width:54px;text-align:center;">60</div>
    <div id="grScore" style="font-family:Orbitron,sans-serif;font-size:clamp(13px,3.5vw,18px);color:#ffd700;letter-spacing:2px;">üíé 0</div>
  </div>
  <canvas id="grCanvas" style="display:block;touch-action:none;cursor:crosshair;border-radius:6px;border:1px solid rgba(0,245,255,0.1);"></canvas>
  <button class="btn" id="grSkip" style="margin-top:10px;border-color:#334;color:#446;font-size:11px;padding:6px 18px;">SKIP ‚Üí</button>
</div>
<div id="devPanel" style="position:fixed;inset:0;display:none;flex-direction:column;align-items:center;justify-content:center;background:rgba(0,0,0,0.97);z-index:80;pointer-events:all;padding:24px 0;">
  <div style="font-family:'Orbitron',sans-serif;font-size:18px;color:#ffd700;letter-spacing:4px;text-shadow:0 0 20px #ffd700;margin-bottom:6px;">‚óà DEV MODE</div>
  <div style="font-family:'Orbitron',sans-serif;font-size:9px;color:#446;letter-spacing:3px;margin-bottom:24px;">FABLE STUDIOS ¬∑ INTERNAL USE ONLY</div>
  <div id="devContent" style="width:min(92vw,460px);display:flex;flex-direction:column;gap:0;margin-bottom:20px;overflow-y:auto;max-height:70vh;"></div>
  <button class="btn" id="devClose" style="width:min(92vw,460px);border-color:#334;color:#446;">‚Üê BACK</button>
</div>

<div id="devPasswordPrompt" style="position:fixed;inset:0;display:none;flex-direction:column;align-items:center;justify-content:center;background:rgba(0,0,0,0.97);z-index:81;pointer-events:all;">
  <div style="font-family:'Orbitron',sans-serif;font-size:16px;color:#ffd700;letter-spacing:4px;margin-bottom:8px;">‚óà DEV ACCESS</div>
  <div style="font-family:'Orbitron',sans-serif;font-size:9px;color:#334;letter-spacing:3px;margin-bottom:24px;">ENTER PASSWORD</div>
  <input id="devPasswordInput" type="text" inputmode="text" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" style="font-family:'Orbitron',monospace;font-size:16px;letter-spacing:4px;background:rgba(255,215,0,0.08);border:2px solid rgba(255,215,0,0.5);color:#ffd700;padding:16px 20px;width:min(80vw,320px);text-align:center;border-radius:4px;margin-bottom:12px;-webkit-user-select:text;user-select:text;touch-action:manipulation;" placeholder="TAP TO TYPE"/>
  <div id="devPasswordErr" style="font-family:'Orbitron',sans-serif;font-size:9px;color:#ff3366;letter-spacing:2px;height:16px;margin-bottom:12px;"></div>
  <button class="btn" id="devPasswordSubmit" style="width:min(80vw,320px);">ENTER</button>
  <button class="btn" id="devPasswordCancel" style="width:min(80vw,320px);border-color:#334;color:#334;margin-top:4px;">CANCEL</button>
</div>

<script>
const WORLD=3200;
let W=innerWidth,H=innerHeight;
const gc=document.getElementById('gc');
const ctx=gc.getContext('2d');
gc.width=W;gc.height=H;
window.addEventListener('resize',()=>{W=innerWidth;H=innerHeight;gc.width=W;gc.height=H;buildBgForGalaxy(currentGalaxy);});

function lsG(k,d){try{const v=localStorage.getItem(k);return v===null?d:JSON.parse(v);}catch{return d;}}
function lsS(k,v){try{localStorage.setItem(k,JSON.stringify(v));}catch{}}
function resetAllData(){
  var keys=['vr_crystals','vr_perm','vr_skins','vr_skin','vr_beamRanks','vr_activeBeam','vr_stats','vr_badges','vr_visitedGalaxies','vr_plevel','vr_pxp','vr_pxpnext','vr_seenRelics','vr_essence','vr_shards','vr_vtree','vr_prestige','vr_tut','vr_bossesDefeated'];
  for(var i=0;i<keys.length;i++){try{localStorage.removeItem(keys[i]);}catch{}}
  location.reload();
}

let crystals=lsG('vr_crystals',0);
var voidEssence   = lsG('vr_essence', 0);   // earned from bosses, persists through prestige
var voidShards    = lsG('vr_shards', 0);     // earned by prestiging, stack forever
var voidTreeData  = lsG('vr_vtree', {});     // which void tree upgrades bought and how many
var prestigeCount = lsG('vr_prestige', 0);  // how many times prestiged
var bossesDefeated = lsG('vr_bossesDefeated', {});  // {galaxyIdx: true} ‚Äî which bosses beaten ever
let permData=lsG('vr_perm',{});
let persistLevel=lsG('vr_plevel',1);   // carries over between runs
let persistXP=lsG('vr_pxp',0);
let persistXPNext=lsG('vr_pxpnext',25);
let ownedSkins=lsG('vr_skins',['viper']);
let activeSkin=lsG('vr_skin','viper');

// ‚îÄ‚îÄ‚îÄ LIFETIME STATS ‚îÄ‚îÄ‚îÄ
var LS = lsG('vr_stats', {
  kills:0, bossKills:0, asteroidsDestroyed:0, gemsCollected:0,
  xpOrbsCollected:0, upgradesCollected:0, galaxiesVisited:0,
  pickupsCollected:0, totalDeaths:0, totalRuns:0,
  highestWave:0, highestKillStreak:0, highestLevel:0,
  totalPlayTime:0, dashesUsed:0, abilitiesUsed:0,
});
function saveLS(){ lsS('vr_stats', LS); }
function incLS(key, amt){
  LS[key] = (LS[key]||0) + (amt||1);
  saveLS();
  checkBadgeUnlocks();
}

// ‚îÄ‚îÄ‚îÄ BADGE DEFINITIONS ‚îÄ‚îÄ‚îÄ
// Each badge has tiers: [bronze, silver, gold, platinum] thresholds
var BADGES = [
  // KILLS
  { id:'kills_1',   icon:'üíÄ', name:'VOID HUNTER',    stat:'kills',
    tiers:[50,250,1000,5000], labels:['50','250','1K','5K'],
    desc:'Total enemies destroyed' },
  { id:'boss_1',    icon:'üëæ', name:'OVERLORD SLAYER', stat:'bossKills',
    tiers:[1,5,20,50], labels:['1','5','20','50'],
    desc:'Bosses defeated' },
  { id:'streak_1',  icon:'üî•', name:'ON FIRE',         stat:'highestKillStreak',
    tiers:[5,10,20,40], labels:['5','10','20','40'],
    desc:'Highest kill streak' },
  // GEMS
  { id:'gems_1',    icon:'üíé', name:'CRYSTAL MINER',   stat:'gemsCollected',
    tiers:[50,300,1500,8000], labels:['50','300','1.5K','8K'],
    desc:'Total gems collected' },
  { id:'ast_1',     icon:'‚òÑÔ∏è', name:'ROCK BREAKER',    stat:'asteroidsDestroyed',
    tiers:[10,50,200,750], labels:['10','50','200','750'],
    desc:'Asteroids destroyed' },
  // XP / RANK
  { id:'xp_1',      icon:'‚≠ê', name:'ASCENDANT',       stat:'xpOrbsCollected',
    tiers:[100,500,2000,10000], labels:['100','500','2K','10K'],
    desc:'XP orbs collected' },
  { id:'lvl_1',     icon:'üèÜ', name:'LEGEND',          stat:'highestLevel',
    tiers:[5,15,30,50], labels:['5','15','30','50'],
    desc:'Highest rank reached in one run' },
  // UPGRADES
  { id:'upg_1',     icon:'‚öôÔ∏è', name:'ENGINEER',        stat:'upgradesCollected',
    tiers:[5,20,60,150], labels:['5','20','60','150'],
    desc:'Run upgrades collected' },
  { id:'permupg_1', icon:'üî¨', name:'SCIENTIST',       stat:'permUpgradesBought',
    tiers:[3,10,30,75], labels:['3','10','30','75'],
    desc:'Permanent upgrades purchased' },
  // GALAXIES
  { id:'gal_1',     icon:'üåå', name:'EXPLORER',        stat:'galaxiesVisited',
    tiers:[2,5,15,40], labels:['2','5','15','40'],
    desc:'Galaxies warped to' },
  // ABILITIES
  { id:'ab_1',      icon:'‚ö°', name:'VOID MAGE',       stat:'abilitiesUsed',
    tiers:[10,50,200,750], labels:['10','50','200','750'],
    desc:'Abilities activated' },
  { id:'dash_1',    icon:'üí®', name:'GHOST',           stat:'dashesUsed',
    tiers:[10,50,200,600], labels:['10','50','200','600'],
    desc:'Warp dashes performed' },
  // PICKUPS
  { id:'pk_1',      icon:'üì¶', name:'SCAVENGER',       stat:'pickupsCollected',
    tiers:[10,50,200,600], labels:['10','50','200','600'],
    desc:'World pickups grabbed' },
  // RUNS / TIME
  { id:'runs_1',    icon:'üöÄ', name:'VETERAN',         stat:'totalRuns',
    tiers:[3,10,30,100], labels:['3','10','30','100'],
    desc:'Total runs completed' },
  { id:'wave_1',    icon:'üì°', name:'SECTOR MASTER',   stat:'highestWave',
    tiers:[5,15,30,50], labels:['5','15','30','50'],
    desc:'Highest sector reached' },
  { id:'time_1',    icon:'‚è±Ô∏è', name:'MARATHONER',      stat:'totalPlayTime',
    tiers:[300,1800,7200,36000], labels:['5m','30m','2h','10h'],
    desc:'Total time played' },
];

var earnedBadges = lsG('vr_badges', {}); // {badgeId: tierIndex (0-3)}

function getBadgeTier(badge){
  var val = LS[badge.stat] || 0;
  var tier = -1;
  for(var i=badge.tiers.length-1; i>=0; i--){
    if(val >= badge.tiers[i]){ tier=i; break; }
  }
  return tier; // -1=locked, 0=bronze, 1=silver, 2=gold, 3=plat
}

var _badgeNotifQueue = [];
function checkBadgeUnlocks(){
  for(var i=0;i<BADGES.length;i++){
    var b=BADGES[i];
    var tier=getBadgeTier(b);
    var prev=earnedBadges[b.id]!=null ? earnedBadges[b.id] : -1;
    if(tier > prev){
      earnedBadges[b.id]=tier;
      lsS('vr_badges', earnedBadges);
      var tierNames=['BRONZE','SILVER','GOLD','PLATINUM'];
      var tierColors=['#cd7f32','#c0c0c0','#ffd700','#e5e4e2'];
      _badgeNotifQueue.push({badge:b, tier:tier, name:tierNames[tier], color:tierColors[tier]});
    }
  }
  if(_badgeNotifQueue.length>0) showNextBadgeNotif();
}

var _badgeNotifActive=false;
function showNextBadgeNotif(){
  if(_badgeNotifActive||_badgeNotifQueue.length===0)return;
  _badgeNotifActive=true;
  var n=_badgeNotifQueue.shift();
  var el=document.getElementById('badgeNotif');
  if(!el)return;
  el.innerHTML='<span style="font-size:20px">'+n.badge.icon+'</span> <span style="color:'+n.color+'">'+n.name+'</span> <span style="font-size:9px;color:#aaa;">'+n.badge.name+'</span>';
  el.style.color=n.color;
  el.style.borderColor=n.color+'88';
  el.style.boxShadow='0 0 18px '+n.color+'44';
  el.style.opacity='1';el.style.transform='translateY(0)';
  SFX.upgrade();
  clearTimeout(el._t);
  el._t=setTimeout(function(){
    el.style.opacity='0';el.style.transform='translateY(-20px)';
    setTimeout(function(){_badgeNotifActive=false;showNextBadgeNotif();},500);
  },2800);
}

function countBadges(){
  var total=0;
  for(var id in earnedBadges){ if(earnedBadges[id]>=0) total++; }
  return total;
}

function renderBadgePanel(){
  document.getElementById('badgeCount').textContent = countBadges()+' / '+(BADGES.length*4)+' BADGES EARNED';
  var grid=document.getElementById('badgeGrid');
  grid.innerHTML='';
  var tierClass=['bronze','silver','gold','plat'];
  var tierEmoji=['ü•â','ü•à','ü•á','üí†'];
  for(var i=0;i<BADGES.length;i++){
    var b=BADGES[i];
    var tier=getBadgeTier(b);
    var val=LS[b.stat]||0;
    var c=document.createElement('div');
    c.className='bdg '+(tier>=0?tierClass[tier]+' unlocked':'locked');
    // Progress to next tier
    var nextTier=tier+1;
    var progStr='';
    if(nextTier<b.tiers.length){
      progStr=val+' / '+b.tiers[nextTier];
    } else if(tier>=0){
      progStr='MAXED ‚úì';
    } else {
      progStr='0 / '+b.tiers[0];
    }
    c.innerHTML='<div class="bdgIcon">'+b.icon+'</div>'
      +'<div class="bdgName">'+b.name+'</div>'
      +'<div class="bdgDesc">'+b.desc+'</div>'
      +'<div class="bdgProg">'+progStr+'</div>'
      +(tier>=0?'<div class="bdgTier">'+tierEmoji[tier]+'</div>':'');
    grid.appendChild(c);
  }
}

// ‚îÄ‚îÄ‚îÄ GALAXIES ‚îÄ‚îÄ‚îÄ
const GALAXIES=[
  {name:'DRIFT SECTOR',     sky:'#01020d',nebHue:210,starTint:[0,200,255],   acc:'#00f5ff',diff:1.0,  twist:null},
  {name:'LEVIATHAN FIELD',  sky:'#04020e',nebHue:280,starTint:[130,60,255],  acc:'#8844ff',diff:1.18, twist:'leviathan'},
  {name:'MACHINE REMNANT',  sky:'#020208',nebHue:220,starTint:[80,120,255],  acc:'#4499ff',diff:1.38, twist:'formation'},
  {name:'METEOR STORM BELT',sky:'#0e0600',nebHue:20, starTint:[255,120,20],  acc:'#ff7700',diff:1.6,  twist:'meteors'},
  {name:'BIO-NEBULA',       sky:'#030e02',nebHue:120,starTint:[80,255,100],  acc:'#44ff88',diff:1.85, twist:'poison'},
  {name:'CRYO RING',        sky:'#01080e',nebHue:195,starTint:[100,200,255], acc:'#88ddff',diff:2.15, twist:'freeze'},
  {name:'PULSAR CORRIDOR',  sky:'#060002',nebHue:355,starTint:[255,80,60],   acc:'#ff4422',diff:2.5,  twist:'emp'},
  {name:'GRAVITON ABYSS',   sky:'#000000',nebHue:260,starTint:[100,80,255],  acc:'#6655ff',diff:2.9,  twist:'gravity'},
  {name:'MIRROR EXPANSE',   sky:'#020208',nebHue:180,starTint:[180,255,220], acc:'#aaffdd',diff:3.35, twist:'mirror'},
  {name:'THE VOID HEART',   sky:'#000000',nebHue:0,  starTint:[255,255,255], acc:'#ffffff',diff:4.0,  twist:'voidheart'},
];
let currentGalaxy=0,warpAnimating=false;


// ‚îÄ‚îÄ‚îÄ SKINS ‚îÄ‚îÄ‚îÄ
const SKINS=[
  {id:'viper',  name:'VIPER',   cost:0,   col:'#00f5ff',acc:'#88eeff',desc:'Standard interceptor',
   passiveDesc:'No passive ‚Äî starter ship',
   passive:function(b){}},
  {id:'nova',   name:'NOVA',    cost:1000,  col:'#ff6a00',acc:'#ffcc44',desc:'Solar destroyer class',
   passiveDesc:'+15% weapon damage',
   passive:function(b){b.dmg*=1.15;}},
  {id:'phantom',name:'PHANTOM', cost:2000, col:'#9b59ff',acc:'#cc88ff',desc:'Stealth corvette',
   passiveDesc:'-20% ability cooldowns',
   passive:function(b){b.abcd*=0.80;}},
  {id:'reaper', name:'REAPER',  cost:3500, col:'#ff3366',acc:'#ff8899',desc:'Assault dreadnought',
   passiveDesc:'+20% fire rate  +1 pierce',
   passive:function(b){b.cd*=0.80;b.pierce+=1;}},
  {id:'aurora', name:'AURORA',  cost:5500, col:'#39ff8a',acc:'#aaffcc',desc:'Bio-organic cruiser',
   passiveDesc:'+2 hull regen/sec  +80 max hull',
   passive:function(b){b.regen+=2;b.hull+=80;}},
  {id:'void',   name:'VOID',    cost:10000, col:'#aa00ff',acc:'#9b59ff',desc:'Dark matter vessel',
   passiveDesc:'+25% dmg  +25% fire rate  +1 pierce  +20% speed',
   passive:function(b){b.dmg*=1.25;b.cd*=0.75;b.pierce+=1;b.spd*=1.20;}},
];

// ‚îÄ‚îÄ SHIP ENGINE TRAIL helper ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function _thruster(c2,col1,col2,x,y,w,t,flicker){
  var fl=(8+Math.random()*10)*flicker;
  c2.save();
  // Outer flame
  c2.shadowColor=col1;c2.shadowBlur=24;c2.globalAlpha=0.88;
  var tg=c2.createLinearGradient(x,y,x,y+fl);
  tg.addColorStop(0,col1);tg.addColorStop(0.5,col2);tg.addColorStop(1,'transparent');
  c2.fillStyle=tg;
  c2.beginPath();c2.moveTo(x-w,y);c2.lineTo(x+w,y);c2.lineTo(x+w*.3,y+fl);c2.lineTo(x-w*.3,y+fl);c2.closePath();c2.fill();
  // Inner bright core
  c2.globalAlpha=0.7;c2.shadowBlur=12;
  c2.fillStyle=col2;
  c2.beginPath();c2.moveTo(x-w*.4,y);c2.lineTo(x+w*.4,y);c2.lineTo(x,y+fl*.55);c2.closePath();c2.fill();
  c2.globalAlpha=1;c2.restore();
}

// ‚îÄ‚îÄ HULL ENERGY LINE helper ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function _hullLine(c2,col,x1,y1,x2,y2,t,phase){
  var alpha=0.3+0.4*Math.abs(Math.sin(t*3+phase));
  c2.save();c2.globalAlpha=alpha;c2.strokeStyle=col;c2.lineWidth=1;
  c2.shadowColor=col;c2.shadowBlur=8;
  c2.beginPath();c2.moveTo(x1,y1);c2.lineTo(x2,y2);c2.stroke();
  c2.restore();
}

// ‚îÄ‚îÄ ENERGY CORE helper ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function _core(c2,col,acc,cx,cy,r,t,phase){
  var pulse=0.7+0.3*Math.sin(t*4+phase);
  var grad=c2.createRadialGradient(cx,cy,0,cx,cy,r*pulse);
  grad.addColorStop(0,'#ffffff');
  grad.addColorStop(0.25,acc);
  grad.addColorStop(0.6,col);
  grad.addColorStop(1,'transparent');
  c2.save();c2.shadowColor=col;c2.shadowBlur=20;
  c2.fillStyle=grad;c2.beginPath();c2.arc(cx,cy,r*pulse,0,Math.PI*2);c2.fill();
  c2.restore();
}

function drawShip(c2,skinId,x,y,angle,scale,thrust){
  const sk=SKINS.find(s=>s.id===skinId)||SKINS[0];
  const t=typeof gtime!=='undefined'?gtime:0;
  c2.save();c2.translate(x,y);c2.rotate(angle+Math.PI/2);c2.scale(scale,scale);

  switch(skinId){

    // ‚îÄ‚îÄ VIPER ‚Äî Cyan interceptor, razor-delta wings, twin engines ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    case'viper': default:{
      var col=sk.col,acc=sk.acc;
      // Outer glow layer
      c2.shadowBlur=22;c2.shadowColor=col;
      // Wing panels
      c2.fillStyle='#071820';
      c2.beginPath();c2.moveTo(0,-20);c2.lineTo(-13,8);c2.lineTo(-5,5);c2.lineTo(0,10);c2.lineTo(5,5);c2.lineTo(13,8);c2.closePath();c2.fill();
      // Wing edge stripes
      c2.strokeStyle=col;c2.lineWidth=1.5;c2.stroke();
      // Inner body highlight
      var bg=c2.createLinearGradient(0,-20,0,10);
      bg.addColorStop(0,col+'55');bg.addColorStop(1,'transparent');
      c2.fillStyle=bg;
      c2.beginPath();c2.moveTo(0,-20);c2.lineTo(-5,2);c2.lineTo(0,8);c2.lineTo(5,2);c2.closePath();c2.fill();
      // Hull energy lines
      _hullLine(c2,col,-8,0,-3,-12,t,0);
      _hullLine(c2,col,8,0,3,-12,t,1.2);
      // Twin engine ports
      c2.fillStyle='#0a2030';
      c2.beginPath();c2.ellipse(-5,10,3,2.5,0,0,Math.PI*2);c2.fill();
      c2.beginPath();c2.ellipse(5,10,3,2.5,0,0,Math.PI*2);c2.fill();
      // Thruster glow rings
      var ep=0.5+0.5*Math.sin(t*6);
      c2.strokeStyle=col;c2.lineWidth=1;c2.globalAlpha=ep;
      c2.beginPath();c2.ellipse(-5,10,4,3,0,0,Math.PI*2);c2.stroke();
      c2.beginPath();c2.ellipse(5,10,4,3,0,0,Math.PI*2);c2.stroke();
      c2.globalAlpha=1;
      // Pulsing core
      _core(c2,col,acc,0,-6,4.5,t,0);
      // Thrust flames
      if(thrust){_thruster(c2,col,acc,-5,10,3.5,t,1);_thruster(c2,col,acc,5,10,3.5,t,1);}
      break;
    }

    // ‚îÄ‚îÄ NOVA ‚Äî Orange solar destroyer, broad swept wings, solar core ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    case'nova':{
      var col=sk.col,acc=sk.acc;
      c2.shadowBlur=24;c2.shadowColor=col;
      // Broad delta hull
      c2.fillStyle='#1a0a00';
      c2.beginPath();c2.moveTo(0,-22);c2.lineTo(-7,0);c2.lineTo(-16,12);c2.lineTo(-5,7);c2.lineTo(0,13);c2.lineTo(5,7);c2.lineTo(16,12);c2.lineTo(7,0);c2.closePath();c2.fill();
      // Hot gradient overlay on hull
      var ng=c2.createLinearGradient(0,-22,0,13);
      ng.addColorStop(0,acc+'88');ng.addColorStop(0.5,col+'44');ng.addColorStop(1,'transparent');
      c2.fillStyle=ng;
      c2.beginPath();c2.moveTo(0,-22);c2.lineTo(-7,0);c2.lineTo(0,5);c2.lineTo(7,0);c2.closePath();c2.fill();
      // Wing accent lines
      c2.strokeStyle=col;c2.lineWidth=1.5;
      c2.beginPath();c2.moveTo(0,-22);c2.lineTo(-16,12);c2.stroke();
      c2.beginPath();c2.moveTo(0,-22);c2.lineTo(16,12);c2.stroke();
      // Hull cracks/energy lines
      _hullLine(c2,acc,-10,2,-4,-10,t,0);
      _hullLine(c2,acc,10,2,4,-10,t,0.8);
      _hullLine(c2,acc,-6,8,6,8,t,1.6);
      // Solar core ‚Äî big pulsing
      _core(c2,col,acc,0,-5,6,t,0);
      // Wing tip emitters
      var wp=0.4+0.6*Math.abs(Math.sin(t*5));
      c2.fillStyle=acc;c2.globalAlpha=wp;c2.shadowColor=acc;c2.shadowBlur=16;
      c2.beginPath();c2.arc(-16,12,3,0,Math.PI*2);c2.fill();
      c2.beginPath();c2.arc(16,12,3,0,Math.PI*2);c2.fill();
      c2.globalAlpha=1;
      // Single wide engine
      if(thrust){_thruster(c2,col,acc,0,13,5.5,t,1);}
      break;
    }

    // ‚îÄ‚îÄ PHANTOM ‚Äî Purple stealth corvette, swept cloak wings, shimmer ‚îÄ‚îÄ‚îÄ‚îÄ
    case'phantom':{
      var col=sk.col,acc=sk.acc;
      // Cloak shimmer ‚Äî alpha flicker
      var cloak=0.75+0.12*Math.sin(t*2.2);
      c2.globalAlpha=cloak;
      c2.shadowBlur=20;c2.shadowColor=col;
      // Wide stealth wings
      c2.fillStyle='#0d0818';
      c2.beginPath();c2.moveTo(0,-22);c2.lineTo(-20,14);c2.lineTo(-7,6);c2.lineTo(0,12);c2.lineTo(7,6);c2.lineTo(20,14);c2.closePath();c2.fill();
      c2.strokeStyle=col;c2.lineWidth=1.5;c2.stroke();
      // Stealth gradient ‚Äî dark center
      var pg=c2.createLinearGradient(0,-22,0,12);
      pg.addColorStop(0,col+'66');pg.addColorStop(0.6,'transparent');
      c2.fillStyle=pg;
      c2.beginPath();c2.moveTo(0,-22);c2.lineTo(-8,0);c2.lineTo(0,8);c2.lineTo(8,0);c2.closePath();c2.fill();
      // Phantom edge traces
      _hullLine(c2,acc,-14,8,-2,-14,t,0);
      _hullLine(c2,acc,14,8,2,-14,t,Math.PI);
      // Low-pulse ghost core
      _core(c2,col,acc,0,-4,4,t,Math.PI*.5);
      // Wing trailing edge crackles
      var cp=0.2+0.8*Math.abs(Math.sin(t*7+1));
      c2.globalAlpha*=cp;c2.strokeStyle=acc;c2.lineWidth=1;c2.shadowColor=acc;c2.shadowBlur=10;
      c2.beginPath();c2.moveTo(-20,14);c2.lineTo(-12,4);c2.stroke();
      c2.beginPath();c2.moveTo(20,14);c2.lineTo(12,4);c2.stroke();
      c2.globalAlpha=1;
      if(thrust){_thruster(c2,col,acc,0,12,3.5,t,1);}
      break;
    }

    // ‚îÄ‚îÄ REAPER ‚Äî Red assault dreadnought, heavy armored, rage core ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    case'reaper':{
      var col=sk.col,acc=sk.acc;
      c2.shadowBlur=26;c2.shadowColor=col;
      // Armored body ‚Äî chunky layered hull
      c2.fillStyle='#1a0308';
      c2.beginPath();c2.moveTo(0,-22);c2.lineTo(-5,-10);c2.lineTo(-16,12);c2.lineTo(-5,7);c2.lineTo(0,14);c2.lineTo(5,7);c2.lineTo(16,12);c2.lineTo(5,-10);c2.closePath();c2.fill();
      // Armor plating overlay
      c2.fillStyle='#2a0510';
      c2.beginPath();c2.moveTo(0,-22);c2.lineTo(-4,-4);c2.lineTo(0,-2);c2.lineTo(4,-4);c2.closePath();c2.fill();
      c2.beginPath();c2.moveTo(-5,-10);c2.lineTo(-14,10);c2.lineTo(-7,6);c2.lineTo(-4,-6);c2.closePath();c2.fill();
      c2.beginPath();c2.moveTo(5,-10);c2.lineTo(14,10);c2.lineTo(7,6);c2.lineTo(4,-6);c2.closePath();c2.fill();
      // Red hot edge lines
      c2.strokeStyle=col;c2.lineWidth=2;
      c2.beginPath();c2.moveTo(0,-22);c2.lineTo(-16,12);c2.stroke();
      c2.beginPath();c2.moveTo(0,-22);c2.lineTo(16,12);c2.stroke();
      // Rage hull cracks
      _hullLine(c2,col,-10,0,-4,-12,t,0);
      _hullLine(c2,col,10,0,4,-12,t,0.6);
      _hullLine(c2,col,-8,8,8,8,t,1.2);
      // Rage core ‚Äî fast pulse
      _core(c2,col,acc,0,-4,5.5,t*1.5,0);
      // Heavy wing tip cannons
      c2.fillStyle='#300010';c2.strokeStyle=col;c2.lineWidth=1;
      c2.beginPath();c2.rect(-19,9,6,4);c2.fill();c2.stroke();
      c2.beginPath();c2.rect(13,9,6,4);c2.fill();c2.stroke();
      // Triple engine
      if(thrust){
        _thruster(c2,col,acc,0,14,4,t,1);
        _thruster(c2,col,acc,-8,11,2.5,t,0.85);
        _thruster(c2,col,acc,8,11,2.5,t,0.9);
      }
      break;
    }

    // ‚îÄ‚îÄ AURORA ‚Äî Green bio-organic cruiser, flowing curves, bloom core ‚îÄ‚îÄ‚îÄ
    case'aurora':{
      var col=sk.col,acc=sk.acc;
      c2.shadowBlur=22;c2.shadowColor=col;
      // Bio hull ‚Äî organic bezier shape
      c2.fillStyle='#031208';
      c2.beginPath();
      c2.moveTo(0,-22);
      c2.bezierCurveTo(9,-10,14,2,10,16);
      c2.lineTo(5,11);c2.lineTo(0,16);c2.lineTo(-5,11);
      c2.bezierCurveTo(-14,2,-9,-10,0,-22);
      c2.closePath();c2.fill();
      // Bioluminescent gradient
      var ag=c2.createRadialGradient(0,-2,2,0,-2,18);
      ag.addColorStop(0,col+'55');ag.addColorStop(0.6,col+'22');ag.addColorStop(1,'transparent');
      c2.fillStyle=ag;c2.beginPath();
      c2.moveTo(0,-22);c2.bezierCurveTo(9,-10,14,2,10,16);c2.lineTo(0,16);
      c2.bezierCurveTo(-14,2,-9,-10,0,-22);c2.closePath();c2.fill();
      // Organic edge glow
      c2.strokeStyle=col;c2.lineWidth=1.5;c2.beginPath();
      c2.moveTo(0,-22);c2.bezierCurveTo(9,-10,14,2,10,16);c2.lineTo(0,16);
      c2.bezierCurveTo(-14,2,-9,-10,0,-22);c2.stroke();
      // Vein energy lines ‚Äî sinuous
      _hullLine(c2,acc,-6,-14,-3,4,t,0);
      _hullLine(c2,acc,6,-14,3,4,t,1.0);
      // Bloom core ‚Äî slow gentle pulse
      _core(c2,col,acc,0,-4,6,t*0.7,0);
      // Symbiont pods on wings
      var bp=0.5+0.5*Math.sin(t*3.5);
      c2.fillStyle=acc;c2.globalAlpha=bp*0.8;c2.shadowColor=acc;c2.shadowBlur=14;
      c2.beginPath();c2.arc(-10,6,3,0,Math.PI*2);c2.fill();
      c2.beginPath();c2.arc(10,6,3,0,Math.PI*2);c2.fill();
      c2.globalAlpha=1;
      // Bio engine ‚Äî wide organic
      if(thrust){_thruster(c2,col,'#ccff88',0,16,5,t,0.9);}
      break;
    }

    // ‚îÄ‚îÄ VOID ‚Äî Dark matter vessel, ring-blade form, reality-tear core ‚îÄ‚îÄ‚îÄ‚îÄ
    case'void':{
      var col=sk.col,acc=sk.acc;
      c2.shadowBlur=28;c2.shadowColor=col;
      // Outer ring blade
      c2.strokeStyle=col;c2.lineWidth=2.5;
      c2.beginPath();c2.arc(0,-2,18,0,Math.PI*2);c2.stroke();
      // Blade gap cuts
      c2.strokeStyle='#000';c2.lineWidth=4;
      c2.beginPath();c2.arc(0,-2,18,-0.35,0.35);c2.stroke();
      c2.beginPath();c2.arc(0,-2,18,Math.PI-0.35,Math.PI+0.35);c2.stroke();
      // Inner hull ‚Äî dark swept body
      c2.fillStyle='#0a0018';
      c2.beginPath();c2.moveTo(0,-20);c2.lineTo(-10,10);c2.lineTo(0,5);c2.lineTo(10,10);c2.closePath();c2.fill();
      c2.strokeStyle=col;c2.lineWidth=1.5;c2.stroke();
      // Forward blade spikes
      c2.fillStyle=col+'44';
      c2.beginPath();c2.moveTo(0,-20);c2.lineTo(-3,-26);c2.lineTo(3,-26);c2.closePath();c2.fill();
      c2.strokeStyle=col;c2.lineWidth=1;c2.stroke();
      // Reality tear lines ‚Äî fast crackle
      _hullLine(c2,col,-8,4,8,4,t*2,0);
      _hullLine(c2,col,-5,-10,5,-10,t*2,1.5);
      // Dark matter core ‚Äî slow hue-shift (purple/blue oscillate)
      var vt=t*0.8,vhue=270+40*Math.sin(vt);
      var vg=c2.createRadialGradient(0,-4,0,0,-4,7);
      vg.addColorStop(0,'#ffffff');
      vg.addColorStop(0.3,'hsla('+vhue+',100%,70%,1)');
      vg.addColorStop(0.7,col);vg.addColorStop(1,'transparent');
      c2.save();c2.shadowColor=col;c2.shadowBlur=26;
      c2.fillStyle=vg;c2.beginPath();c2.arc(0,-4,6+Math.sin(t*5)*1.5,0,Math.PI*2);c2.fill();
      c2.restore();
      // Orbiting ring particle
      var oa=t*2.2,or2=12;
      c2.save();c2.shadowColor=acc;c2.shadowBlur=14;c2.fillStyle=acc;
      c2.beginPath();c2.arc(Math.cos(oa)*or2,Math.sin(oa)*or2-2,2.5,0,Math.PI*2);c2.fill();
      c2.beginPath();c2.arc(Math.cos(oa+Math.PI)*or2,Math.sin(oa+Math.PI)*or2-2,2.5,0,Math.PI*2);c2.fill();
      c2.restore();
      if(thrust){_thruster(c2,col,acc,0,10,3,t,1);_thruster(c2,col,acc,-6,9,2,t,0.8);_thruster(c2,col,acc,6,9,2,t,0.9);}
      break;
    }
  }
  c2.restore();
}

// ‚îÄ‚îÄ‚îÄ BACKGROUND ‚îÄ‚îÄ‚îÄ
let bgC=null,bgAsteroids=[];

function buildBgForGalaxy(gIdx){
  const gal=GALAXIES[gIdx]||GALAXIES[0];
  bgC=document.createElement('canvas');bgC.width=WORLD;bgC.height=WORLD;
  const bc=bgC.getContext('2d');
  bc.fillStyle=gal.sky;bc.fillRect(0,0,WORLD,WORLD);
  for(let i=0;i<16;i++){
    const nx=Math.random()*WORLD,ny=Math.random()*WORLD,nr=200+Math.random()*480;
    const h=gal.nebHue+Math.floor((Math.random()-.5)*60);
    const ng=bc.createRadialGradient(nx,ny,0,nx,ny,nr);
    ng.addColorStop(0,`hsla(${h},80%,55%,0.07)`);ng.addColorStop(.5,`hsla(${h+30},60%,40%,0.025)`);ng.addColorStop(1,'transparent');
    bc.save();bc.scale(1+Math.random()*1.8,.3+Math.random()*.7);
    const sy2=.3+Math.random()*.7;bc.fillStyle=ng;bc.beginPath();bc.arc(nx/(1+Math.random()*1.8),ny/sy2,nr,0,Math.PI*2);bc.fill();bc.restore();
  }
  for(let i=0;i<6;i++){
    const gx=Math.random()*WORLD,gy=Math.random()*WORLD,gr=150+Math.random()*260;
    const h=gal.nebHue+Math.floor((Math.random()-.5)*40);
    const gg=bc.createRadialGradient(gx,gy,0,gx,gy,gr);
    gg.addColorStop(0,`hsla(${h},75%,65%,0.09)`);gg.addColorStop(.4,`hsla(${h},55%,45%,0.03)`);gg.addColorStop(1,'transparent');
    bc.save();bc.translate(gx,gy);bc.rotate(Math.random()*Math.PI);bc.fillStyle=gg;bc.beginPath();bc.ellipse(0,0,gr,gr*.32,0,0,Math.PI*2);bc.fill();bc.restore();
  }
  const [sr,sg2,sb]=gal.starTint;
  for(let i=0;i<3000;i++){
    const x=Math.random()*WORLD,y=Math.random()*WORLD,sz=Math.random()<.93?Math.random()*1.5:2+Math.random()*2.5;
    const br=.25+Math.random()*.75,mix=Math.random();
    const rv=Math.round(200*mix+sr*(1-mix)),gv=Math.round(200*mix+sg2*(1-mix)),bv=Math.round(200*mix+sb*(1-mix));
    bc.fillStyle=`rgba(${rv},${gv},${bv},${br})`;bc.beginPath();bc.arc(x,y,sz,0,Math.PI*2);bc.fill();
    if(sz>2.2){bc.strokeStyle=`rgba(${rv},${gv},${bv},${br*.22})`;bc.lineWidth=1;bc.beginPath();bc.moveTo(x-sz*3,y);bc.lineTo(x+sz*3,y);bc.stroke();bc.beginPath();bc.moveTo(x,y-sz*3);bc.lineTo(x,y+sz*3);bc.stroke();}
  }
  const pcols=[['#4477cc','#6699ff','#224499'],['#cc4422','#ff6644','#882211'],['#44cc88','#66ffaa','#228844'],['#ccaa22','#ffdd44','#886611'],['#aa44cc','#cc66ff','#662288'],['#2277aa','#44aaff','#114466']];
  for(let i=0;i<10;i++){
    const px=Math.random()*WORLD,py=Math.random()*WORLD,pr=30+Math.random()*100;
    const [c1,c2s,c3]=pcols[Math.floor(Math.random()*pcols.length)];
    const pg=bc.createRadialGradient(px-pr*.3,py-pr*.3,pr*.1,px,py,pr);
    pg.addColorStop(0,c2s);pg.addColorStop(.6,c1);pg.addColorStop(1,c3);
    bc.fillStyle=pg;bc.shadowBlur=30;bc.shadowColor=c1;bc.beginPath();bc.arc(px,py,pr,0,Math.PI*2);bc.fill();bc.shadowBlur=0;
    if(Math.random()<.5){bc.save();bc.translate(px,py);bc.rotate(Math.random()*.4-.2);bc.strokeStyle=c2s+'55';bc.lineWidth=6;bc.beginPath();bc.ellipse(0,0,pr*1.8,pr*.38,0,0,Math.PI*2);bc.stroke();bc.restore();}
  }
  bgAsteroids=[];
  for(let i=0;i<100;i++){
    const x=Math.random()*WORLD,y=Math.random()*WORLD,r=6+Math.random()*22;
    const pts=5+Math.floor(Math.random()*4),verts=[];
    for(let j=0;j<pts;j++){const a=(j/pts)*Math.PI*2,rd=r*(.65+Math.random()*.7);verts.push([Math.cos(a)*rd,Math.sin(a)*rd]);}
    bc.fillStyle='#3a3a4a';bc.strokeStyle='#606075';bc.lineWidth=1;
    bc.beginPath();bc.moveTo(x+verts[0][0],y+verts[0][1]);for(const v of verts)bc.lineTo(x+v[0],y+v[1]);bc.closePath();bc.fill();bc.stroke();
    bgAsteroids.push({x,y,r,verts,rotSpd:(Math.random()-.5)*.03});
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// GEM RUSH MINIGAME ‚Äî intercepts portal, 60s gem-collecting sprint
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// GEM RUSH ‚Äî 3rd-person endless runner. Swipe L/R, auto-shoot enemies, collect gems.
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
var grRAF=null, grDest=0, grTime=60, grCollected=0, grStandalone=false;
var grW=0, grH=0, grLast=0, grCtx=null, grCanvas=null;
var grT=0;

// ‚îÄ‚îÄ Ship ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
var grShip={ lane:1, x:0, y:0, targetX:0, tilt:0, engineT:0, shootT:0 };
var GR_LANES=3;
var grLaneX=[];

// ‚îÄ‚îÄ World objects ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
var grObjs=[];       // gems, obstacles, enemies
var grBullets=[];    // player bullets
var grParticles=[];
var grStars=[];
var grNebula=[];
var grZ=0, grSpawnZ=0, grSpeed=300, grDt=0;
var grCombo=0, grComboT=0;
var grMoveQueue=[];
var grLastObstacleZ=-9999; // track last obstacle spawn z

// ‚îÄ‚îÄ Stats ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
var grStats={ gems:0, enemies:0, comboPeak:0, hits:0 };
var grShowStats=false, grStatsTimer=0;

var GR_COLORS=['#00f5ff','#ffd700','#ff6a00','#39ff8a','#ff3366','#9b59ff','#88ddff','#ffffff'];

// ‚îÄ‚îÄ Enemy designs per galaxy (simplified for 3d-runner) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
var GR_ENEMY_SHAPES=['ufo','snake','hex','rock','blob','crystal','orb','void','mirror','architect'];
var GR_ENEMY_COLORS=['#00f5ff','#8844ff','#4499ff','#ff8833','#44ff88','#88ddff','#ff4422','#6655ff','#aaffdd','#ffffff'];

function grPerspective(lane, objZ){
  var vpy=grH*0.38, vpx=grW/2;
  var depth=Math.max(0, objZ/1800);
  var scale=Math.max(0.05,1-depth);
  var screenX=vpx+(grLaneX[lane]-vpx)*scale;
  var screenY=vpy+(grH-vpy-80)*Math.max(0,(1-Math.pow(depth,0.6)));
  return {x:screenX, y:screenY, scale:scale};
}

function grSpawnObj(z){
  var lane=Math.floor(Math.random()*GR_LANES);
  var roll=Math.random();

  if(roll<0.62){
    // Gem
    var rare=Math.random();
    var val=rare<0.07?5:rare<0.22?3:1;
    var col=val===5?'#ffd700':val===3?'#ff6a00':GR_COLORS[Math.floor(Math.random()*GR_COLORS.length)];
    grObjs.push({type:'gem',lane:lane,z:z,col:col,val:val,size:val===5?22:val===3?18:14,alive:true,collected:false});
    // Gem string
    if(Math.random()<0.38){
      for(var k=1;k<=2+Math.floor(Math.random()*3);k++)
        grObjs.push({type:'gem',lane:lane,z:z+k*130,col:col,val:1,size:14,alive:true,collected:false});
    }
  } else if(roll<0.82){
    // Enemy ‚Äî single lane, must shoot or dodge
    var gIdx=typeof currentGalaxy!=='undefined'?currentGalaxy:0;
    var shape=GR_ENEMY_SHAPES[gIdx%GR_ENEMY_SHAPES.length];
    var col=GR_ENEMY_COLORS[gIdx%GR_ENEMY_COLORS.length];
    var hp=2+Math.floor((60-grTime)/20); // gets tougher as time passes
    grObjs.push({type:'enemy',lane:lane,z:z,col:col,hp:hp,maxHp:hp,size:22,alive:true,shape:shape,spin:0,flashT:0});
  } else {
    // Obstacle ‚Äî ONLY if far enough from last one
    if(z - grLastObstacleZ < 900) return; // skip if too close
    grLastObstacleZ=z;
    var freeLane=Math.floor(Math.random()*GR_LANES);
    for(var l=0;l<GR_LANES;l++){
      if(l!==freeLane)
        grObjs.push({type:'obstacle',lane:l,z:z,col:'#ff3366',size:26,alive:true});
    }
  }
}

function grInit(){
  grCanvas=document.getElementById('grCanvas');
  var vw=window.innerWidth, vh=window.innerHeight;
  grW=Math.min(vw,480);
  grH=Math.min(vh-120,680);
  grCanvas.width=grW; grCanvas.height=grH;
  grCanvas.style.width=grW+'px'; grCanvas.style.height=grH+'px';
  grCtx=grCanvas.getContext('2d');

  var pad=grW*0.18;
  grLaneX=[pad, grW/2, grW-pad];

  grShip.lane=1; grShip.x=grLaneX[1]; grShip.targetX=grLaneX[1];
  grShip.y=grH*0.75; grShip.tilt=0; grShip.shootT=0;

  grStars=[];
  for(var i=0;i<180;i++) grStars.push({x:Math.random()*grW,y:Math.random()*grH,r:0.4+Math.random()*1.8,spd:60+Math.random()*200,alpha:0.15+Math.random()*0.7});

  grNebula=[];
  for(var i=0;i<6;i++) grNebula.push({x:Math.random()*grW,y:Math.random()*grH*0.7,r:60+Math.random()*120,col:GR_COLORS[Math.floor(Math.random()*GR_COLORS.length)],alpha:0.02+Math.random()*0.04});

  grObjs=[]; grBullets=[]; grParticles=[];
  grZ=0; grSpawnZ=800; grSpeed=300; grT=0;
  grCombo=0; grComboT=0; grMoveQueue=[];
  grLastObstacleZ=-9999;
  grStats={gems:0,enemies:0,comboPeak:0,hits:0};
  grShowStats=false; grStatsTimer=0;

  for(var i=0;i<10;i++) grSpawnObj(800+i*260);
}

function startGemRush(destGalaxy){
  grDest=destGalaxy;
  if(destGalaxy>=0) grStandalone=false;
  grCollected=0; grTime=60; grLast=performance.now();
  if(G) G.paused=true;
  document.getElementById('pauseBtn').style.display='none';
  document.getElementById('gemRush').style.display='flex';
  grInit();
  document.getElementById('grTimer').textContent='60';
  document.getElementById('grScore').textContent='üíé 0';
  grRAF=requestAnimationFrame(grFrame);
}

function grFrame(now){
  grRAF=requestAnimationFrame(grFrame);
  var dt=Math.min((now-grLast)/1000,0.05);
  grLast=now; grT+=dt; grDt=dt;

  // Stats screen ‚Äî show for 4s then auto-complete
  if(grShowStats){
    grStatsTimer-=dt;
    if(grStatsTimer<=0) endGemRush();
    grDrawStats();
    return;
  }

  grTime-=dt;
  if(grTime<=0){ grShowStats=true; grStatsTimer=5; return; }

  grSpeed=300+((60-grTime)/60)*200;

  var timerEl=document.getElementById('grTimer');
  timerEl.textContent=Math.ceil(grTime);
  timerEl.style.color=grTime>20?'#00f5ff':grTime>10?'#ffcc22':'#ff3366';
  timerEl.style.textShadow='0 0 16px '+(grTime>20?'#00f5ff':grTime>10?'#ffcc22':'#ff3366');

  // ‚îÄ‚îÄ Camera forward ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  grZ+=grSpeed*dt;

  // ‚îÄ‚îÄ Lane change ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  if(grMoveQueue.length>0&&Math.abs(grShip.x-grShip.targetX)<8){
    var dir=grMoveQueue.shift();
    var nl=Math.max(0,Math.min(GR_LANES-1,grShip.lane+dir));
    if(nl!==grShip.lane){grShip.lane=nl;grShip.targetX=grLaneX[nl];grShip.tilt=dir*0.55;}
  }
  var slideSpd=grW*5;
  var dx2=grShip.targetX-grShip.x;
  if(Math.abs(dx2)<2) grShip.x=grShip.targetX;
  else grShip.x+=dx2*Math.min(1,slideSpd*dt/Math.max(1,Math.abs(dx2)));
  grShip.tilt+=(0-grShip.tilt)*6*dt;
  grShip.engineT+=dt;

  // ‚îÄ‚îÄ Auto shoot at enemies in same lane ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  grShip.shootT-=dt;
  if(grShip.shootT<=0){
    // Find closest enemy in player's lane
    var hasEnemy=false;
    for(var i=0;i<grObjs.length;i++){
      if(grObjs[i].type==='enemy'&&grObjs[i].alive&&grObjs[i].lane===grShip.lane){hasEnemy=true;break;}
    }
    if(hasEnemy){
      grShip.shootT=0.32;
      grBullets.push({x:grShip.x,y:grShip.y-24,lane:grShip.lane,alive:true,spd:900,col:'#00f5ff'});
    } else {
      grShip.shootT=0.1;
    }
  }

  // ‚îÄ‚îÄ Bullet movement ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  for(var i=grBullets.length-1;i>=0;i--){
    var b=grBullets[i];
    if(!b.alive){grBullets.splice(i,1);continue;}
    b.y-=b.spd*dt;
    if(b.y<-20){grBullets.splice(i,1);}
  }

  // ‚îÄ‚îÄ Spawn ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  while(grSpawnZ<grZ+2200){grSpawnObj(grSpawnZ);grSpawnZ+=200+Math.random()*200;}

  // ‚îÄ‚îÄ Combo decay ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  grComboT-=dt;
  if(grComboT<0) grCombo=0;

  // ‚îÄ‚îÄ Object/bullet collision ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  for(var i=grObjs.length-1;i>=0;i--){
    var o=grObjs[i];
    if(!o.alive) continue;
    var objZ=o.z-grZ;
    if(objZ<-80){grObjs.splice(i,1);continue;}

    // Enemy ‚Äî check bullet hits (perspective-mapped screen position)
    if(o.type==='enemy'){
      o.spin+=dt*1.5;
      if(o.flashT>0) o.flashT-=dt;
      var pos=grPerspective(o.lane,objZ);
      var hitSz=o.size*pos.scale*2.5;
      for(var j=grBullets.length-1;j>=0;j--){
        var b=grBullets[j];
        if(!b.alive||b.lane!==o.lane) continue;
        var bdx=b.x-pos.x, bdy=b.y-pos.y;
        if(Math.sqrt(bdx*bdx+bdy*bdy)<hitSz+8){
          b.alive=false;
          o.hp--;
          o.flashT=0.12;
          if(o.hp<=0){
            o.alive=false;
            grStats.enemies++;
            grCombo++;grComboT=2.5;
            if(grCombo>grStats.comboPeak) grStats.comboPeak=grCombo;
            var earned=grCombo>=5?3:1;
            grCollected+=earned;
            document.getElementById('grScore').textContent='üíé '+grCollected;
            var txt=grCombo>=5?'+'+earned+' x'+grCombo+'!':'+'+earned;
            grParticles.push({x:pos.x,y:pos.y-20,vx:0,vy:-70,life:1.0,maxLife:1.0,col:o.col,type:'text',text:txt});
            for(var p=0;p<14;p++){var ang=Math.random()*Math.PI*2;grParticles.push({x:pos.x,y:pos.y,vx:Math.cos(ang)*200,vy:Math.sin(ang)*200-60,life:0.6,maxLife:0.6,r:3+Math.random()*3,col:o.col,type:'dot'});}
            SFX.enemyDie&&SFX.enemyDie();
            grObjs.splice(i,1);
          }
          break;
        }
      }
      if(!o.alive) continue;
    }

    // Collect/collision zone
    if(objZ>0&&objZ<170&&o.lane===grShip.lane){
      if(o.type==='gem'&&!o.collected){
        o.collected=true; o.alive=false;
        grCombo++;grComboT=2.5;
        if(grCombo>grStats.comboPeak) grStats.comboPeak=grCombo;
        var bonus=grCombo>=5?2:1;
        var earned=o.val*bonus;
        grCollected+=earned;
        grStats.gems++;
        document.getElementById('grScore').textContent='üíé '+grCollected;
        var pos2=grPerspective(o.lane,0);
        var sx2=pos2.x, sy2=grShip.y-40;
        for(var p=0;p<12;p++){var ang=Math.random()*Math.PI*2;grParticles.push({x:sx2,y:sy2,vx:Math.cos(ang)*180,vy:Math.sin(ang)*180-80,life:0.7,maxLife:0.7,r:3+Math.random()*3,col:o.col,type:'dot'});}
        var txt2=bonus>1?'+'+earned+' x'+bonus+'!':'+'+earned;
        grParticles.push({x:sx2,y:sy2-28,vx:0,vy:-70,life:1.0,maxLife:1.0,col:o.col,type:'text',text:txt2});
        SFX.xpCollect&&SFX.xpCollect();
        grObjs.splice(i,1);
      } else if(o.type==='obstacle'){
        o.alive=false;
        grTime=Math.max(1,grTime-2);
        grStats.hits++;
        grCombo=0;
        var hx=grLaneX[o.lane];
        for(var p=0;p<18;p++){var ang=Math.random()*Math.PI*2;grParticles.push({x:hx,y:grShip.y,vx:Math.cos(ang)*220,vy:Math.sin(ang)*220,life:0.5,maxLife:0.5,r:4+Math.random()*4,col:'#ff3366',type:'dot'});}
        grParticles.push({x:grShip.x,y:grShip.y-40,vx:0,vy:-60,life:1.1,maxLife:1.1,col:'#ff3366',type:'text',text:'-2s'});
        grObjs.splice(i,1);
      } else if(o.type==='enemy'){
        // Ran into enemy ‚Äî penalty
        o.alive=false;
        grTime=Math.max(1,grTime-1.5);
        grStats.hits++;
        grCombo=0;
        grObjs.splice(i,1);
      }
    }
  }

  grDrawFrame();
}

function grDrawFrame(){
  var ctx=grCtx;
  ctx.clearRect(0,0,grW,grH);

  // Sky
  var sky=ctx.createLinearGradient(0,0,0,grH);
  sky.addColorStop(0,'#000008');sky.addColorStop(0.55,'#010215');sky.addColorStop(1,'#020825');
  ctx.fillStyle=sky; ctx.fillRect(0,0,grW,grH);

  // Nebula
  for(var i=0;i<grNebula.length;i++){
    var nb=grNebula[i];
    nb.x+=Math.sin(grT*0.15+i)*0.3;
    var hex=Math.round(nb.alpha*255).toString(16).padStart(2,'0');
    var ng=ctx.createRadialGradient(nb.x,nb.y,0,nb.x,nb.y,nb.r);
    ng.addColorStop(0,nb.col+hex); ng.addColorStop(1,'transparent');
    ctx.fillStyle=ng; ctx.fillRect(0,0,grW,grH);
  }

  // Stars
  for(var i=0;i<grStars.length;i++){
    var s=grStars[i];
    s.y+=s.spd*grDt*(0.6+(grSpeed-300)/300);
    if(s.y>grH){s.y=-4;s.x=Math.random()*grW;}
    var slen=Math.max(2,s.spd*(0.016)*(1+(grSpeed-300)/200)*8);
    ctx.globalAlpha=s.alpha;
    ctx.strokeStyle='#ffffff';ctx.lineWidth=s.r;
    ctx.beginPath();ctx.moveTo(s.x,s.y-slen);ctx.lineTo(s.x,s.y);ctx.stroke();
  }
  ctx.globalAlpha=1;

  // Tunnel floor
  var vpy=grH*0.38, vpx=grW/2;
  var scroll=(grZ/180)%1;
  for(var row=0;row<18;row++){
    var t0=(row/18+scroll*0.12)%1, t1=((row+1)/18+scroll*0.12)%1;
    var y0=vpy+(grH-vpy)*Math.pow(t0,1.4);
    var y1=vpy+(grH-vpy)*Math.pow(t1,1.4);
    var x0L=vpx-(grW*0.55)*Math.pow(t0,0.7), x0R=vpx+(grW*0.55)*Math.pow(t0,0.7);
    var x1L=vpx-(grW*0.55)*Math.pow(t1,0.7), x1R=vpx+(grW*0.55)*Math.pow(t1,0.7);
    var alpha=(row/18)*0.28;
    ctx.fillStyle='rgba(0,20,40,'+alpha+')';
    ctx.beginPath();ctx.moveTo(x0L,y0);ctx.lineTo(x0R,y0);ctx.lineTo(x1R,y1);ctx.lineTo(x1L,y1);ctx.closePath();ctx.fill();
    if(row%3===0){ctx.strokeStyle='rgba(0,245,255,'+(alpha*1.6)+')';ctx.lineWidth=0.8;ctx.beginPath();ctx.moveTo(x1L,y1);ctx.lineTo(x1R,y1);ctx.stroke();}
  }
  for(var l=0;l<=GR_LANES;l++){
    var frac=l/GR_LANES, bx=grW*0.5+(-0.5+frac)*grW*1.1;
    ctx.strokeStyle='rgba(0,245,255,0.15)';ctx.lineWidth=1;ctx.setLineDash([8,12]);
    ctx.beginPath();ctx.moveTo(vpx+(bx-vpx)*0.04,vpy+4);ctx.lineTo(bx,grH+10);ctx.stroke();
    ctx.setLineDash([]);
  }
  var hg=ctx.createLinearGradient(0,vpy-18,0,vpy+18);
  hg.addColorStop(0,'transparent');hg.addColorStop(0.5,'rgba(0,245,255,0.18)');hg.addColorStop(1,'transparent');
  ctx.fillStyle=hg;ctx.fillRect(0,vpy-18,grW,36);

  // ‚îÄ‚îÄ Objects (far ‚Üí near) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  var visible=grObjs.filter(function(o){return o.alive&&o.z-grZ>0&&o.z-grZ<2000;});
  visible.sort(function(a,b){return (b.z-grZ)-(a.z-grZ);});

  for(var i=0;i<visible.length;i++){
    var o=visible[i];
    var objZ=o.z-grZ;
    var pos=grPerspective(o.lane,objZ);
    var sz=o.size*pos.scale*2.2;

    if(o.type==='gem'){
      ctx.save();ctx.translate(pos.x,pos.y);ctx.rotate(grT*1.5+o.z*0.02);
      ctx.shadowColor=o.col;ctx.shadowBlur=12*pos.scale+8;
      ctx.fillStyle=o.col+'33';
      ctx.beginPath();ctx.moveTo(0,-sz);ctx.lineTo(sz*0.65,0);ctx.lineTo(0,sz);ctx.lineTo(-sz*0.65,0);ctx.closePath();ctx.fill();
      ctx.fillStyle=o.col;
      ctx.beginPath();ctx.moveTo(0,-sz);ctx.lineTo(sz*0.65,0);ctx.lineTo(0,-sz*0.15);ctx.closePath();ctx.fill();
      ctx.fillStyle=o.col+'bb';
      ctx.beginPath();ctx.moveTo(0,-sz);ctx.lineTo(-sz*0.65,0);ctx.lineTo(0,-sz*0.15);ctx.closePath();ctx.fill();
      ctx.strokeStyle=o.col;ctx.lineWidth=1.5*pos.scale;
      ctx.beginPath();ctx.moveTo(0,-sz);ctx.lineTo(sz*0.65,0);ctx.lineTo(0,sz);ctx.lineTo(-sz*0.65,0);ctx.closePath();ctx.stroke();
      if(o.val>=3){ctx.shadowBlur=6;ctx.font='bold '+Math.max(8,sz*0.7)+'px Orbitron,monospace';ctx.fillStyle='#fff';ctx.textAlign='center';ctx.textBaseline='middle';ctx.fillText('x'+o.val,0,0);}
      ctx.restore();
      if(objZ<200){ctx.globalAlpha=(1-objZ/200)*0.45;ctx.strokeStyle=o.col;ctx.lineWidth=2;ctx.shadowColor=o.col;ctx.shadowBlur=20;ctx.beginPath();ctx.arc(pos.x,pos.y,sz*1.5,0,Math.PI*2);ctx.stroke();ctx.globalAlpha=1;ctx.shadowBlur=0;}

    } else if(o.type==='enemy'){
      var flash=o.flashT>0;
      ctx.save();ctx.translate(pos.x,pos.y);ctx.rotate(o.spin);
      ctx.shadowColor=flash?'#ffffff':o.col;ctx.shadowBlur=18*pos.scale+8;
      var ecol=flash?'#ffffff':o.col;
      // Draw enemy shape based on galaxy
      var sides=o.shape==='hex'||o.shape==='crystal'?6:o.shape==='rock'?8:o.shape==='ufo'?0:5;
      if(o.shape==='ufo'){
        // Saucer from above
        ctx.fillStyle=ecol+'22';ctx.strokeStyle=ecol;ctx.lineWidth=2*pos.scale;
        ctx.beginPath();ctx.ellipse(0,0,sz*1.1,sz*0.42,0,0,Math.PI*2);ctx.fill();ctx.stroke();
        ctx.fillStyle=ecol+'55';ctx.beginPath();ctx.ellipse(0,-sz*0.15,sz*0.55,sz*0.32,0,Math.PI,Math.PI*2);ctx.fill();ctx.stroke();
        var dp2=0.4+0.6*Math.abs(Math.sin(grT*4+o.z*.01));
        ctx.fillStyle='rgba(255,255,80,'+dp2+')';for(var k=0;k<6;k++){var ka=k/6*Math.PI*2;ctx.beginPath();ctx.arc(Math.cos(ka)*sz*0.85,Math.sin(ka)*sz*0.3,2*pos.scale,0,Math.PI*2);ctx.fill();}
      } else if(o.shape==='blob'||o.shape==='orb'){
        var bp=0.88+0.12*Math.sin(grT*3);
        ctx.fillStyle=ecol+'22';ctx.beginPath();ctx.arc(0,0,sz*bp,0,Math.PI*2);ctx.fill();
        ctx.strokeStyle=ecol;ctx.lineWidth=2*pos.scale;ctx.beginPath();ctx.arc(0,0,sz*0.75*bp,0,Math.PI*2);ctx.stroke();
        ctx.fillStyle=ecol+'66';ctx.beginPath();ctx.arc(0,0,sz*0.35,0,Math.PI*2);ctx.fill();
      } else if(o.shape==='void'||o.shape==='mirror'||o.shape==='architect'){
        // Dark sphere with glow rim
        var dg=ctx.createRadialGradient(0,0,0,0,0,sz*0.9);
        dg.addColorStop(0,'rgba(0,0,0,0.9)');dg.addColorStop(0.8,'rgba(0,0,0,0.5)');dg.addColorStop(1,'transparent');
        ctx.fillStyle=dg;ctx.beginPath();ctx.arc(0,0,sz,0,Math.PI*2);ctx.fill();
        ctx.strokeStyle=ecol;ctx.lineWidth=2.5*pos.scale;ctx.shadowBlur=22;ctx.beginPath();ctx.arc(0,0,sz*0.85,0,Math.PI*2);ctx.stroke();
      } else {
        // Polygon (snake=5, hex=6, rock=8, crystal=6)
        ctx.fillStyle=ecol+'22';ctx.beginPath();
        for(var k=0;k<sides;k++){var ka=k/sides*Math.PI*2;ctx.lineTo(Math.cos(ka)*sz,Math.sin(ka)*sz);}ctx.closePath();ctx.fill();
        ctx.strokeStyle=ecol;ctx.lineWidth=2*pos.scale;ctx.beginPath();
        for(var k=0;k<sides;k++){var ka=k/sides*Math.PI*2;ctx.lineTo(Math.cos(ka)*sz,Math.sin(ka)*sz);}ctx.closePath();ctx.stroke();
        ctx.fillStyle=ecol+'88';ctx.beginPath();ctx.arc(0,0,sz*0.3,0,Math.PI*2);ctx.fill();
      }
      // HP bar
      if(o.maxHp>1){
        var bw=sz*2.5,bh=4*pos.scale;
        ctx.fillStyle='rgba(0,0,0,0.5)';ctx.fillRect(-bw/2,sz+4*pos.scale,bw,bh);
        ctx.fillStyle=o.hp/o.maxHp>0.5?'#39ff8a':'#ffcc22';
        ctx.fillRect(-bw/2,sz+4*pos.scale,bw*(o.hp/o.maxHp),bh);
      }
      // Warning arrow if same lane as player
      if(o.lane===grShip.lane&&objZ<600){
        var wa=(1-objZ/600)*0.8;
        ctx.globalAlpha=wa;ctx.fillStyle=o.col;ctx.shadowColor=o.col;ctx.shadowBlur=10;
        ctx.beginPath();ctx.moveTo(pos.x,grShip.y-60);ctx.lineTo(pos.x-8,grShip.y-74);ctx.lineTo(pos.x+8,grShip.y-74);ctx.closePath();ctx.fill();
        ctx.globalAlpha=1;
      }
      ctx.restore();

    } else if(o.type==='obstacle'){
      ctx.save();ctx.translate(pos.x,pos.y);ctx.rotate(grT*0.7+o.z*0.03);
      ctx.shadowColor='#ff3366';ctx.shadowBlur=16*pos.scale+6;
      ctx.fillStyle='#ff336622';ctx.beginPath();
      for(var k=0;k<6;k++){var ka=k/6*Math.PI*2;ctx.lineTo(Math.cos(ka)*sz,Math.sin(ka)*sz);}ctx.closePath();ctx.fill();
      ctx.strokeStyle='#ff3366';ctx.lineWidth=2*pos.scale;ctx.beginPath();
      for(var k=0;k<6;k++){var ka=k/6*Math.PI*2;ctx.lineTo(Math.cos(ka)*sz,Math.sin(ka)*sz);}ctx.closePath();ctx.stroke();
      ctx.lineWidth=1.8*pos.scale;
      ctx.beginPath();ctx.moveTo(-sz*0.4,-sz*0.4);ctx.lineTo(sz*0.4,sz*0.4);ctx.stroke();
      ctx.beginPath();ctx.moveTo(sz*0.4,-sz*0.4);ctx.lineTo(-sz*0.4,sz*0.4);ctx.stroke();
      ctx.restore();
    }
  }

  // ‚îÄ‚îÄ Player bullets ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  for(var i=0;i<grBullets.length;i++){
    var b=grBullets[i];
    if(!b.alive) continue;
    ctx.save();ctx.shadowColor=b.col;ctx.shadowBlur=14;ctx.fillStyle=b.col;
    ctx.beginPath();ctx.ellipse(b.x,b.y,4,9,0,0,Math.PI*2);ctx.fill();
    ctx.restore();
  }

  // ‚îÄ‚îÄ Ship ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  var sk=typeof SKINS!=='undefined'?SKINS.find(function(s){return s.id===activeSkin;})||SKINS[0]:null;
  var shipCol=sk?sk.col:'#00f5ff';
  var sx=grShip.x, sy=grShip.y;
  ctx.save();ctx.translate(sx,sy);ctx.rotate(grShip.tilt);
  var eg=ctx.createRadialGradient(0,18,0,0,18,32);
  eg.addColorStop(0,'rgba(255,200,100,0.9)');eg.addColorStop(0.4,shipCol+'66');eg.addColorStop(1,'transparent');
  ctx.fillStyle=eg;ctx.beginPath();ctx.ellipse(0,18,16,10,0,0,Math.PI*2);ctx.fill();
  var exLen=28+Math.sin(grShip.engineT*12)*6;
  var exG=ctx.createLinearGradient(0,12,0,12+exLen);
  exG.addColorStop(0,'rgba(255,220,80,0.9)');exG.addColorStop(0.5,shipCol+'88');exG.addColorStop(1,'transparent');
  ctx.fillStyle=exG;ctx.beginPath();ctx.moveTo(-7,12);ctx.lineTo(7,12);ctx.lineTo(4,12+exLen);ctx.lineTo(-4,12+exLen);ctx.closePath();ctx.fill();
  ctx.shadowColor=shipCol;ctx.shadowBlur=20;
  ctx.fillStyle=shipCol+'22';
  ctx.beginPath();ctx.moveTo(0,-22);ctx.lineTo(-18,8);ctx.lineTo(-10,4);ctx.lineTo(0,12);ctx.lineTo(10,4);ctx.lineTo(18,8);ctx.closePath();ctx.fill();
  ctx.strokeStyle=shipCol;ctx.lineWidth=2;
  ctx.beginPath();ctx.moveTo(0,-22);ctx.lineTo(-18,8);ctx.lineTo(-10,4);ctx.lineTo(0,12);ctx.lineTo(10,4);ctx.lineTo(18,8);ctx.closePath();ctx.stroke();
  ctx.fillStyle=shipCol+'55';ctx.strokeStyle=shipCol;ctx.lineWidth=1.5;
  ctx.beginPath();ctx.ellipse(0,-6,7,9,0,0,Math.PI*2);ctx.fill();ctx.stroke();
  ctx.strokeStyle=shipCol+'aa';ctx.lineWidth=1;
  ctx.beginPath();ctx.moveTo(-14,6);ctx.lineTo(-6,-10);ctx.stroke();
  ctx.beginPath();ctx.moveTo(14,6);ctx.lineTo(6,-10);ctx.stroke();
  var cg=ctx.createRadialGradient(0,-6,0,0,-6,10);
  cg.addColorStop(0,'#ffffff');cg.addColorStop(0.4,shipCol);cg.addColorStop(1,'transparent');
  ctx.fillStyle=cg;ctx.beginPath();ctx.arc(0,-6,8+Math.sin(grT*4)*1.5,0,Math.PI*2);ctx.fill();
  ctx.restore();

  // ‚îÄ‚îÄ Particles ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  for(var i=grParticles.length-1;i>=0;i--){
    var pt=grParticles[i];
    pt.life-=grDt;if(pt.life<=0){grParticles.splice(i,1);continue;}
    pt.x+=pt.vx*grDt;pt.y+=pt.vy*grDt;pt.vy+=120*grDt;
    var a=Math.min(1,pt.life/pt.maxLife*2);
    ctx.globalAlpha=a;
    if(pt.type==='text'){ctx.font='bold 13px Orbitron,monospace';ctx.fillStyle=pt.col;ctx.textAlign='center';ctx.textBaseline='middle';ctx.shadowColor=pt.col;ctx.shadowBlur=10;ctx.fillText(pt.text,pt.x,pt.y);ctx.shadowBlur=0;}
    else{ctx.fillStyle=pt.col;ctx.shadowColor=pt.col;ctx.shadowBlur=8;ctx.beginPath();ctx.arc(pt.x,pt.y,Math.max(0.5,pt.r*a),0,Math.PI*2);ctx.fill();ctx.shadowBlur=0;}
    ctx.globalAlpha=1;
  }

  // ‚îÄ‚îÄ Combo ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  if(grCombo>=3&&grComboT>0){
    ctx.globalAlpha=Math.min(1,grComboT);
    ctx.font='bold '+(10+Math.min(grCombo,12))+'px Orbitron,monospace';
    ctx.fillStyle='#ffd700';ctx.textAlign='center';ctx.shadowColor='#ffd700';ctx.shadowBlur=16;
    ctx.fillText(grCombo+'x COMBO',grW/2,vpy+22);
    ctx.shadowBlur=0;ctx.globalAlpha=1;
  }

  // ‚îÄ‚îÄ Timer bar ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  var barPct=grTime/60;
  var bCol=barPct>0.33?'#00f5ff':barPct>0.17?'#ffcc22':'#ff3366';
  ctx.fillStyle='rgba(0,0,0,0.6)';ctx.fillRect(0,0,grW,7);
  var barG=ctx.createLinearGradient(0,0,grW*barPct,0);
  barG.addColorStop(0,bCol);barG.addColorStop(1,bCol+'77');
  ctx.fillStyle=barG;ctx.fillRect(0,0,grW*barPct,7);
  ctx.shadowColor=bCol;ctx.shadowBlur=10;ctx.fillRect(grW*barPct-2,0,3,7);ctx.shadowBlur=0;
}

// ‚îÄ‚îÄ Stats screen drawn on canvas ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function grDrawStats(){
  var ctx=grCtx;
  var t=5-grStatsTimer; // 0‚Üí5 as it fades in

  // Dark overlay
  ctx.fillStyle='rgba(0,0,8,0.94)';ctx.fillRect(0,0,grW,grH);

  // Background glow
  var bg=ctx.createRadialGradient(grW/2,grH/2,0,grW/2,grH/2,grW*0.7);
  bg.addColorStop(0,'rgba(0,245,255,0.06)');bg.addColorStop(1,'transparent');
  ctx.fillStyle=bg;ctx.fillRect(0,0,grW,grH);

  var cx=grW/2, cy=grH*0.38;
  var alpha=Math.min(1,t*2);
  ctx.globalAlpha=alpha;

  // Title
  ctx.textAlign='center';
  ctx.font='bold clamp(16px,5vw,26px) Orbitron,monospace';
  ctx.fillStyle='#ffd700';ctx.shadowColor='#ffd700';ctx.shadowBlur=24;
  ctx.fillText('GEM RUSH COMPLETE',cx,cy-80);
  ctx.shadowBlur=0;

  // Crystal haul ‚Äî big number
  ctx.font='bold '+Math.min(grW*0.18,72)+'px Orbitron,monospace';
  var grad=ctx.createLinearGradient(cx-60,cy-40,cx+60,cy+20);
  grad.addColorStop(0,'#ffd700');grad.addColorStop(1,'#ff6a00');
  ctx.fillStyle=grad;ctx.shadowColor='#ffd700';ctx.shadowBlur=28;
  ctx.fillText('üíé '+grCollected,cx,cy);
  ctx.shadowBlur=0;

  // Stat rows
  var rows=[
    {label:'GEMS COLLECTED', val:grStats.gems, col:'#00f5ff'},
    {label:'ENEMIES DESTROYED', val:grStats.enemies, col:'#ff6a00'},
    {label:'PEAK COMBO', val:grStats.comboPeak+'x', col:'#ffd700'},
    {label:'TIMES HIT', val:grStats.hits, col:grStats.hits===0?'#39ff8a':'#ff3366'},
  ];
  var rowY=cy+50;
  for(var i=0;i<rows.length;i++){
    var row=rows[i];
    var rowAlpha=Math.min(1,Math.max(0,(t-i*0.2-0.3)*3));
    ctx.globalAlpha=alpha*rowAlpha;
    // Row bg
    ctx.fillStyle='rgba(255,255,255,0.04)';
    ctx.beginPath();ctx.roundRect?ctx.roundRect(cx-grW*0.38,rowY-14,grW*0.76,26,4):ctx.rect(cx-grW*0.38,rowY-14,grW*0.76,26);
    ctx.fill();
    ctx.font='bold 10px Orbitron,monospace';
    ctx.fillStyle='#446';ctx.textAlign='left';
    ctx.fillText(row.label,cx-grW*0.34,rowY+2);
    ctx.font='bold 13px Orbitron,monospace';
    ctx.fillStyle=row.col;ctx.shadowColor=row.col;ctx.shadowBlur=10;
    ctx.textAlign='right';
    ctx.fillText(row.val,cx+grW*0.34,rowY+2);
    ctx.shadowBlur=0;
    rowY+=36;
  }

  // Perfect run badge
  if(grStats.hits===0){
    ctx.globalAlpha=alpha;
    ctx.textAlign='center';
    ctx.font='bold 11px Orbitron,monospace';
    ctx.fillStyle='#39ff8a';ctx.shadowColor='#39ff8a';ctx.shadowBlur=18;
    ctx.fillText('‚ú¶ PERFECT RUN ‚Äî BONUS +10 üíé',cx,rowY+18);
    ctx.shadowBlur=0;
  }

  // Tap to continue hint
  var hint=Math.max(0,Math.min(1,(t-1.5)*2));
  ctx.globalAlpha=alpha*hint*(.5+.5*Math.sin(grT*3));
  ctx.font='9px Orbitron,monospace';ctx.fillStyle='#446';ctx.textAlign='center';
  ctx.fillText('TAP TO CONTINUE',cx,grH-24);
  ctx.globalAlpha=1;
}

function endGemRush(){
  if(grRAF){cancelAnimationFrame(grRAF);grRAF=null;}
  document.getElementById('gemRush').style.display='none';
  // Perfect bonus
  if(grStats.hits===0) grCollected+=10;
  crystals+=grCollected;
  lsS('vr_crystals',crystals);
  if(grCollected>0) fmsg('üíé GEM RUSH +'+grCollected+' CRYSTALS','#ffd700');
  if(grStandalone){
    var mcd=document.getElementById('mcd');
    if(mcd) mcd.textContent='üíé '+crystals+' CRYSTALS';
    document.getElementById('menu').style.display='flex';
  } else {
    warpToGalaxy(grDest);
  }
}

function startGemRushStandalone(){
  grStandalone=true;
  document.getElementById('menu').style.display='none';
  startGemRush(-1);
}

// ‚îÄ‚îÄ Input ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
(function(){
  function wireGR(){
    var canvas=document.getElementById('grCanvas');
    var skip=document.getElementById('grSkip');
    if(!canvas||!skip){setTimeout(wireGR,100);return;}
    var touchStartX=0, touchMoved=false;
    canvas.addEventListener('pointerdown',function(e){
      e.preventDefault();
      // Tap during stats screen ‚Äî end immediately
      if(grShowStats){endGemRush();return;}
      touchStartX=e.clientX; touchMoved=false;
    },{passive:false});
    canvas.addEventListener('pointermove',function(e){
      e.preventDefault();
      if(!grRAF||grShowStats) return;
      var dx2=e.clientX-touchStartX;
      if(Math.abs(dx2)>26&&!touchMoved){
        touchMoved=true; touchStartX=e.clientX;
        grMoveQueue.push(dx2>0?1:-1);
      }
    },{passive:false});
    canvas.addEventListener('pointerup',function(e){
      e.preventDefault();
      if(grShowStats){endGemRush();return;}
      if(!touchMoved){
        var rect=canvas.getBoundingClientRect();
        var tx=e.clientX-rect.left;
        grMoveQueue.push(tx<grW/2?-1:1);
      }
    },{passive:false});
    document.addEventListener('keydown',function(e){
      if(!grRAF) return;
      if(grShowStats){endGemRush();return;}
      if(e.key==='ArrowLeft'||e.key==='a') grMoveQueue.push(-1);
      if(e.key==='ArrowRight'||e.key==='d') grMoveQueue.push(1);
    });
    skip.addEventListener('pointerdown',function(){
      SFX.click&&SFX.click();
      if(grShowStats) endGemRush(); else {grShowStats=true;grStatsTimer=0.01;}
    });
  }
  wireGR();
})();


function warpToGalaxy(gIdx){
  if(warpAnimating)return;
  warpAnimating=true;
  currentGalaxy=Math.min(gIdx,GALAXIES.length-1);
  incLS('galaxiesVisited');
  markGalaxyVisited(currentGalaxy);
  const gal=GALAXIES[currentGalaxy];
  const ov=document.getElementById('warpOverlay');
  const wc=document.getElementById('warpCanvas');
  wc.width=W;wc.height=H;
  const wctx=wc.getContext('2d');
  document.getElementById('warpTitle').textContent=gal.name;
  document.getElementById('warpTitle').style.color=gal.acc;
  document.getElementById('warpTitle').style.textShadow='0 0 30px '+gal.acc;
  document.getElementById('warpSub').textContent='GALAXY '+(currentGalaxy+1)+' ¬∑ DIFFICULTY x'+gal.diff.toFixed(2);
  document.getElementById('warpSub').style.color=gal.acc;
  const stars=Array.from({length:200},()=>({x:(Math.random()-.5)*W*2,y:(Math.random()-.5)*H*2,spd:1+Math.random()*4}));
  let frame=0;const totalFrames=90;
  ov.style.opacity='1';
  SFX.warp();
  if(G)G.paused=true;
  var pb=document.getElementById('pauseBtn');if(pb)pb.style.display='none';
  function animFrame(){
    wctx.fillStyle='rgba(0,0,0,0.25)';wctx.fillRect(0,0,W,H);
    const t=frame/totalFrames;
    wctx.globalAlpha=Math.min(0.85,t*2);
    wctx.strokeStyle=gal.acc;
    for(const s of stars){
      const stretch=t*t*20+0.5;
      const sx=W/2+s.x*t*2,sy=H/2+s.y*t*2;
      const ex=W/2+s.x*(t*2+stretch*.08),ey=H/2+s.y*(t*2+stretch*.08);
      wctx.lineWidth=1+t*2;wctx.beginPath();wctx.moveTo(sx,sy);wctx.lineTo(ex,ey);wctx.stroke();
    }
    wctx.globalAlpha=1;
    frame++;
    if(frame<totalFrames){requestAnimationFrame(animFrame);}
    else{
      setTimeout(function(){
        buildBgForGalaxy(currentGalaxy);
        const gb=document.getElementById('galaxyBadge');
        if(gb){
          var twistLabels={leviathan:'‚¨° PHASE ZONE',formation:'‚¨° FORMATION ZONE',meteors:'‚¨° IMPACT ZONE',poison:'‚¨° TOXIC ZONE',freeze:'‚¨° CRYO ZONE',emp:'‚¨° EMP ZONE',gravity:'‚¨° GRAVITY ZONE',mirror:'‚¨° MIRROR ZONE',voidheart:'‚¨° FINAL ZONE'};
          var tl=gal.twist?(' ¬∑ '+twistLabels[gal.twist]):'';
          gb.textContent=gal.name+' ¬∑ G'+(currentGalaxy+1)+tl;
          gb.style.color=gal.acc;
        }
        if(G){G.galaxy=currentGalaxy;G.liveAsteroids=[];G.bossFought=false;G.bossAlive=false;G.killsForBoss=0;spawnLiveAsteroids(G,22+currentGalaxy*3);}
        ov.style.opacity='0';
        setTimeout(function(){
          warpAnimating=false;
          if(G){G.paused=false;if(!loopRunning){last=0;safeRAF();}}
          var pb=document.getElementById('pauseBtn');
          if(pb)pb.style.display='flex';
        },500);
      },500);
    }
  }
  animFrame();
}

// ‚îÄ‚îÄ‚îÄ BEAM WEAPON SYSTEM ‚îÄ‚îÄ‚îÄ
var beamRanks  = lsG('vr_beamRanks', {});
var activeBeam = lsG('vr_activeBeam', null);
// Migration from old single-beam save
(function(){ var ob=lsG('vr_beam',null),or=lsG('vr_beamRank',0); if(ob&&or>0&&!beamRanks[ob]){beamRanks[ob]=or;lsS('vr_beamRanks',beamRanks);activeBeam=ob;lsS('vr_activeBeam',activeBeam);} })();
function ownedBeam(){ return activeBeam&&(beamRanks[activeBeam]||0)>=1?activeBeam:null; }
function beamRank(){ return activeBeam?(beamRanks[activeBeam]||0):0; }
var visitedGalaxies = lsG('vr_visitedGalaxies', [0]);
function markGalaxyVisited(idx){
  if(visitedGalaxies.indexOf(idx)<0){visitedGalaxies.push(idx);lsS('vr_visitedGalaxies',visitedGalaxies);}
}
var galaxySelectFromPause = false;
function openGalaxySelect(fromPause){
  galaxySelectFromPause = !!fromPause;
  var grid=document.getElementById('galaxyGrid');
  grid.innerHTML='';
  for(var i=0;i<GALAXIES.length;i++){
    (function(gi){
      var gal=GALAXIES[gi];
      var visited=visitedGalaxies.indexOf(gi)>=0;
      var isCurrent=G&&G.galaxy===gi;
      var card=document.createElement('div');
      card.className='gsel '+(visited?'unlocked':'locked');
      card.style.borderColor=isCurrent?(gal.acc):(visited?gal.acc+'66':'rgba(255,255,255,0.05)');
      card.style.boxShadow=isCurrent?'0 0 18px '+gal.acc+'66':(visited?'0 0 10px '+gal.acc+'22':'none');
      var twistIcons={leviathan:'ü™±',formation:'ü§ñ',meteors:'‚òÑÔ∏è',poison:'ü¶†',freeze:'üßä',emp:'‚ö°',gravity:'üï≥',mirror:'üß†',voidheart:'üåë'};
      var tIcon=gal.twist?twistIcons[gal.twist]:'üõ∏';
      card.innerHTML='<div style="font-size:18px;margin-right:4px;">'+tIcon+'</div>'
        +'<div class="gselNum" style="color:'+gal.acc+'">'+(isCurrent?'‚ñ∂ ':'')+'G'+(gi+1)+'</div>'
        +'<div class="gselName" style="color:'+gal.acc+'">'+gal.name+'</div>'
        +'<div class="gselDiff">'+(visited?'x'+gal.diff.toFixed(1):'üîí')+'</div>';
      if(visited){
        card.addEventListener('pointerdown',function(){
          SFX.click();
          document.getElementById('galaxySelect').style.display='none';
          if(galaxySelectFromPause){
            // Warp directly from pause ‚Äî resume game into new galaxy
            if(gi===currentGalaxy){
              // Same galaxy ‚Äî just resume
              document.getElementById('pauseMenu').style.display='none';
              resumeGame();
            } else {
              document.getElementById('pauseMenu').style.display='none';
              warpToGalaxy(gi);
              // resumeGame is handled by warpToGalaxy completion ‚Äî do not call here
            }
          } else {
            document.getElementById('menu').style.display='none';
            currentGalaxy=gi;last=0;loopRunning=false;
            buildBgForGalaxy(gi);
            document.getElementById('pauseBtn').style.display='flex';document.getElementById('pauseBtn').textContent='‚è∏';
            newGame();startMusic();safeRAF();
          }
        });
      }
      grid.appendChild(card);
    })(i);
  }
  document.getElementById('galaxySelect').style.display='flex';
}

const BEAM_DEFS = [
  { id:'pulse',   name:'PULSE LASER',   icon:'‚ö°', color:'#00f5ff', cost:60,
    desc:'Rapid single-target. SINGULARITY: Fires giant crushing beam.',
    baseDmg:18, baseCd:0.18, baseSpd:720, basePierce:0, baseSize:5,
    getStats: function(r){ return {dmg:18*Math.pow(1.18,r), cd:Math.max(0.06,0.18*Math.pow(0.92,r)), spd:720+r*20, pierce:Math.floor(r/5), size:5+Math.floor(r/8), spread:r>=10?1:0, color:'#00f5ff'}; },
    upgDesc: function(r){ return '+18% dmg, -8% cd/rank'+(r>=5?' ¬∑ CHAIN PIERCE':'')+(r>=10?' ¬∑ TWIN SHOT':''); },
    singularity: function(g){ // Giant crushing beam ‚Äî scales with rank
      var p=g.player,a=p.aimAngle,stats=getBeamStats(),r=beamRank();
      var shots=r; var spread=0.06+r*0.01;
      for(var i=0;i<shots;i++){var off=(i-(shots-1)/2)*spread;
        g.bullets.push({x:p.x,y:p.y,vx:Math.cos(a+off)*1100,vy:Math.sin(a+off)*1100,dmg:stats.dmg*(6+r*2),size:20+r*2,pierce:99,pc:0,color:'#00ffff',life:2+r*0.2,isEnemy:false,homing:false,target:null,chain:false});
      }
      burst(g,p.x,p.y,'#00f5ff',10+r*5,200+r*30);fmsg('‚ö° SINGULARITY BEAM','#00f5ff');
    }
  },
  { id:'scatter',  name:'SCATTER BLASTER', icon:'üåü', color:'#ff6a00', cost:80,
    desc:'5-way spread. SINGULARITY: Fires at extreme speed for 3s.',
    baseDmg:14, baseCd:0.55, baseSpd:560, basePierce:0, baseSize:6,
    getStats: function(r){ return {dmg:12*Math.pow(1.12,r), cd:Math.max(0.28,0.55*Math.pow(0.96,r)), spd:520, pierce:0, size:5+Math.floor(r/12), spread:Math.min(3,1+Math.floor(r/8)), color:'#ff6a00'}; },
    upgDesc: function(r){ return '+20% dmg/rank ¬∑ spread '+(2+Math.floor(r/5))+' ‚Üí '+(2+Math.floor((r+1)/5)); },
    singularity: function(g){ // Rapid fire frenzy ‚Äî duration scales with rank
      var r=beamRank();
      var dur=2+r*0.6; // r1=2.6s r5=5s
      g._scatterFrenzy=dur;
      g._scatterNormalCd=g.gun.cd;
      g.gun.cd=Math.max(0.02,0.08-r*0.01);
      fmsg('üåü SCATTER FRENZY ‚Äî '+dur.toFixed(1)+'s','#ff6a00');
    }
  },
  { id:'chain',    name:'CHAIN ARC',      icon:'‚ö°', color:'#9b59ff', cost:120,
    desc:'Bounces between enemies. SINGULARITY: Bounces explode on contact.',
    baseDmg:22, baseCd:0.7, baseSpd:500, basePierce:2, baseSize:7,
    getStats: function(r){ return {dmg:22*Math.pow(1.22,r), cd:Math.max(0.25,0.7*Math.pow(0.93,r)), spd:500, pierce:2+Math.floor(r/3), size:7, spread:0, color:'#9b59ff', chain:true}; },
    upgDesc: function(r){ return '+22% dmg ¬∑ bounces '+(2+Math.floor(r/3))+' ‚Üí '+(2+Math.floor((r+1)/3)); },
    singularity: function(g){ // Explosive bounces ‚Äî scales with rank
      var r=beamRank();
      var dur=3+r*1.0; // r1=4s r5=8s
      g._chainExplosive=dur;fmsg('‚ö° CHAIN EXPLOSION ‚Äî '+dur.toFixed(0)+'s','#9b59ff');
    }
  },
  { id:'rail',     name:'RAILGUN',        icon:'üí¢', color:'#ff3366', cost:150,
    desc:'Slow but pierces ALL enemies. SINGULARITY: True laser that vaporizes everything.',
    baseDmg:85, baseCd:2.2, baseSpd:900, basePierce:99, baseSize:9,
    getStats: function(r){ return {dmg:85*Math.pow(1.25,r), cd:Math.max(0.6,2.2*Math.pow(0.91,r)), spd:900+r*30, pierce:99, size:9+Math.floor(r/5), spread:0, color:'#ff3366'}; },
    upgDesc: function(r){ return '+25% dmg ¬∑ -9% cd/rank ¬∑ size '+(9+Math.floor(r/5))+' ‚Üí '+(9+Math.floor((r+1)/5)); },
    singularity: function(g){ // Sustained thick vaporize beam ‚Äî scales with rank
      var stats=getBeamStats(),r=beamRank();
      var dur=2+r*0.6; // r1=2.6s r5=5s
      g._railLaser={life:dur,maxLife:dur,dmgTick:0,dmgPerSec:stats.dmg*(8+r*3)};
      fmsg('üí¢ VAPORIZE BEAM','#ff3366');
      burst(g,g.player.x,g.player.y,'#ff3366',10+r*6,150+r*40);
    }
  },
];

function beamUpgradeCost(rank){ return Math.round(30 * Math.pow(1.55, rank)); }
function getBeamStats(){
  var ob=ownedBeam(); if(!ob) return null;
  var def=BEAM_DEFS.find(function(b){return b.id===ob;}); if(!def) return null;
  return def.getStats(beamRank());
}

function openBeamShop(fromPause){
  var panel = document.getElementById('bshop');
  document.getElementById('bshopCoins').textContent = 'üíé '+crystals+' CRYSTALS';
  var cards = document.getElementById('bshopCards');
  cards.innerHTML = '';

  BEAM_DEFS.forEach(function(def){
    var rank = beamRanks[def.id]||0;
    var unlocked = rank>=1;
    var cost = unlocked ? beamUpgradeCost(rank) : def.cost;
    var isActive = activeBeam===def.id;
    var card = document.createElement('div');
    card.style.cssText = 'width:100%;padding:16px 18px;border:none;border-bottom:1px solid '+(unlocked?def.color+'44':'#ffffff11')+';background:'+(isActive?'rgba(10,10,30,0.99)':'rgba(4,4,20,0.96)')+';box-sizing:border-box;display:flex;flex-direction:column;gap:8px;';

    var statusLabel = unlocked ? ('RANK '+rank+(rank>=10?' MAX':'')) : 'LOCKED';
    var statusCol   = unlocked ? def.color : '#334';
    card.innerHTML = '<div style="display:flex;align-items:center;gap:12px;">'
      +'<div style="font-size:28px;flex-shrink:0;width:36px;text-align:center;opacity:'+(unlocked?1:0.35)+';">'+def.icon+'</div>'
      +'<div style="flex:1;min-width:0;">'
      +'<div style="font-family:Orbitron,sans-serif;font-size:13px;color:'+(unlocked?def.color:'#334')+';letter-spacing:1px;margin-bottom:2px;">'+def.name+'</div>'
      +'<div style="font-size:9px;color:'+statusCol+';letter-spacing:2px;">'+statusLabel+'</div>'
      +'</div>'
      +(isActive?'<div style="font-family:Orbitron,sans-serif;font-size:9px;color:'+def.color+';letter-spacing:2px;padding:3px 7px;border:1px solid '+def.color+';border-radius:2px;">ACTIVE</div>':'')
      +'</div>';

    if(unlocked){
      var stats=def.getStats(rank), nextStats=def.getStats(rank+1);
      card.innerHTML += '<div style="font-size:10px;color:#446;line-height:1.5;">'+def.upgDesc(rank)+'</div>'
        +'<div style="font-size:10px;color:#557;">DMG: '+Math.round(stats.dmg)+' ¬∑ CD: '+stats.cd.toFixed(2)+'s'+(rank<10?' ‚Üí '+Math.round(nextStats.dmg)+' / '+nextStats.cd.toFixed(2)+'s':'')+'</div>'
        +'<div style="display:flex;gap:8px;">'
        +'<button class="beamEquipBtn" data-id="'+def.id+'" style="font-family:Orbitron,monospace;font-size:11px;padding:9px 0;flex:1;background:transparent;border:1px solid '+(isActive?def.color:'#334')+';color:'+(isActive?def.color:'#446')+';cursor:pointer;border-radius:2px;">'+(isActive?'‚úì ACTIVE':'EQUIP')+'</button>'
        +(rank<10?'<button class="beamUpgBtn" data-id="'+def.id+'" style="font-family:Orbitron,monospace;font-size:11px;padding:9px 0;flex:2;background:transparent;border:1px solid '+def.color+';color:'+def.color+';cursor:pointer;border-radius:2px;">UPGRADE  '+cost+' üíé</button>':'')
        +'</div>';
    } else {
      card.innerHTML += '<div style="font-size:10px;color:#334;line-height:1.4;">'+def.desc+'</div>'
        +'<button class="beamUnlockBtn" data-id="'+def.id+'" style="font-family:Orbitron,monospace;font-size:11px;padding:10px 0;width:100%;background:transparent;border:1px solid #334;color:#446;cursor:pointer;border-radius:2px;">UNLOCK  '+cost+' üíé</button>';
    }
    cards.appendChild(card);
  });

  cards.querySelectorAll('.beamEquipBtn').forEach(function(btn){
    btn.addEventListener('pointerdown',function(){
      activeBeam=btn.getAttribute('data-id'); lsS('vr_activeBeam',activeBeam);
      if(G&&G.running) applyBeamToGun();
      SFX.click(); openBeamShop(fromPause);
    });
  });
  cards.querySelectorAll('.beamUpgBtn').forEach(function(btn){
    btn.addEventListener('pointerdown',function(){
      var id=btn.getAttribute('data-id');
      var rank=beamRanks[id]||0;
      var cost2=beamUpgradeCost(rank);
      if(crystals<cost2){fmsg('NOT ENOUGH CRYSTALS','#ff3366');SFX.click();return;}
      crystals-=cost2; lsS('vr_crystals',crystals);
      beamRanks[id]=rank+1; lsS('vr_beamRanks',beamRanks);
      if(!activeBeam||!beamRanks[activeBeam]) {activeBeam=id;lsS('vr_activeBeam',activeBeam);}
      if(G&&G.running) applyBeamToGun();
      SFX.upgrade();
      var def2=BEAM_DEFS.find(function(b){return b.id===id;});
      fmsg(def2.icon+' '+def2.name+' RANK '+(rank+1),'#ffd700');
      openBeamShop(fromPause);
    });
  });
  cards.querySelectorAll('.beamUnlockBtn').forEach(function(btn){
    btn.addEventListener('pointerdown',function(){
      var id=btn.getAttribute('data-id');
      var def2=BEAM_DEFS.find(function(b){return b.id===id;});
      if(crystals<def2.cost){fmsg('NOT ENOUGH CRYSTALS','#ff3366');SFX.click();return;}
      crystals-=def2.cost; lsS('vr_crystals',crystals);
      beamRanks[id]=1; lsS('vr_beamRanks',beamRanks);
      if(!activeBeam){activeBeam=id; lsS('vr_activeBeam',activeBeam);}
      if(G&&G.running) applyBeamToGun();
      SFX.upgrade(); fmsg(def2.icon+' '+def2.name+' UNLOCKED','#00f5ff');
      openBeamShop(fromPause);
    });
  });

  panel.style.display = 'flex';
  panel._fromPause = fromPause;
}
function closeBeamShop(){
  var panel = document.getElementById('bshop');
  panel.style.display = 'none';
  if(panel._fromPause && G && G.running){
    document.getElementById('pauseMenu').style.display = 'flex';
  } else {
    document.getElementById('menu').style.display = 'flex';
    document.getElementById('mcd').textContent = 'üíé '+crystals+' CRYSTALS';
  }
}

function applyBeamToGun(){
  if(!G) return;
  var stats = getBeamStats();
  var bon = getBonus();
  if(!stats){ // default gun
    G.gun.dmg = 24*bon.dmg; G.gun.cd = 0.48*bon.cd; G.gun.spd = 580;
    G.gun.pierce = bon.pierce; G.gun.size = 6; G.gun.spread = 0;
    G.gun.color = '#00f5ff'; G.gun.chain = false; G.gun.homing = G.gun.homing||false;
  } else {
    G.gun.dmg = stats.dmg * bon.dmg; G.gun.cd = stats.cd * bon.cd;
    G.gun.spd = stats.spd; G.gun.pierce = stats.pierce + bon.pierce;
    G.gun.size = stats.size; G.gun.spread = stats.spread||0;
    G.gun.color = stats.color; G.gun.chain = stats.chain||false;
  }
}

// ‚îÄ‚îÄ‚îÄ PERM DEFS ‚îÄ‚îÄ‚îÄ
const PERM_TABS=['SHIP','WEAPONS','ABILITIES','BADGES'];
const PERM_DEFS={
  SHIP:[
    {id:'p_hull',  icon:'üõ°Ô∏è',name:'HULL PLATING',   desc:'+30 max hull/rank',       maxRank:10,baseCost:40, cm:2.1},
    {id:'p_spd',   icon:'üöÄ',name:'ION DRIVE',       desc:'+8% speed/rank',          maxRank:8, baseCost:35, cm:2.0},
    {id:'p_regen', icon:'‚ö°',name:'NANO REPAIR',     desc:'+1 hull regen/sec/rank',  maxRank:6, baseCost:55, cm:2.3},
    {id:'p_magnet',icon:'üåÄ',name:'TRACTOR BEAM',    desc:'+35% crystal range/rank', maxRank:5, baseCost:30, cm:2.0},
    {id:'p_xp',    icon:'‚≠ê',name:'NEURAL LINK',     desc:'+15% XP gain/rank',       maxRank:8, baseCost:30, cm:1.9},
  ],
  WEAPONS:[
    {id:'p_dmg',   icon:'üí¢',name:'PLASMA CORE',     desc:'+10% weapon dmg/rank',    maxRank:10,baseCost:45, cm:2.1},
    {id:'p_cd',    icon:'‚öôÔ∏è',name:'OVERCLOCK',       desc:'-8% fire rate cd/rank',   maxRank:8, baseCost:50, cm:2.2},
    {id:'p_pierce',icon:'üéØ',name:'PHASE ROUNDS',    desc:'+1 pierce/rank',          maxRank:4, baseCost:80, cm:2.8},
    {id:'p_abcd',  icon:'‚è±Ô∏è',name:'QUANTUM TIMER',   desc:'-8% ability cd/rank',     maxRank:8, baseCost:40, cm:2.0, galaxyReq:1},
  ],
  ABILITIES:[
    {id:'p_dash',  icon:'üí®',name:'WARP DRIVE',      desc:'R1:0.8s invincible R2:afterimages R3:phase clone R4:2s invincible R5:FULL PHASE', maxRank:5,baseCost:18,cm:2.8},
    {id:'p_shockwave',icon:'üí´',name:'SHOCKWAVE', desc:'R1:stun 5s R2:+radius R3:dmg R4:double pulse R5:MEGA SHOCKWAVE',maxRank:5,baseCost:20,cm:2.8},
    {id:'p_bomb',  icon:'üí•',name:'NOVA COLLAPSE',   desc:'R1:larger R2:gravity pull R3:shockwave rings R4:void implosion R5:SUPERNOVA',     maxRank:5,baseCost:20,cm:2.8},
    {id:'p_heal',  icon:'üåü',name:'STELLAR REBIRTH', desc:'R1:shield 80hp R2:shield 160hp+faster regen R3:200hp R4:300hp R5:500hp+resurrect',maxRank:5,baseCost:18,cm:2.8},
  ],
};
function pRank(id){return permData[id]||0;}
function pCost(def){const r=pRank(def.id);if(r>=def.maxRank)return Infinity;return Math.round(def.baseCost*Math.pow(def.cm,r));}

// ‚ïê‚ïê VOID TREE & PRESTIGE SYSTEM ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

var VOID_TREE = [
  {id:'crystalline_core', icon:'üíé', name:'CRYSTALLINE CORE',   desc:'+10% crystal gain per run',       cost:5,  cm:1.6, apply:function(b,r){b.crystalMult=(b.crystalMult||1)*Math.pow(1.10,r);}},
  {id:'hull_reinforcement',icon:'üõ°Ô∏è',name:'HULL REINFORCEMENT', desc:'+50 base max hull',                cost:8,  cm:1.7, apply:function(b,r){b.hull+=50*r;}},
  {id:'overclock',        icon:'‚öôÔ∏è', name:'OVERCLOCK',          desc:'+5% fire rate permanently',        cost:10, cm:1.8, apply:function(b,r){b.cd*=Math.pow(0.95,r);}},
  {id:'void_hunger',      icon:'‚≠ê', name:'VOID HUNGER',         desc:'+15% XP gain permanently',         cost:10, cm:1.8, apply:function(b,r){b.xp*=Math.pow(1.15,r);}},
  {id:'shard_magnet',     icon:'üß≤', name:'SHARD MAGNET',        desc:'Bosses drop +1 extra Essence',     cost:20, cm:2.0, apply:function(b,r){b.essenceBonus=(b.essenceBonus||0)+r;}},
  {id:'dark_matter',      icon:'üåë', name:'DARK MATTER ENGINE',  desc:'+10% all damage permanently',      cost:30, cm:2.2, apply:function(b,r){b.dmg*=Math.pow(1.10,r);}},
];

function vtRank(id){ return voidTreeData[id]||0; }
function vtCost(def){ return Math.round(def.cost*Math.pow(def.cm, vtRank(def.id))); }

function getVoidBonus(){
  var b={hull:0,dmg:1,spd:1,cd:1,xp:1,pierce:0,crystalMult:1,essenceBonus:0};
  // Void Tree bonuses
  for(var i=0;i<VOID_TREE.length;i++){
    var r=vtRank(VOID_TREE[i].id);
    if(r>0) VOID_TREE[i].apply(b,r);
  }
  // Void Shard flat bonus ‚Äî each shard gives +3% to dmg, cd, xp
  if(voidShards>0){
    b.dmg  *= Math.pow(1.03, voidShards);
    b.cd   *= Math.pow(0.97, voidShards);
    b.xp   *= Math.pow(1.03, voidShards);
    b.hull += 20 * voidShards;
  }
  return b;
}

function allBossesDefeated(){
  for(var i=0;i<10;i++){ if(!bossesDefeated[i]) return false; }
  return true;
}

function doPrestige(){
  // Award 1 Void Shard
  voidShards++; lsS('vr_shards', voidShards);
  prestigeCount++; lsS('vr_prestige', prestigeCount);
  // Reset crystals, perms, beams, skins ‚Äî keep essence, shards, tree, stats, seenRelics, tut, bossesDefeated
  var keep=['vr_essence','vr_shards','vr_vtree','vr_prestige','vr_stats','vr_badges','vr_seenRelics','vr_tut','vr_bossesDefeated'];
  var allKeys=['vr_crystals','vr_perm','vr_skins','vr_skin','vr_beamRanks','vr_activeBeam','vr_visitedGalaxies','vr_plevel','vr_pxp','vr_pxpnext'];
  for(var i=0;i<allKeys.length;i++){try{localStorage.removeItem(allKeys[i]);}catch{}}
  location.reload();
}

function openVoidTree(){
  var panel=document.getElementById('voidTreePanel');
  if(!panel) return;
  var cards=document.getElementById('voidTreeCards');
  var essEl=document.getElementById('voidTreeEssence');
  var shardEl=document.getElementById('voidTreeShards');
  if(essEl) essEl.textContent='üü£ '+voidEssence+' VOID ESSENCE';
  if(shardEl) shardEl.textContent='‚ö° '+voidShards+' VOID SHARDS'+(voidShards>0?' (+'+voidShards*3+'% dmg/spd/xp per shard)':'');
  if(!cards) return;
  while(cards.firstChild) cards.removeChild(cards.firstChild);

  VOID_TREE.forEach(function(def){
    var rank=vtRank(def.id);
    var cost=vtCost(def);
    var card=document.createElement('div');
    card.style.cssText='width:100%;padding:14px 18px;border-bottom:1px solid rgba(155,89,255,0.2);background:rgba(4,4,20,0.97);box-sizing:border-box;display:flex;align-items:center;gap:12px;';
    var ico=document.createElement('div');
    ico.style.cssText='font-size:26px;flex-shrink:0;width:32px;text-align:center;';
    ico.textContent=def.icon;
    var mid=document.createElement('div');
    mid.style.cssText='flex:1;min-width:0;';
    var nm=document.createElement('div');
    nm.style.cssText='font-family:Orbitron,sans-serif;font-size:11px;color:#9b59ff;letter-spacing:1px;margin-bottom:2px;';
    nm.textContent=def.name+(rank>0?' (x'+rank+')':'');
    var ds=document.createElement('div');
    ds.style.cssText='font-size:10px;color:#446;line-height:1.4;';
    ds.textContent=def.desc;
    mid.appendChild(nm); mid.appendChild(ds);
    var btn=document.createElement('button');
    btn.style.cssText='font-family:Orbitron,monospace;font-size:10px;letter-spacing:1px;padding:8px 10px;background:transparent;border:1px solid '+(voidEssence>=cost?'#9b59ff':'#334')+';color:'+(voidEssence>=cost?'#9b59ff':'#334')+';cursor:pointer;border-radius:2px;flex-shrink:0;white-space:nowrap;';
    btn.textContent=cost+' ESS';
    btn.addEventListener('pointerdown',function(){
      if(voidEssence<cost){fmsg('NOT ENOUGH VOID ESSENCE','#9b59ff');SFX.click();return;}
      voidEssence-=cost; lsS('vr_essence',voidEssence);
      voidTreeData[def.id]=(voidTreeData[def.id]||0)+1; lsS('vr_vtree',voidTreeData);
      SFX.upgrade(); fmsg(def.icon+' '+def.name+' UPGRADED','#9b59ff');
      openVoidTree();
    });
    card.appendChild(ico); card.appendChild(mid); card.appendChild(btn);
    cards.appendChild(card);
  });

  // Prestige button at bottom
  var pRow=document.createElement('div');
  pRow.style.cssText='width:100%;padding:16px 18px;box-sizing:border-box;display:flex;flex-direction:column;gap:8px;border-top:1px solid rgba(155,89,255,0.3);margin-top:8px;';
  var canPrestige=allBossesDefeated();
  var pDesc=document.createElement('div');
  pDesc.style.cssText='font-size:10px;color:'+(canPrestige?'#9b59ff':'#334')+';line-height:1.5;text-align:center;';
  pDesc.textContent=canPrestige
    ? 'All 10 bosses defeated! Prestige to earn 1 Void Shard and reset your run progress. Shards give permanent bonuses forever.'
    : 'Defeat all 10 galaxy bosses to unlock Prestige. Bosses defeated: '+Object.keys(bossesDefeated).length+' / 10';
  var pBtn=document.createElement('button');
  pBtn.style.cssText='font-family:Orbitron,monospace;font-size:12px;letter-spacing:2px;padding:14px 0;width:100%;background:transparent;border:1px solid '+(canPrestige?'#9b59ff':'#334')+';color:'+(canPrestige?'#cc88ff':'#334')+';cursor:'+(canPrestige?'pointer':'default')+';border-radius:2px;';
  pBtn.textContent=canPrestige?'‚ö° PRESTIGE ‚Äî EARN 1 VOID SHARD':'‚ö° PRESTIGE LOCKED';
  if(canPrestige){
    pBtn.addEventListener('pointerdown',function(){
      SFX.click();
      var conf=document.createElement('div');
      conf.style.cssText='position:fixed;inset:0;background:rgba(0,0,0,0.95);z-index:100;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:14px;padding:24px;box-sizing:border-box;';
      conf.innerHTML='<div style="font-family:Orbitron,sans-serif;color:#9b59ff;font-size:16px;letter-spacing:3px;text-shadow:0 0 20px #9b59ff;text-align:center;">‚ö° PRESTIGE</div>'
        +'<div style="font-size:11px;color:#668;line-height:1.6;text-align:center;max-width:280px;">This will reset your crystals, upgrades, beams and skins.<br><br>You will earn <span style="color:#cc88ff;">1 Void Shard</span> which gives permanent bonuses forever.<br><br>Void Essence, Void Tree upgrades, and lifetime stats are kept.</div>'
        +'<button id="confPresYes" style="font-family:Orbitron,monospace;font-size:12px;letter-spacing:2px;padding:12px 32px;background:transparent;border:1px solid #9b59ff;color:#9b59ff;cursor:pointer;border-radius:2px;">YES ‚Äî ASCEND</button>'
        +'<button id="confPresNo" style="font-family:Orbitron,monospace;font-size:11px;letter-spacing:2px;padding:10px 28px;background:transparent;border:1px solid #334;color:#446;cursor:pointer;border-radius:2px;">CANCEL</button>';
      document.body.appendChild(conf);
      document.getElementById('confPresYes').addEventListener('pointerdown',function(){doPrestige();});
      document.getElementById('confPresNo').addEventListener('pointerdown',function(){SFX.click();document.body.removeChild(conf);});
    });
  }
  pRow.appendChild(pDesc); pRow.appendChild(pBtn);
  cards.appendChild(pRow);

  panel.style.display='flex';
  panel._fromPause=false;
}

// ‚ïê‚ïê END VOID TREE & PRESTIGE SYSTEM ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

function getBonus(){
  const b={hull:0,dmg:1,spd:1,regen:0,pickR:1,xp:1,pierce:0,cd:1,abcd:1};
  const all=[...PERM_DEFS.SHIP,...PERM_DEFS.WEAPONS,...PERM_DEFS.ABILITIES];
  for(const d of all){const r=pRank(d.id);if(!r)continue;
    if(d.id==='p_hull')b.hull+=30*r;else if(d.id==='p_spd')b.spd*=Math.pow(1.08,r);
    else if(d.id==='p_regen')b.regen+=r;else if(d.id==='p_magnet')b.pickR*=Math.pow(1.35,r);
    else if(d.id==='p_xp')b.xp*=Math.pow(1.15,r);else if(d.id==='p_dmg')b.dmg*=Math.pow(1.10,r);
    else if(d.id==='p_cd')b.cd*=Math.pow(0.92,r);else if(d.id==='p_pierce')b.pierce+=r;
    else if(d.id==='p_abcd')b.abcd*=Math.pow(0.92,r);
  }
  var sk=SKINS.find(function(s){return s.id===activeSkin;})||SKINS[0];
  if(sk&&sk.passive) sk.passive(b);
  // Apply Void Tree + Shard bonuses
  var vb=getVoidBonus();
  b.dmg*=vb.dmg; b.cd*=vb.cd; b.xp*=vb.xp; b.hull+=vb.hull; b.pierce+=vb.pierce;
  return b;
}

// ‚îÄ‚îÄ‚îÄ VOID TREE DEFINITIONS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
var VOID_TREE = [
  {id:'crystalline_core', icon:'üíé', name:'CRYSTALLINE CORE',   cost:5,  desc:'+10% crystal gain per run',       max:5,
   apply:function(g,r){ g._crystalBonus=(g._crystalBonus||1)*Math.pow(1.10,r); }},
  {id:'hull_reinforcement',icon:'üõ°Ô∏è',name:'HULL REINFORCEMENT', cost:8,  desc:'+60 base hull permanently',        max:5,
   apply:function(g,r){ g.player.maxHp+=60*r; g.player.hp=Math.min(g.player.hp+60*r,g.player.maxHp); }},
  {id:'overclock',        icon:'‚öôÔ∏è', name:'OVERCLOCK',          cost:10, desc:'+6% fire rate permanently',        max:5,
   apply:function(g,r){ g.gun.cd*=Math.pow(0.94,r); }},
  {id:'void_hunger',      icon:'‚≠ê', name:'VOID HUNGER',         cost:12, desc:'+15% XP gain permanently',         max:5,
   apply:function(g,r){ g.player.xpMult=(g.player.xpMult||1)*Math.pow(1.15,r); }},
  {id:'shard_magnet',     icon:'üß≤', name:'SHARD MAGNET',        cost:20, desc:'Bosses drop +1 extra Void Essence', max:3,
   apply:function(g,r){ g._essenceBonus=(g._essenceBonus||0)+r; }},
  {id:'dark_matter',      icon:'üåë', name:'DARK MATTER ENGINE',  cost:30, desc:'+12% all damage permanently',      max:5,
   apply:function(g,r){ g.gun.dmg*=Math.pow(1.12,r); }},
];

function vTreeRank(id){ return voidTreeData[id]||0; }
function vTreeCost(def){ return def.cost*(1+vTreeRank(def.id)); } // gets pricier each purchase

function applyVoidTree(g){
  for(var i=0;i<VOID_TREE.length;i++){
    var r=vTreeRank(VOID_TREE[i].id);
    if(r>0) VOID_TREE[i].apply(g,r);
  }
  // Shard passive: +5% dmg and +5% speed per shard
  if(voidShards>0){
    g.gun.dmg*=Math.pow(1.05,voidShards);
    g.player.spd*=Math.pow(1.05,voidShards);
  }
}

// Track which galaxies' bosses have been defeated (for prestige unlock)
var bossesDefeated = lsG('vr_bossesDefeated', []);
function markBossDefeated(galaxyIdx){
  if(bossesDefeated.indexOf(galaxyIdx)<0){ bossesDefeated.push(galaxyIdx); lsS('vr_bossesDefeated',bossesDefeated); }
}
function allBossesDefeated(){ return bossesDefeated.length>=10; }

function doPrestige(){
  // Award 1 shard
  voidShards++;
  lsS('vr_shards', voidShards);
  prestigeCount++;
  lsS('vr_prestige', prestigeCount);
  // Reset run progress but keep essence, shards, void tree, seen relics, badges, tutorial
  var keepKeys = ['vr_essence','vr_shards','vr_vtree','vr_prestige','vr_seenRelics','vr_stats','vr_badges','vr_tut'];
  var wipeKeys = ['vr_crystals','vr_perm','vr_skins','vr_skin','vr_beamRanks','vr_activeBeam','vr_visitedGalaxies','vr_plevel','vr_pxp','vr_pxpnext','vr_bossesDefeated'];
  for(var i=0;i<wipeKeys.length;i++){ try{localStorage.removeItem(wipeKeys[i]);}catch{} }
  location.reload();
}

function openVoidTree(){
  var panel = document.getElementById('voidTreePanel');
  if(!panel) return;
  document.getElementById('menu').style.display='none';
  var cards = document.getElementById('vtCards');
  var shardEl = document.getElementById('vtShards');
  var essEl   = document.getElementById('vtEssence');
  if(shardEl) shardEl.textContent = voidShards + ' VOID ' + (voidShards===1?'SHARD':'SHARDS');
  if(essEl)   essEl.textContent   = 'üíú ' + voidEssence + ' VOID ESSENCE';
  if(!cards) { panel.style.display='flex'; return; }
  cards.innerHTML='';
  // Prestige button section
  var pb=document.createElement('div');
  pb.style.cssText='width:100%;padding:16px;border-bottom:1px solid rgba(170,0,255,0.3);background:rgba(170,0,255,0.07);box-sizing:border-box;';
  var canPrestige=allBossesDefeated();
  pb.innerHTML='<div style="font-family:Orbitron,sans-serif;font-size:13px;color:#aa00ff;letter-spacing:2px;margin-bottom:4px;">‚ú¶ VOID ASCENSION</div>'
    +'<div style="font-size:10px;color:#668;margin-bottom:10px;line-height:1.5;">'+(canPrestige?'All 10 bosses defeated. Prestige to reset your run progress and earn 1 permanent Void Shard. Shards give +5% dmg and speed each, forever.':'Defeat all 10 galaxy bosses to unlock Prestige.')+'</div>'
    +'<button id="prestigeBtn" style="font-family:Orbitron,monospace;font-size:11px;letter-spacing:2px;padding:10px 0;width:100%;background:transparent;border:1px solid '+(canPrestige?'#aa00ff':'#334')+';color:'+(canPrestige?'#aa00ff':'#334')+';cursor:'+(canPrestige?'pointer':'default')+';border-radius:2px;">'
    +(canPrestige?'‚ú¶ PRESTIGE  (+1 VOID SHARD)':'üîí DEFEAT ALL 10 BOSSES FIRST')+'</button>';
  if(canPrestige){
    pb.querySelector('#prestigeBtn').addEventListener('pointerdown',function(){
      SFX.click();
      var conf=document.createElement('div');
      conf.style.cssText='position:fixed;inset:0;background:rgba(0,0,0,0.95);z-index:200;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:14px;';
      conf.innerHTML='<div style="font-family:Orbitron,sans-serif;color:#aa00ff;font-size:16px;letter-spacing:3px;text-shadow:0 0 20px #aa00ff;">‚ú¶ VOID ASCENSION</div>'
        +'<div style="font-size:10px;color:#668;letter-spacing:1px;text-align:center;max-width:280px;line-height:1.6;">This will reset your crystals, upgrades, beams, and skins.<br><br>You will keep your Void Essence, Void Shards, Void Tree upgrades, badges, and tutorials.<br><br>You will gain <span style=\"color:#aa00ff;\">+1 Void Shard</span>.</div>'
        +'<button id="confPresYes" style="font-family:Orbitron,monospace;font-size:11px;letter-spacing:2px;padding:10px 28px;background:transparent;border:1px solid #aa00ff;color:#aa00ff;cursor:pointer;border-radius:2px;">‚ú¶ ASCEND</button>'
        +'<button id="confPresNo" style="font-family:Orbitron,monospace;font-size:11px;letter-spacing:2px;padding:10px 28px;background:transparent;border:1px solid #334;color:#446;cursor:pointer;border-radius:2px;">CANCEL</button>';
      document.body.appendChild(conf);
      document.getElementById('confPresYes').addEventListener('pointerdown',function(){ doPrestige(); });
      document.getElementById('confPresNo').addEventListener('pointerdown',function(){ SFX.click(); document.body.removeChild(conf); });
    });
  }
  cards.appendChild(pb);
  // Void Tree upgrades
  for(var i=0;i<VOID_TREE.length;i++){(function(def){
    var rank=vTreeRank(def.id);
    var cost=vTreeCost(def);
    var maxed=rank>=def.max;
    var canAfford=voidEssence>=cost&&!maxed;
    var card=document.createElement('div');
    card.style.cssText='width:100%;padding:14px 16px;border-bottom:1px solid rgba(155,89,255,0.12);background:'+(rank>0?'rgba(155,89,255,0.05)':'transparent')+';box-sizing:border-box;display:flex;align-items:center;gap:12px;';
    var ico=document.createElement('div');
    ico.style.cssText='font-size:22px;flex-shrink:0;width:28px;text-align:center;';
    ico.textContent=def.icon;
    card.appendChild(ico);
    var mid=document.createElement('div');mid.style.flex='1';mid.style.minWidth='0';
    var nm=document.createElement('div');nm.style.cssText='font-family:Orbitron,sans-serif;font-size:11px;color:'+(rank>0?'#cc88ff':'#557')+';letter-spacing:1px;margin-bottom:2px;';nm.textContent=def.name+(rank>0?' ('+rank+'/'+def.max+')':'');
    var ds=document.createElement('div');ds.style.cssText='font-size:10px;color:#446;line-height:1.4;';ds.textContent=def.desc;
    mid.appendChild(nm);mid.appendChild(ds);card.appendChild(mid);
    var btn=document.createElement('button');
    btn.style.cssText='font-family:Orbitron,monospace;font-size:10px;padding:6px 10px;background:transparent;border:1px solid '+(maxed?'#334':canAfford?'#9b59ff':'#334')+';color:'+(maxed?'#334':canAfford?'#9b59ff':'#334')+';cursor:'+(canAfford?'pointer':'default')+';border-radius:2px;flex-shrink:0;';
    btn.textContent=maxed?'MAX':cost+' üíú';
    if(canAfford){
      btn.addEventListener('pointerdown',function(){
        SFX.upgrade();
        voidEssence-=cost; lsS('vr_essence',voidEssence);
        voidTreeData[def.id]=(voidTreeData[def.id]||0)+1; lsS('vr_vtree',voidTreeData);
        fmsg(def.icon+' '+def.name+' UPGRADED','#9b59ff');
        openVoidTree();
      });
    }
    card.appendChild(btn);
    cards.appendChild(card);
  })(VOID_TREE[i]);}
  panel.style.display='flex';
}

// ‚îÄ‚îÄ‚îÄ PERSISTENT LEVEL BONUSES ‚îÄ‚îÄ‚îÄ
function applyPersistLevelBonuses(g){
  var lvl=g.player.level-1; // 0-based
  if(lvl<=0)return;
  g.player.maxHp+=8*lvl;
  g.player.hp=Math.min(g.player.hp,g.player.maxHp);
  g.gun.dmg*=Math.pow(1.03,lvl);
}
function persistLevelUp(g){
  // Called each time player levels up ‚Äî save to storage
  persistLevel=g.player.level;
  persistXP=g.player.xp;
  persistXPNext=g.player.xpNext;
  lsS('vr_plevel',persistLevel);
  lsS('vr_pxp',persistXP);
  lsS('vr_pxpnext',persistXPNext);
}

// ‚îÄ‚îÄ‚îÄ RELIC SYSTEM ‚îÄ‚îÄ‚îÄ
var RELIC_CAP = 5;
var seenRelics = lsG('vr_seenRelics', []);
function markRelicSeen(id){ if(seenRelics.indexOf(id)<0){seenRelics.push(id);lsS('vr_seenRelics',seenRelics);} }

var RELICS = [
  // Combat
  {id:'void_crystal',  icon:'üíé', name:'VOID CRYSTAL',    galaxy:0,
   desc:'Asteroids drop 2√ó gems',
   apply:function(g,stacks){ g._relicGemMult=(g._relicGemMult||1)*Math.pow(1.8,stacks); },
   stack:true},
  {id:'homing_chip',   icon:'üéØ', name:'HOMING CHIP',     galaxy:1,
   desc:'All bullets gain slight homing',
   apply:function(g,stacks){ g.gun.homing=true; },
   stack:false},
  {id:'ring_resonance',icon:'üîµ', name:'RING RESONANCE',  galaxy:2,
   desc:'Kills occasionally pulse a damage ring',
   apply:function(g,stacks){ g._ringResonance=(g._ringResonance||0)+stacks; },
   stack:true},
  {id:'spiral_core',   icon:'üåÄ', name:'SPIRAL CORE',     galaxy:3,
   desc:'15% kill chance for bonus XP orb',
   apply:function(g,stacks){ g._spiralCore=(g._spiralCore||0)+Math.min(stacks*0.15,0.45); },
   stack:true},
  {id:'titan_plating', icon:'üõ°Ô∏è', name:'TITAN PLATING',   galaxy:4,
   desc:'Take 12% less damage per stack',
   apply:function(g,stacks){ g._dmgReduction=(1-Math.pow(0.88,stacks)); },
   stack:true},
  {id:'sniper_mod',    icon:'‚ö°', name:'SNIPER MODULE',   galaxy:5,
   desc:'Every 8th shot is a free piercing rail bolt',
   apply:function(g,stacks){ g._sniperMod=(g._sniperMod||0)+stacks; },
   stack:true},
  {id:'parasite',      icon:'ü¶†', name:'PARASITE SWARM',  galaxy:6,
   desc:'Kills have 10% chance to spawn a combat drone',
   apply:function(g,stacks){ g._parasiteChance=Math.min(0.4,(g._parasiteChance||0)+stacks*0.10); },
   stack:true},
  {id:'ghost_protocol',icon:'üëª', name:'GHOST PROTOCOL',  galaxy:7,
   desc:'Dash leaves a damaging afterimage clone',
   apply:function(g,stacks){ g._ghostProtocol=(g._ghostProtocol||0)+stacks; },
   stack:true},
  {id:'overcharge',    icon:'üîã', name:'OVERCHARGE',      galaxy:8,
   desc:'Beam ability starts each run pre-charged',
   apply:function(g,stacks){ // shockwave relic ‚Äî bonus radius
g._shockwaveBonusR=(g._shockwaveBonusR||0)+stacks*40; },
   stack:true},
  {id:'singularity_core',icon:'‚≠ê',name:'SINGULARITY CORE',galaxy:9,
   desc:'+25% to all damage per stack',
   apply:function(g,stacks){ g.gun.dmg*=Math.pow(1.25,stacks); },
   stack:true},
  // Bonus pool relics (any boss can drop these)
  {id:'blood_engine',  icon:'ü©∏', name:'BLOOD ENGINE',    galaxy:0,
   desc:'Killing enemies heals 3 hull',
   apply:function(g,stacks){ g._lifeSteal=(g._lifeSteal||0)+stacks*3; },
   stack:true},
  {id:'void_magnet',   icon:'üß≤', name:'VOID MAGNET',     galaxy:0,
   desc:'+80% crystal pickup range',
   apply:function(g,stacks){ g.player.pickR*=Math.pow(1.8,stacks); },
   stack:true},
  {id:'plasma_surge',  icon:'üî•', name:'PLASMA SURGE',    galaxy:0,
   desc:'+20% weapon damage',
   apply:function(g,stacks){ g.gun.dmg*=Math.pow(1.2,stacks); },
   stack:true},
  {id:'rapid_fire',    icon:'‚öôÔ∏è', name:'RAPID FIRE',      galaxy:0,
   desc:'-15% fire cooldown',
   apply:function(g,stacks){ g.gun.cd*=Math.pow(0.85,stacks); },
   stack:true},
  {id:'crystal_heart', icon:'üíú', name:'CRYSTAL HEART',   galaxy:0,
   desc:'+80 max hull + full heal',
   apply:function(g,stacks){ g.player.maxHp+=80*stacks;g.player.hp=Math.min(g.player.hp+80*stacks,g.player.maxHp); },
   stack:true},
];

// Boss relic pools ‚Äî weighted toward thematic relics for that galaxy
var BOSS_RELIC_POOLS=[
  ['void_crystal','blood_engine','void_magnet','plasma_surge','crystal_heart'], // G1 Harvester
  ['homing_chip','rapid_fire','plasma_surge','blood_engine','void_crystal'],    // G2 Seeker
  ['ring_resonance','plasma_surge','rapid_fire','void_magnet','blood_engine'],  // G3 Corona
  ['spiral_core','blood_engine','rapid_fire','ring_resonance','plasma_surge'],  // G4 Vortex
  ['titan_plating','crystal_heart','blood_engine','void_magnet','rapid_fire'],  // G5 Obliterator
  ['sniper_mod','plasma_surge','rapid_fire','homing_chip','ring_resonance'],    // G6 Archon
  ['parasite','blood_engine','spiral_core','void_crystal','titan_plating'],     // G7 Void Father
  ['ghost_protocol','rapid_fire','plasma_surge','sniper_mod','void_magnet'],    // G8 Reaper
  ['overcharge','rapid_fire','plasma_surge','crystal_heart','titan_plating'],   // G9 Annihilator
  ['singularity_core','plasma_surge','rapid_fire','blood_engine','homing_chip'],// G10 Singularity
];

function pickRelicForGalaxy(galaxyIdx){
  var pool=BOSS_RELIC_POOLS[Math.min(galaxyIdx,BOSS_RELIC_POOLS.length-1)];
  // 60% chance primary relic (index 0), 40% chance random from rest
  var id=Math.random()<0.6?pool[0]:pool[1+Math.floor(Math.random()*(pool.length-1))];
  return RELICS.find(function(r){return r.id===id;})||RELICS[0];
}

function applyRelics(g){
  // Reset relic-driven state
  g._relicGemMult=1;g._ringResonance=0;g._spiralCore=0;g._dmgReduction=0;
  g._sniperMod=0;g._parasiteChance=0;g._ghostProtocol=0;g._lifeSteal=0;
  // Count stacks per relic
  var counts={};
  for(var i=0;i<g.relics.length;i++){var rid=g.relics[i].id;counts[rid]=(counts[rid]||0)+1;}
  // Apply each unique relic with its stack count
  var seen={};
  for(var i=0;i<g.relics.length;i++){
    var r=g.relics[i];
    if(seen[r.id])continue;seen[r.id]=true;
    r.apply(g,counts[r.id]);
  }
}

function collectRelic(g,relic){
  if(g.relics.length>=RELIC_CAP){fmsg('RELIC CAP REACHED ('+RELIC_CAP+')','#ff3366');return;}
  markRelicSeen(relic.id);
  var existing=g.relics.filter(function(r){return r.id===relic.id;});
  if(existing.length>0&&!relic.stack){fmsg(relic.icon+' '+relic.name+' ALREADY ACTIVE','#9b59ff');return;}
  g.relics.push(relic);
  applyRelics(g);
  updateRelicHUD(g);
  SFX.levelUp&&SFX.levelUp();
  // Show notif
  var el=document.getElementById('relicNotif');
  if(el){
    el.innerHTML=relic.icon+' <span style="color:#9b59ff">'+relic.name+'</span><br><span style="font-size:8px;color:#668">'+relic.desc+'</span>';
    el.style.opacity='1';el.style.transform='translateX(-50%) translateY(0)';
    clearTimeout(el._t);
    el._t=setTimeout(function(){el.style.opacity='0';el.style.transform='translateX(-50%) translateY(-20px)';},3000);
  }
  fmsg(relic.icon+' RELIC: '+relic.name,'#9b59ff');
}

function updateRelicHUD(g){
  var row=document.getElementById('relicRow');
  if(!row)return;row.innerHTML='';
  for(var i=0;i<g.relics.length;i++){
    var r=g.relics[i],count=g.relics.filter(function(x){return x.id===r.id;}).length;
    // Only show one icon per unique relic
    if(g.relics.indexOf(r)!==g.relics.map(function(x){return x.id;}).indexOf(r.id))continue;
    var d=document.createElement('div');d.className='relic-hud';d.title=r.name+': '+r.desc;
    d.textContent=r.icon+(count>1?'√ó'+count:'');row.appendChild(d);
  }
}

// ‚îÄ‚îÄ‚îÄ RUN UPGRADES ‚îÄ‚îÄ‚îÄ
const UPGRADES=[
  {id:'dmg',   name:'PLASMA BOOST',  icon:'üî´',desc:'+30% plasma damage',      apply:function(g){g.gun.dmg*=1.3;}},
  {id:'spd',   name:'TURBO CHARGE',  icon:'‚ö°',desc:'-20% fire cooldown',       apply:function(g){g.gun.cd*=0.8;}},
  {id:'pierce',name:'PHASE SHOT',    icon:'üéØ',desc:'Shots pierce +1 enemy',   apply:function(g){g.gun.pierce++;}},
  {id:'mvspd', name:'ION SURGE',     icon:'üöÄ',desc:'+15% engine power',        apply:function(g){g.player.spd*=1.15;}},
  {id:'maxhp', name:'HULL UPGRADE',  icon:'üõ°Ô∏è',desc:'+50 max hull',            apply:function(g){g.player.maxHp+=50;g.player.hp=Math.min(g.player.hp+50,g.player.maxHp);}},
  {id:'regen', name:'NANO-BOTS',     icon:'üîß',desc:'Repair 1 hull/sec',        apply:function(g){g.player.regen++;}},
  {id:'orbit', name:'DEFENSE GRID',  icon:'üåÄ',desc:'Rotating energy shields', apply:function(g){if(!g.orbit.active)g.orbit.active=true;else{g.orbit.dmg*=1.3;g.orbit.blades=Math.min(4,g.orbit.blades+1);}}},
  {id:'nova',  name:'NOVA BURST',    icon:'üí•',desc:'Expanding shockwave, grows with each upgrade', apply:function(g){if(!g.nova.active){g.nova.active=true;g.nova.dmg=80;g.nova.r=120;g.nova.cd=3.5;}else{g.nova.dmg*=1.5;g.nova.r=Math.min(400,g.nova.r+40);g.nova.cd=Math.max(1.5,g.nova.cd*.9);}}},
  {id:'magnet',name:'TRACTOR FIELD', icon:'üß≤',desc:'+60% crystal pull range', apply:function(g){g.player.pickR*=1.6;}},
  {id:'spread',name:'SCATTER SHOT',  icon:'üåü',desc:'Fire extra spread bolts', apply:function(g){g.gun.spread=Math.min(2,g.gun.spread+1);}},
  {id:'escort',name:'ESCORT WING',   icon:'üõ∏',desc:'Deploys gunship that fires missiles', apply:function(g){
    if(!g.escorts)g.escorts=[];
    var rank=(g._upRanks&&g._upRanks.escort||0);
    g.escorts.push({angle:Math.random()*Math.PI*2,orbitR:60+rank*10,shootT:0,shootCd:1.8,r:10,dmg:g.gun.dmg*0.7});
  }},
];

// ‚îÄ‚îÄ‚îÄ WORLD PICKUPS ‚îÄ‚îÄ‚îÄ
const PICKUPS=[
  {id:'shield',icon:'üõ°Ô∏è',label:'AEGIS FIELD',    color:'#33aaff',dur:8, onGet:function(g){g.player.shielded=true;},   onEnd:function(g){g.player.shielded=false;}},
  {id:'rage',  icon:'‚òÑÔ∏è', label:'SOLAR FLARE',   color:'#ff6a00',dur:10,onGet:function(g){g.rageActive=true;},        onEnd:function(g){g.rageActive=false;}},
  {id:'speed', icon:'üöÄ', label:'HYPERDRIVE',    color:'#39ff8a',dur:8, onGet:function(g){g.speedActive=true;},       onEnd:function(g){g.speedActive=false;}},
  {id:'freeze',icon:'‚ùÑÔ∏è', label:'TIME DILATION', color:'#88ddff',dur:0, onGet:function(g){g.enemies.forEach(function(e){if(!e.isBoss)e.frozen=3;});}},
  {id:'nuke',  icon:'‚ò¢Ô∏è', label:'WARP NUKE',     color:'#ccff33',dur:0, onGet:function(g){var p=g.player;for(var i=g.enemies.length-1;i>=0;i--){var e=g.enemies[i];if(!e.isBoss&&dst(p,e)<340){burst(g,e.x,e.y,e.color,14,120);addOrb(g,e);g.enemies.splice(i,1);g.kills++;}}}},
  {id:'adr',   icon:'‚ö°', label:'OVERDRIVE',     color:'#ffcc22',dur:12,onGet:function(g){g.adrActive=true;},         onEnd:function(g){g.adrActive=false;}},
  {id:'vamp',  icon:'ü©∏', label:'VOID DRAIN',    color:'#cc44ff',dur:15,onGet:function(g){g.vampActive=true;},        onEnd:function(g){g.vampActive=false;}},
  {id:'cryst', icon:'üíé', label:'+15 CRYSTALS',  color:'#00f5ff',dur:0, onGet:function(g){crystals+=15;lsS('vr_crystals',crystals);fmsg('üíé +15 CRYSTALS','#00f5ff');}},
  {id:'gemx2', icon:'üí†', label:'GEM RUSH x2',   color:'#00ffcc',dur:12,onGet:function(g){g.gemMult=2;},             onEnd:function(g){g.gemMult=1;}},
  {id:'gemx3', icon:'üî∑', label:'GEM SURGE x3',  color:'#44ddff',dur:8, onGet:function(g){g.gemMult=3;},             onEnd:function(g){g.gemMult=1;}},
  {id:'gemx5', icon:'üí´', label:'CRYSTAL NOVA x5',color:'#ffffff',dur:5,onGet:function(g){g.gemMult=5;},             onEnd:function(g){g.gemMult=1;}},
  {id:'hp25',  icon:'‚ù§Ô∏è', label:'+25 HULL',       color:'#ff6688',dur:0, onGet:function(g){g.player.hp=Math.min(g.player.maxHp,g.player.hp+25);fmsg('‚ù§Ô∏è +25 HULL','#ff6688');}},
  {id:'hp50',  icon:'üíó', label:'+50 HULL',       color:'#ff4466',dur:0, onGet:function(g){g.player.hp=Math.min(g.player.maxHp,g.player.hp+50);fmsg('üíó +50 HULL','#ff4466');}},
  {id:'hpfull',icon:'üíñ', label:'FULL REPAIR',    color:'#ff2244',dur:0, onGet:function(g){g.player.hp=g.player.maxHp;fmsg('üíñ HULL RESTORED','#ff2244');}},
];

// ‚îÄ‚îÄ‚îÄ ABILITIES (all capped at 5) ‚îÄ‚îÄ‚îÄ
const ABILITIES=[
  {id:'dash', icon:'üí®', label:'WARP DASH', color:'#39ff8a', baseCd:5,
    use:function(g){
      var rank=pRank('p_dash'), p=g.player, a=p.aimAngle;
      var dashes = rank>=4?3:rank>=1?2:1;
      p.dashQ=[];
      for(var i=0;i<dashes;i++) p.dashQ.push({vx:Math.cos(a)*(18-i*2),vy:Math.sin(a)*(18-i*2),frames:16,delay:i*9});
      // Invincibility scaling
      var invDur = [0.4, 0.8, 1.2, 1.8, 2.5][Math.min(rank,4)];
      p.invincible = invDur;
      // Afterimage particles
      var count = 8+rank*14;
      for(var i=0;i<count;i++) g.particles.push({x:p.x,y:p.y,vx:(Math.random()-.5)*80,vy:(Math.random()-.5)*80,life:.35+rank*.1,sz:3+rank,color:'#39ff8a'});
      // Phase clone at rank 3+
      if(rank>=2){
        for(var ci=0;ci<rank-1;ci++){
          var cloneAngle = a + (ci%2===0?1:-1)*(0.4+ci*.2);
          for(var pi=0;pi<8;pi++) g.particles.push({x:p.x,y:p.y,vx:Math.cos(cloneAngle+Math.random()*.5)*100,vy:Math.sin(cloneAngle+Math.random()*.5)*100,life:.5,sz:4,color:'rgba(100,255,180,0.6)'});
        }
      }
      if(rank>=4) fmsg('FULL PHASE','#39ff8a');
    }
  },
  {id:'turret', icon:'üí´', label:'SHOCKWAVE', color:'#00f5ff', baseCd:14,
    use:function(g){
      var rank=pRank('p_shockwave');
      var p=g.player;
      var baseR=[260,340,420,500,700][Math.min(rank,4)];
      var r=baseR+(g._shockwaveBonusR||0);
      var stunDur=5;
      var dmg=rank>=2?(rank>=4?180:90):0;
      var isMega=rank>=4;
      function doWave(delay,waveR){
        setTimeout(function(){
          if(!G)return;
          // Stun all enemies in radius
          for(var i=0;i<g.enemies.length;i++){
            var e=g.enemies[i];
            if(!e.isBoss&&dst(p,e)<waveR){
              e.frozen=stunDur;
              if(dmg>0) hitE(g,e,dmg);
            }
          }
          burst(g,p.x,p.y,'#00f5ff',isMega?40:22,waveR*0.6);
          g.particles.push({type:'ring',x:p.x,y:p.y,radius:0,maxR:waveR,life:0.55,maxLife:0.55,color:'#00f5ff'});
          SFX.ability&&SFX.ability();
        },delay);
      }
      doWave(0, r);
      if(rank>=3) doWave(280, r*0.75); // double pulse at rank 3+
      var names=['SHOCKWAVE','SHOCKWAVE+','SHOCKWAVE++','DUAL SHOCKWAVE','üí´ MEGA SHOCKWAVE'];
      fmsg(names[Math.min(rank,4)],'#00f5ff');
    }
  },
  {id:'bomb', icon:'üí•', label:'NOVA COLLAPSE', color:'#ff3366', baseCd:10,
    use:function(g){
      var rank=pRank('p_bomb'), p=g.player;
      var r=[200,280,360,440,560][Math.min(rank,4)];
      var dmgBase=[180,240,300,380,520][Math.min(rank,4)];
      if(rank>=4){
        // Supernova
        g.supernovaActive={radius:10,maxR:r,life:1.8,maxLife:1.8};
        fmsg('SUPERNOVA','#ff6a00');
      } else if(rank>=3){
        // Shockwave rings + implosion pull then explode
        for(var ri=0;ri<3;ri++){
          (function(ri2){setTimeout(function(){
            if(!G)return;
            g.particles.push({type:'ring',x:p.x,y:p.y,radius:ri2*60,maxR:r,life:.7,maxLife:.7,color:'#9b59ff'});
          },ri2*120);})(ri);
        }
        var gref=g;
        for(var ei=0;ei<g.enemies.length;ei++){var e=g.enemies[ei];if(dst(p,e)<r){var ang=Math.atan2(p.y-e.y,p.x-e.x);e.x+=Math.cos(ang)*80;e.y+=Math.sin(ang)*80;}}
        setTimeout(function(){if(!G)return;for(var i=gref.enemies.length-1;i>=0;i--){var e=gref.enemies[i],d=dst(p,e);if(d<r){var dm=dmgBase*(1-d/(r+50));e.hp-=dm;e.flashTimer=.15;if(e.hp<=0&&!e.isBoss){burst(gref,e.x,e.y,e.color,14,120);addOrb(gref,e);gref.enemies.splice(i,1);gref.kills++;}}}},300);
        fmsg('VOID IMPLOSION','#9b59ff');
      } else if(rank>=2){
        // Gravity pull then blast
        for(var ei=0;ei<g.enemies.length;ei++){var e=g.enemies[ei];if(dst(p,e)<r){var ang=Math.atan2(e.y-p.y,e.x-p.x);e.x-=Math.cos(ang)*100;e.y-=Math.sin(ang)*100;}}
        var gref2=g;
        setTimeout(function(){if(!G)return;for(var i=gref2.enemies.length-1;i>=0;i--){var e=gref2.enemies[i],d=dst(p,e);if(d<r){var dm=dmgBase*(1-d/(r+50));e.hp-=dm;e.flashTimer=.15;if(e.hp<=0&&!e.isBoss){burst(gref2,e.x,e.y,e.color,14,120);addOrb(gref2,e);gref2.enemies.splice(i,1);gref2.kills++;}}}},280);
        g.particles.push({type:'ring',x:p.x,y:p.y,radius:0,maxR:r,life:.6,maxLife:.6,color:'#9b59ff'});
        fmsg('GRAVITY PULL','#9b59ff');
      } else {
        // Basic blast
        for(var i=g.enemies.length-1;i>=0;i--){var e=g.enemies[i],d=dst(p,e);if(d<r){var dm=dmgBase*(1-d/(r+50));e.hp-=dm;e.flashTimer=.15;if(e.hp<=0&&!e.isBoss){burst(g,e.x,e.y,e.color,12,100);addOrb(g,e);g.enemies.splice(i,1);g.kills++;}}}
      }
      g.particles.push({type:'ring',x:p.x,y:p.y,radius:0,maxR:r,life:.55,maxLife:.55,color:'#ff3366'});
      burst(g,p.x,p.y,'#ff6a00',25+rank*25,200+rank*100);
    }
  },
  {id:'heal', icon:'üåü', label:'STELLAR REBIRTH', color:'#cc44ff', baseCd:20,
    use:function(g){
      var rank=pRank('p_heal'), p=g.player;
      var healAmt=[80,100,130,160,p.maxHp][Math.min(rank,4)];
      p.hp=Math.min(p.maxHp,p.hp+healAmt);
      // Refill shield fully on use
      if(p.shield) p.shield.hp=p.shield.maxHp;
      // Rank 4: full resurrect + temp invincible
      if(rank>=4){ p.hp=p.maxHp; p.invincible=2.5; fmsg('RESURRECTION','#cc44ff'); }
      burst(g,p.x,p.y,'#cc44ff',20+rank*18,100+rank*70);
    }
  },
];

// Shield system ‚Äî permanent shield added by heal ability ranks
function initShield(player){
  var rank=pRank('p_heal');
  if(rank<1){ player.shield=null; return; }
  var maxHps=[0,80,160,200,300,500];
  var regenRates=[0,4,8,12,18,28]; // hp/sec
  var regenDelays=[0,5,4,3,2,1];   // seconds before regen kicks in
  var maxHp=maxHps[Math.min(rank,5)];
  player.shield={ hp:maxHp, maxHp:maxHp, regen:regenRates[rank], regenDelay:regenDelays[rank], regenTimer:0 };
}
function updateShieldHUD(p){
  var lbl=document.getElementById('shieldLbl'),bar=document.getElementById('shieldBar'),fill=document.getElementById('shieldF');
  if(!lbl)return;
  if(p.shield){lbl.style.display='block';bar.style.display='block';fill.style.width=(Math.max(0,p.shield.hp/p.shield.maxHp)*100)+'%';}
  else{lbl.style.display='none';bar.style.display='none';}
}

// ‚îÄ‚îÄ‚îÄ GALAXY BOSSES ‚îÄ‚îÄ‚îÄ
var GALAXY_BOSSES=[

  // G0 ‚îÄ‚îÄ CARRIER MOTHERSHIP (Drift Sector)
  // Design: giant multi-tier UFO saucer
  // Mechanics: fan spread + deploys fighter drones each burst
  {name:'CARRIER MOTHERSHIP',color:'#00f5ff',r:52,baseHp:25000,dmg:18,baseSpd:42,xpVal:120,coins:40,shootCd:1.4,
   shoot:function(g,e,p){
     var a=Math.atan2(p.y-e.y,p.x-e.x);
     for(var i=-3;i<=3;i++)g.bullets.push({x:e.x,y:e.y,vx:Math.cos(a+i*.2)*270,vy:Math.sin(a+i*.2)*270,dmg:e.dmg,size:8,pierce:0,pc:0,color:e.color,life:3,isEnemy:true,homing:false});
     e._droneTimer=(e._droneTimer||0)+1;
     if(e._droneTimer%3===0){var gd=(GALAXIES[g.galaxy]||GALAXIES[0]).diff,da=Math.random()*Math.PI*2;g.enemies.push({x:e.x+Math.cos(da)*80,y:e.y+Math.sin(da)*80,r:9,spd:150*gd,hp:30*gd,maxHp:30*gd,dmg:8,color:'#44ddff',xpVal:2,flashTimer:0,frozen:0,isBoss:false,spinAngle:0,shootTimer:0,typeIdx:0,galaxy:0});}
   }},

  // G1 ‚îÄ‚îÄ VOID LEVIATHAN (Leviathan Field)
  // Design: massive eel head with phasing body
  // Mechanics: phase-charge dash, homing slime trail, tail whip burst
  {name:'VOID LEVIATHAN',color:'#8844ff',r:52,baseHp:60000,dmg:26,baseSpd:75,xpVal:140,coins:45,shootCd:2.0,
   shoot:function(g,e,p){
     e._levPhase=(e._levPhase||0)%3;
     if(e._levPhase===0){
       // Phase charge ‚Äî dash at player, leave slime trail
       e._phaseDir=Math.atan2(p.y-e.y,p.x-e.x);e._phasing=true;e._phaseTime=0.7;
       for(var i=0;i<6;i++){var da=e._phaseDir+(i-2.5)*.18;g.bullets.push({x:e.x,y:e.y,vx:Math.cos(da)*160,vy:Math.sin(da)*160,dmg:e.dmg*.6,size:9,pierce:0,pc:0,color:'#cc88ff',life:5,isEnemy:true,homing:true,target:p});}
       fmsg('LEVIATHAN PHASE CHARGE','#8844ff');
     } else if(e._levPhase===1){
       // Tail whip ‚Äî ring burst
       for(var i=0;i<12;i++){var ang=i/12*Math.PI*2;g.bullets.push({x:e.x,y:e.y,vx:Math.cos(ang)*240,vy:Math.sin(ang)*240,dmg:e.dmg*.7,size:8,pierce:0,pc:0,color:'#aa66ff',life:3.5,isEnemy:true,homing:false});}
     } else {
       // Serpent spit ‚Äî aimed triple spread
       var a=Math.atan2(p.y-e.y,p.x-e.x);
       for(var i=-2;i<=2;i++)g.bullets.push({x:e.x,y:e.y,vx:Math.cos(a+i*.25)*300,vy:Math.sin(a+i*.25)*300,dmg:e.dmg,size:10,pierce:0,pc:0,color:e.color,life:4,isEnemy:true,homing:false});
     }
     e._levPhase++;
   }},

  // G2 ‚îÄ‚îÄ AI WAR CORE (Machine Remnant)
  // Design: octagonal command hub with inner grid
  // Mechanics: precision burst, shields minions, drone formation spawn
  {name:'AI WAR CORE',color:'#4499ff',r:52,baseHp:120000,dmg:22,baseSpd:32,xpVal:160,coins:50,shootCd:1.6,
   shoot:function(g,e,p){
     e._aiPhase=(e._aiPhase||0)%3;
     if(e._aiPhase===0){
       // Precision triple burst
       var a=Math.atan2(p.y-e.y,p.x-e.x);
       for(var b=0;b<3;b++){(function(delay){setTimeout(function(){if(!g.bossAlive)return;g.bullets.push({x:e.x,y:e.y,vx:Math.cos(a)*460,vy:Math.sin(a)*460,dmg:e.dmg,size:10,pierce:0,pc:0,color:'#4499ff',life:2.5,isEnemy:true,homing:false});},delay*160);})(b);}
     } else if(e._aiPhase===1){
       // Formation spawn ‚Äî 3 hexagon drones in triangle
       var gd=(GALAXIES[g.galaxy]||GALAXIES[0]).diff;
       for(var i=0;i<3;i++){var da=i/3*Math.PI*2;g.enemies.push({x:e.x+Math.cos(da)*100,y:e.y+Math.sin(da)*100,r:14,spd:130*gd,hp:60*gd,maxHp:60*gd,dmg:12,color:'#4499ff',xpVal:4,flashTimer:0,frozen:0,isBoss:false,spinAngle:0,shootTimer:0,typeIdx:0,galaxy:2});}
       // Shield them
       for(var i=0;i<g.enemies.length;i++){if(!g.enemies[i].isBoss)g.enemies[i].invincible=3;}
       fmsg('FORMATION SHIELD ACTIVE','#4499ff');
     } else {
       // Scan beam ‚Äî high speed aimed
       var a=Math.atan2(p.y-e.y,p.x-e.x);
       g.bullets.push({x:e.x,y:e.y,vx:Math.cos(a)*650,vy:Math.sin(a)*650,dmg:e.dmg*1.8,size:14,pierce:3,pc:0,color:'#88ccff',life:2,isEnemy:true,homing:false});
       fmsg('SCAN BEAM','#4499ff');
     }
     e._aiPhase++;
   }},

  // G3 ‚îÄ‚îÄ ASTEROID TITAN (Meteor Storm Belt)
  // Design: massive jagged rock with parasite eyes
  // Mechanics: spinning rock ring, meteor barrage, impact shockwave
  {name:'ASTEROID TITAN',color:'#ff8833',r:58,baseHp:200000,dmg:20,baseSpd:28,xpVal:180,coins:55,shootCd:1.8,
   shoot:function(g,e,p){
     e._titanPhase=(e._titanPhase||0)%3;
     if(e._titanPhase===0){
       // Spinning rock ring
       e.ringAngle=(e.ringAngle||0)+0.55;
       for(var i=0;i<10;i++){var ang=e.ringAngle+i/10*Math.PI*2;g.bullets.push({x:e.x,y:e.y,vx:Math.cos(ang)*230,vy:Math.sin(ang)*230,dmg:e.dmg,size:12,pierce:0,pc:0,color:'#ff9944',life:4,isEnemy:true,homing:false});}
     } else if(e._titanPhase===1){
       // Meteor barrage
       var a=Math.atan2(p.y-e.y,p.x-e.x);
       for(var i=0;i<10;i++){var ang=a+(Math.random()-.5)*1.6;g.bullets.push({x:e.x,y:e.y,vx:Math.cos(ang)*(130+Math.random()*160),vy:Math.sin(ang)*(130+Math.random()*160),dmg:e.dmg*1.2,size:14,pierce:0,pc:0,color:'#cc5500',life:3.5,isEnemy:true,homing:false});}
     } else {
       // Seismic shockwave ‚Äî slow wide ring
       for(var i=0;i<16;i++){var ang=i/16*Math.PI*2;g.bullets.push({x:e.x,y:e.y,vx:Math.cos(ang)*140,vy:Math.sin(ang)*140,dmg:e.dmg*1.5,size:16,pierce:0,pc:0,color:'#ff6600',life:5,isEnemy:true,homing:false});}
       fmsg('SEISMIC SHOCKWAVE','#ff8833');
     }
     e._titanPhase++;
   }},

  // G4 ‚îÄ‚îÄ GAS COLOSSUS (Bio-Nebula)
  // Design: pulsing giant membrane sac with 8 tentacles
  // Mechanics: spore burst + poison clouds at player, tentacle sweep
  {name:'GAS COLOSSUS',color:'#44ff88',r:58,baseHp:320000,dmg:16,baseSpd:25,xpVal:200,coins:60,shootCd:2.0,
   shoot:function(g,e,p){
     e._gasPhase=(e._gasPhase||0)%3;
     if(e._gasPhase===0){
       // Spore burst ‚Äî large spread
       var a=Math.atan2(p.y-e.y,p.x-e.x);
       for(var i=0;i<16;i++){var ang=a+i/16*Math.PI*2*.9+(Math.random()-.5)*.2;g.bullets.push({x:e.x,y:e.y,vx:Math.cos(ang)*190,vy:Math.sin(ang)*190,dmg:e.dmg,size:8,pierce:0,pc:0,color:'#44ff88',life:4.5,isEnemy:true,homing:false});}
     } else if(e._gasPhase===1){
       // Poison cloud volley at player
       if(!g.poisonClouds)g.poisonClouds=[];
       for(var i=0;i<3;i++)g.poisonClouds.push({x:p.x+(Math.random()-.5)*120,y:p.y+(Math.random()-.5)*120,r:80,life:8,maxLife:8});
       fmsg('TOXIC CLOUD BARRAGE','#44ff88');
     } else {
       // Tentacle slam ‚Äî 4 aimed homing blobs
       for(var i=0;i<4;i++){var da=Math.atan2(p.y-e.y,p.x-e.x)+(i-1.5)*.4;g.bullets.push({x:e.x,y:e.y,vx:Math.cos(da)*200,vy:Math.sin(da)*200,dmg:e.dmg*1.5,size:13,pierce:0,pc:0,color:'#22cc66',life:5,isEnemy:true,homing:true,target:p});}
       fmsg('TENTACLE SLAM','#44ff88');
     }
     e._gasPhase++;
   }},

  // G5 ‚îÄ‚îÄ CRYO DREADNOUGHT (Cryo Ring)
  // Design: angular ice cruiser with crystal spike extensions
  // Mechanics: freeze ray, ice shard spray, blizzard ring
  {name:'CRYO DREADNOUGHT',color:'#88ddff',r:56,baseHp:480000,dmg:26,baseSpd:33,xpVal:220,coins:65,shootCd:1.8,
   shoot:function(g,e,p){
     e._cryoPhase=(e._cryoPhase||0)%3;
     if(e._cryoPhase===0){
       // Freeze ray ‚Äî slow homing
       var a=Math.atan2(p.y-e.y,p.x-e.x);
       g.bullets.push({x:e.x,y:e.y,vx:Math.cos(a)*180,vy:Math.sin(a)*180,dmg:e.dmg,size:15,pierce:0,pc:0,color:'#aaeeff',life:5.5,isEnemy:true,homing:true,target:p,freezing:true});
       fmsg('CRYO RAY','#88ddff');
     } else if(e._cryoPhase===1){
       // Ice shard spray ‚Äî full ring
       for(var i=0;i<14;i++){var ang=i/14*Math.PI*2;g.bullets.push({x:e.x,y:e.y,vx:Math.cos(ang)*310,vy:Math.sin(ang)*310,dmg:e.dmg*.7,size:7,pierce:0,pc:0,color:'#ccf5ff',life:3,isEnemy:true,homing:false});}
     } else {
       // Blizzard ‚Äî slow dense field
       for(var i=0;i<24;i++){var ang=Math.random()*Math.PI*2;var spd=80+Math.random()*140;g.bullets.push({x:e.x,y:e.y,vx:Math.cos(ang)*spd,vy:Math.sin(ang)*spd,dmg:e.dmg*.5,size:6,pierce:0,pc:0,color:'#ddf8ff',life:6,isEnemy:true,homing:false});}
       fmsg('BLIZZARD','#88ddff');
     }
     e._cryoPhase++;
   }},

  // G6 ‚îÄ‚îÄ PULSAR AVATAR (Pulsar Corridor)
  // Design: energy being with radiating lightning arcs
  // Mechanics: EMP pulse, spiral burst, aimed charged shot
  {name:'PULSAR AVATAR',color:'#ff4422',r:52,baseHp:700000,dmg:28,baseSpd:48,xpVal:240,coins:70,shootCd:1.6,
   shoot:function(g,e,p){
     e._pulsarPhase=(e._pulsarPhase||0)%4;
     if(e._pulsarPhase===0){
       // EMP ‚Äî disables abilities
       g._empTimer=4;burst(g,e.x,e.y,'#ff4422',28,220);fmsg('EMP PULSE ‚Äî ABILITIES OFFLINE','#ff4422');
     } else if(e._pulsarPhase===1){
       // Spiral burst ‚Äî 3-arm
       e.spiralAngle=(e.spiralAngle||0)+0.55;
       for(var i=0;i<3;i++){var ang=e.spiralAngle+i/3*Math.PI*2;g.bullets.push({x:e.x,y:e.y,vx:Math.cos(ang)*360,vy:Math.sin(ang)*360,dmg:e.dmg,size:10,pierce:0,pc:0,color:'#ff6644',life:3,isEnemy:true,homing:false});}
     } else if(e._pulsarPhase===2){
       // Charged beam ‚Äî high pierce
       var a=Math.atan2(p.y-e.y,p.x-e.x);
       g.bullets.push({x:e.x,y:e.y,vx:Math.cos(a)*700,vy:Math.sin(a)*700,dmg:e.dmg*2.2,size:16,pierce:99,pc:0,color:'#ffffff',life:2,isEnemy:true,homing:false});
       fmsg('PULSAR BEAM','#ff4422');
     } else {
       // Energy wave ‚Äî aimed spread
       var a=Math.atan2(p.y-e.y,p.x-e.x);
       for(var i=-3;i<=3;i++)g.bullets.push({x:e.x,y:e.y,vx:Math.cos(a+i*.22)*340,vy:Math.sin(a+i*.22)*340,dmg:e.dmg*.8,size:9,pierce:0,pc:0,color:'#ff3300',life:2.8,isEnemy:true,homing:false});
     }
     e._pulsarPhase++;
   }},

  // G7 ‚îÄ‚îÄ SINGULARITY ENTITY (Graviton Abyss)
  // Design: black hole form with accretion disk
  // Mechanics: gravity surge, void ring, teleport-blink, event horizon
  {name:'SINGULARITY ENTITY',color:'#6655ff',r:62,baseHp:1000000,dmg:32,baseSpd:28,xpVal:260,coins:75,shootCd:2.0,
   shoot:function(g,e,p){
     e._gravPhase=(e._gravPhase||0)%4;
     if(e._gravPhase===0){
       // Gravity surge ‚Äî pull player in
       g._gravPullTimer=3.5;g._gravPullSource={x:e.x,y:e.y};
       burst(g,e.x,e.y,'#6655ff',32,300);fmsg('GRAVITY SURGE','#6655ff');
     } else if(e._gravPhase===1){
       // Void ring
       e.ringAngle=(e.ringAngle||0)+0.35;
       for(var i=0;i<14;i++){var ang=e.ringAngle+i/14*Math.PI*2;g.bullets.push({x:e.x,y:e.y,vx:Math.cos(ang)*255,vy:Math.sin(ang)*255,dmg:e.dmg,size:10,pierce:0,pc:0,color:'#9988ff',life:4,isEnemy:true,homing:false});}
     } else if(e._gravPhase===2){
       // Teleport blink ‚Äî boss jumps near player
       e.x=p.x+(Math.random()-.5)*200;e.y=p.y+(Math.random()-.5)*200;
       burst(g,e.x,e.y,e.color,20,160);fmsg('VOID BLINK','#6655ff');
     } else {
       // Event horizon ‚Äî 4 homing void orbs
       for(var i=0;i<4;i++){var da=i/4*Math.PI*2;g.bullets.push({x:e.x+Math.cos(da)*e.r,y:e.y+Math.sin(da)*e.r,vx:Math.cos(da)*180,vy:Math.sin(da)*180,dmg:e.dmg*1.4,size:12,pierce:0,pc:0,color:'#aa99ff',life:6,isEnemy:true,homing:true,target:p});}
       fmsg('EVENT HORIZON','#6655ff');
     }
     e._gravPhase++;
   }},

  // G8 ‚îÄ‚îÄ ECHO COMMANDER (Mirror Expanse)
  // Design: large mirrored ship facing player
  // Mechanics: mirror clones, precision pierce shot, reflection burst
  {name:'ECHO COMMANDER',color:'#aaffdd',r:52,baseHp:1400000,dmg:36,baseSpd:43,xpVal:280,coins:80,shootCd:2.2,
   shoot:function(g,e,p){
     e._echoPhase=(e._echoPhase||0)%3;
     if(e._echoPhase===0){
       // Deploy 2 mirror clones
       var gd=(GALAXIES[g.galaxy]||GALAXIES[0]).diff;
       for(var i=0;i<2;i++){var da=Math.random()*Math.PI*2,d=120+Math.random()*80;g.enemies.push({x:e.x+Math.cos(da)*d,y:e.y+Math.sin(da)*d,r:16,spd:120*gd,hp:80*gd,maxHp:80*gd,dmg:g.gun.dmg*0.35,color:e.color,xpVal:6,flashTimer:0,frozen:0,isBoss:false,spinAngle:0,shootTimer:0,isClone:true,shootCd:1.2,typeIdx:0,galaxy:8});}
       fmsg('ECHO CLONE DEPLOYED','#aaffdd');
     } else if(e._echoPhase===1){
       // Precision pierce volley
       var a=Math.atan2(p.y-e.y,p.x-e.x);
       for(var i=-1;i<=1;i++)g.bullets.push({x:e.x,y:e.y,vx:Math.cos(a+i*.15)*520,vy:Math.sin(a+i*.15)*520,dmg:e.dmg,size:12,pierce:3,pc:0,color:e.color,life:2.8,isEnemy:true,homing:false});
     } else {
       // Reflection burst ‚Äî copies player aim direction back
       var a=Math.atan2(e.y-p.y,e.x-p.x); // reverse direction
       for(var i=-2;i<=2;i++)g.bullets.push({x:e.x,y:e.y,vx:Math.cos(a+i*.3)*380,vy:Math.sin(a+i*.3)*380,dmg:e.dmg*.8,size:10,pierce:0,pc:0,color:e.color,life:3,isEnemy:true,homing:false});
       fmsg('REFLECTION BURST','#aaffdd');
     }
     e._echoPhase++;
   }},

  // G9 ‚îÄ‚îÄ THE ARCHITECT (Void Heart)
  // Design: composite void entity with orbiting fragments
  // Mechanics: 7-phase cycling all prior boss mechanics, enrages at 50%
  {name:'THE ARCHITECT',color:'#ffffff',r:66,baseHp:2000000,dmg:40,baseSpd:38,xpVal:320,coins:100,shootCd:1.1,
   shoot:function(g,e,p){
     var phases=['spread','ring','emp','gravity','clone','sniper','shotgun','blink'];
     var phase=phases[(e.phaseIdx||0)%phases.length];e.phaseIdx=(e.phaseIdx||0)+1;
     var a=Math.atan2(p.y-e.y,p.x-e.x);
     var gd=(GALAXIES[g.galaxy]||GALAXIES[0]).diff;
     var mult=e.hp<e.maxHp*.5?1.4:1; // enrage multiplier
     if(phase==='spread'){for(var i=-3;i<=3;i++)g.bullets.push({x:e.x,y:e.y,vx:Math.cos(a+i*.2)*330*mult,vy:Math.sin(a+i*.2)*330*mult,dmg:e.dmg*mult,size:10,pierce:0,pc:0,color:'#ffffff',life:3,isEnemy:true,homing:false});}
     else if(phase==='ring'){e.ringAngle=(e.ringAngle||0)+0.4;for(var i=0;i<14;i++){var ang=e.ringAngle+i/14*Math.PI*2;g.bullets.push({x:e.x,y:e.y,vx:Math.cos(ang)*285,vy:Math.sin(ang)*285,dmg:e.dmg*.9,size:9,pierce:0,pc:0,color:'#ccccff',life:3.5,isEnemy:true,homing:false});}}
     else if(phase==='emp'){g._empTimer=5;burst(g,e.x,e.y,'#ffffff',32,260);fmsg('ARCHITECT EMP','#ffffff');}
     else if(phase==='gravity'){g._gravPullTimer=4;g._gravPullSource={x:e.x,y:e.y};fmsg('GRAVITY CRUSH','#ffffff');}
     else if(phase==='clone'){for(var i=0;i<3;i++){var da=Math.random()*Math.PI*2;g.enemies.push({x:e.x+Math.cos(da)*110,y:e.y+Math.sin(da)*110,r:14,spd:145*gd,hp:60*gd,maxHp:60*gd,dmg:12,color:'#dddddd',xpVal:4,flashTimer:0,frozen:0,isBoss:false,spinAngle:0,shootTimer:0,typeIdx:0,galaxy:9});}}
     else if(phase==='sniper'){g.bullets.push({x:e.x,y:e.y,vx:Math.cos(a)*820*mult,vy:Math.sin(a)*820*mult,dmg:e.dmg*2.2,size:17,pierce:99,pc:0,color:'#ffffff',life:2,isEnemy:true,homing:false});fmsg('VOID SNIPER','#ffffff');}
     else if(phase==='shotgun'){for(var i=0;i<16;i++)g.bullets.push({x:e.x,y:e.y,vx:Math.cos(a+(Math.random()-.5)*1.8)*(140+Math.random()*220),vy:Math.sin(a+(Math.random()-.5)*1.8)*(140+Math.random()*220),dmg:e.dmg*.6,size:8,pierce:0,pc:0,color:'#aaaaaa',life:3,isEnemy:true,homing:false});}
     else if(phase==='blink'){e.x=p.x+(Math.random()-.5)*200;e.y=p.y+(Math.random()-.5)*200;burst(g,e.x,e.y,'#ffffff',24,180);fmsg('VOID STEP','#ffffff');}
     if(e.hp<e.maxHp*.5&&!e._enragedMsg){e._enragedMsg=true;e.shootCd=0.7;fmsg('‚ò¢ ARCHITECT PHASE 2 ‚Äî ALL SYSTEMS ONLINE','#ff3366');}
   }},
];;

function mkBoss(galaxyIdx,px,py){
  var def=GALAXY_BOSSES[Math.min(galaxyIdx,GALAXY_BOSSES.length-1)];
  var gd=(GALAXIES[galaxyIdx]||GALAXIES[0]).diff;
  var hp=Math.round(def.baseHp*gd), spd=def.baseSpd*gd;
  var a=Math.random()*Math.PI*2;
  return Object.assign({},def,{isBoss:true,hp:hp,maxHp:hp,spd:spd,dmg:Math.round(def.dmg*gd),
    galaxy:galaxyIdx,
    x:Math.max(200,Math.min(WORLD-200,px+Math.cos(a)*600)),
    y:Math.max(200,Math.min(WORLD-200,py+Math.sin(a)*600)),
    flashTimer:0,frozen:0,spinAngle:0,shootTimer:0,phaseTimer:0,
    enraged:false,phaseShield:false,phaseShieldTimer:0,phaseShieldCd:22,
    charging:false,chargeTimer:0,chargeTarget:null,ringAngle:0,spiralAngle:0,phaseIdx:0});
}

function bossKillThreshold(wave){ return 30+wave*4; }

// ‚îÄ‚îÄ‚îÄ LIVE ASTEROIDS ‚îÄ‚îÄ‚îÄ
function spawnLiveAsteroids(g,n){
  var gIdx=g.galaxy||0;
  var gemScale=1+gIdx; // linear: galaxy 1=1x, galaxy 2=2x, etc.
  for(var i=0;i<n;i++){
    var m=200,x=m+Math.random()*(WORLD-m*2),y=m+Math.random()*(WORLD-m*2);
    var r=14+Math.random()*28,pts=5+Math.floor(Math.random()*4),verts=[];
    for(var j=0;j<pts;j++){var a=(j/pts)*Math.PI*2,rd=r*(.6+Math.random()*.8);verts.push([Math.cos(a)*rd,Math.sin(a)*rd]);}
    var hp=r*3;
    g.liveAsteroids.push({x:x,y:y,r:r,verts:verts,hp:hp,maxHp:hp,rot:Math.random()*Math.PI*2,
      rotSpd:(Math.random()-.5)*.025,vx:(Math.random()-.5)*20,vy:(Math.random()-.5)*20,
      flashTimer:0,gemVal:Math.ceil(r/8)*gemScale});
  }
}

// ‚îÄ‚îÄ‚îÄ MINING TOUCH ‚îÄ‚îÄ‚îÄ
var miningTouch={active:false,astIdx:-1,tid:null,x:0,y:0,laserLife:0};

// ‚îÄ‚îÄ‚îÄ GAME STATE ‚îÄ‚îÄ‚îÄ
var G=null;
function newGame(){
  var pb=document.getElementById('pauseBtn');
  if(pb){pb.style.display='flex';pb.textContent='‚è∏';}
  var bon=getBonus(),baseHp=100+bon.hull;
  G={
    running:true,paused:false,time:0,kills:0,wave:1,
    waveTimer:0,waveInterval:18,camera:{x:0,y:0},
    player:{x:WORLD/2,y:WORLD/2,hp:baseHp,maxHp:baseHp,spd:170*bon.spd,
      invincible:0,regen:bon.regen,regenT:0,r:16,level:1,xp:0,xpNext:25,
      pickR:95*bon.pickR,xpMult:bon.xp,shielded:false,dashQ:[],aimAngle:0,thruster:false,
      shield:null},
    gun:{dmg:24*bon.dmg,cd:0.48*bon.cd,t:0,spd:580,size:6,pierce:bon.pierce,spread:0,homing:false,color:'#00f5ff',chain:false},
    orbit:{active:false,blades:1,dmg:14,angle:0,angSpd:2.8,r:65,size:14,color:'#9b59ff'},
    nova:{active:false,dmg:55,cd:3.8,t:0,r:115,color:'#ff3366'},
    abilities:ABILITIES.map(function(a){return Object.assign({},a,{timer:0,effCd:function(){return a.baseCd*getBonus().abcd;}});}),
    rageActive:false,speedActive:false,adrActive:false,vampActive:false,
    _shockwaveBonusR:0,supernovaActive:null,
    activeBuffs:[],bullets:[],enemies:[],orbs:[],particles:[],worldPickups:[],
    liveAsteroids:[],gemMult:1,galaxy:currentGalaxy,
    spawnT:0,spawnRate:2.0,pickupT:0,pickupInterval:10,
    joystick:{dx:0,dy:0},killStreak:0,killStreakT:0,bossAlive:false,bossFought:false,crystalsRun:0,
    miningLaser:null,killsForBoss:0,eliteTimer:120,
    
    relics:[],portal:null,_upRanks:{},
    _relicGemMult:1,_ringResonance:0,_spiralCore:0,_dmgReduction:0,
    escorts:[],_singularityCd:0,_scatterFrenzy:0,_scatterNormalCd:0,_chainExplosive:0,_railLaser:null,
    _empTimer:0,_gravPullTimer:0,_gravPullSource:null,_freezePlayerTimer:0,poisonClouds:[],
    _sniperMod:0,_parasiteChance:0,_ghostProtocol:0,_lifeSteal:0,_sniperCounter:0,
  };
  initShield(G.player);
  // Restore persistent level
  G.player.level=persistLevel;
  G.player.xp=persistXP;
  G.player.xpNext=persistXPNext;
  applyPersistLevelBonuses(G);
  applyBeamToGun();
  applyVoidTree(G);
  buildAB();
  for(var i=0;i<6;i++)spawnPickup();
  spawnLiveAsteroids(G,22+currentGalaxy*3);
  miningTouch={active:false,astIdx:-1,tid:null,x:0,y:0,laserLife:0};
}

function buildAB(){
  var bar=document.getElementById('ab');bar.innerHTML='';
  G.abilities.forEach(function(ab,i){
    var rank=pRank('p_'+ab.id);
    var btn=document.createElement('div');
    btn.className='abn'+(rank>0?' upg':'')+' rdy';btn.id='ab'+i;
    btn.innerHTML='<div class="ic">'+ab.icon+'</div><div class="cl" id="abl'+i+'">'+(rank>0?'‚òÖ'.repeat(rank):ab.label)+'</div><div class="co" id="abo'+i+'" style="height:0%"></div>';
    btn.addEventListener('pointerdown',function(e){e.stopPropagation();useAb(i);});
    bar.appendChild(btn);
  });
}
function fireBeamSingularity(){
  var ob=ownedBeam();
  if(!G||!ob) return;
  var def=BEAM_DEFS.find(function(b){return b.id===ob;});
  if(!def||!def.singularity) return;
  if(G._singularityCd>0){fmsg('SINGULARITY RECHARGING ‚Äî '+Math.ceil(G._singularityCd)+'s','#446');return;}
  def.singularity(G);
  G._singularityCd=10;
  SFX.ability&&SFX.ability();
}

function fireBeamSingularity(){
  var ob=ownedBeam();
  if(!G||!ob||G._singularityCd>0) return;
  var def=BEAM_DEFS.find(function(b){return b.id===ob;});
  if(!def||!def.singularity) return;
  def.singularity(G);
  G._singularityCd=10; // 10s cooldown
  SFX.ability&&SFX.ability();
}
function useAb(i){
  if(G&&G._empTimer>0&&i>0){fmsg('ABILITIES OFFLINE ‚Äî EMP','#ff4422');return;}
  // Slot 0 (Q) fires singularity if available, otherwise normal
  if(i===0&&ownedBeam()&&G._singularityCd<=0){
    fireBeamSingularity();return;
  }
  var ab=G.abilities[i];if(!ab||ab.timer>0)return;
  ab.use(G);ab.timer=ab.effCd();SFX.ability();incLS('abilitiesUsed');if(ab.id==='dash')incLS('dashesUsed');
}

function dst(a,b){var dx=a.x-b.x,dy=a.y-b.y;return Math.sqrt(dx*dx+dy*dy);}
function burst(g,x,y,color,n,spd){for(var i=0;i<n;i++){var a=Math.random()*Math.PI*2,s=Math.random()*spd;g.particles.push({x:x,y:y,vx:Math.cos(a)*s,vy:Math.sin(a)*s,life:.3+Math.random()*.5,sz:2+Math.random()*3,color:color});}}
function fmsg(txt,color){var el=document.getElementById('pf');el.textContent=txt;el.style.color=color;el.style.opacity='1';el.style.textShadow='0 0 20px '+color;clearTimeout(el._t);el._t=setTimeout(function(){el.style.opacity='0';},1400);}
function showKill(s){if(s<3)return;var el=document.getElementById('kf');var m=['','','','TRIPLE KILL','QUAD KILL','RAMPAGE','UNSTOPPABLE','GODLIKE'];el.textContent=m[Math.min(s,7)]||'LEGENDARY';el.style.opacity='1';clearTimeout(el._t);el._t=setTimeout(function(){el.style.opacity='0';},900);}
function addOrb(g,e){var v=Math.round((e.xpVal||3)*(g.player.xpMult||1));g.orbs.push({x:e.x,y:e.y,val:v,life:15});}
function chaos(){if(!G)return 0;var total=Object.values(permData).reduce(function(a,b){return a+b;},0);return Math.floor((total*1.0+G.wave*.3+G.kills*.01+ownedSkins.length*1)/4);}
function spawnPickup(){
  // Health pickups have weighted 25% chance so they appear regularly
  var roll=Math.random();
  var t;
  if(roll<0.12) t=PICKUPS.find(function(p){return p.id==='hp25';});
  else if(roll<0.18) t=PICKUPS.find(function(p){return p.id==='hp50';});
  else if(roll<0.20) t=PICKUPS.find(function(p){return p.id==='hpfull';});
  else t=PICKUPS[Math.floor(Math.random()*PICKUPS.length)];
  var m=150;G.worldPickups.push({x:m+Math.random()*(WORLD-m*2),y:m+Math.random()*(WORLD-m*2),type:t,bob:Math.random()*Math.PI*2,life:40});
}

function spawnEnemy(){
  var g=G,p=g.player,c=chaos();
  var gd=(GALAXIES[g.galaxy||0]||GALAXIES[0]).diff;
  var a=Math.random()*Math.PI*2,d=300+Math.random()*160;
  var x=Math.max(30,Math.min(WORLD-30,p.x+Math.cos(a)*d));
  var y=Math.max(30,Math.min(WORLD-30,p.y+Math.sin(a)*d));
  var cc=Math.min(c,8); // cap chaos contribution to speed
  var types=[
    {r:13,spd:Math.min(320,70+g.wave*6+cc*3)*gd,   hp:(30+g.wave*10+c*5)*gd,  maxHp:(30+g.wave*10+c*5)*gd,  dmg:Math.round(10*gd),color:'#00f5ff',xpVal:3},
    {r:22,spd:Math.min(240,38+g.wave*4+cc*2)*gd,   hp:(80+g.wave*20+c*10)*gd, maxHp:(80+g.wave*20+c*10)*gd, dmg:Math.round(20*gd),color:'#ff6a00',xpVal:8},
    {r:10,spd:Math.min(360,130+g.wave*8+cc*4)*gd,  hp:(18+g.wave*5+c*3)*gd,   maxHp:(18+g.wave*5+c*3)*gd,   dmg:Math.round(5*gd), color:'#9b59ff',xpVal:2,shoots:true},
    {r:30,spd:Math.min(180,25+g.wave*3+cc)*gd,     hp:(220+g.wave*45+c*20)*gd,maxHp:(220+g.wave*45+c*20)*gd,dmg:Math.round(32*gd),color:'#ff3366',xpVal:16},
    {r:8, spd:Math.min(380,180+g.wave*10+cc*5)*gd, hp:(12+g.wave*3)*gd,       maxHp:(12+g.wave*3)*gd,       dmg:Math.round(8*gd), color:'#ffcc22',xpVal:2,kamikaze:true},
  ];
  var pool=g.wave<3?[0]:g.wave<5?[0,0,1]:g.wave<8?[0,0,1,2]:g.wave<12?[0,0,1,2,3]:[0,0,1,2,3,4];
  // Elite chance: 3% base + 2% per galaxy, starts galaxy 2
  if(c>5)pool.push(4,4);if(c>10)pool.push(3,3);
  // Elites spawn on a cooldown timer (min galaxy 2), not per-spawn chance
  var isElite=(g.galaxy||0)>=1&&(g.eliteTimer||0)<=0;
  if(isElite)g.eliteTimer=120;
  var tidx=pool[Math.floor(Math.random()*pool.length)];
  var t=types[tidx];
  var enemy=Object.assign({},t,{x:x,y:y,flashTimer:0,frozen:0,isBoss:false,spinAngle:0,shootTimer:0,typeIdx:tidx,galaxy:g.galaxy||0});
  if(isElite){
    enemy.hp*=15;enemy.maxHp=enemy.hp;enemy.dmg=Math.round(enemy.dmg*2);enemy.spd*=1.3;
    enemy.r=Math.round(enemy.r*1.3);enemy.isElite=true;enemy.xpVal*=4;
    enemy.color='#ffd700'; // gold
  }
  g.enemies.push(enemy);
}

// ‚îÄ‚îÄ‚îÄ UPDATE ‚îÄ‚îÄ‚îÄ
function update(dt){
  var g=G;g.time+=dt;g.waveTimer+=dt;
  var p=g.player,c=chaos();

  // Wave progression
  if((g.eliteTimer||0)>0)g.eliteTimer-=dt;

  // ‚îÄ‚îÄ GALAXY TWIST EFFECTS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  var twist=(GALAXIES[g.galaxy||0]||GALAXIES[0]).twist;

  // EMP: abilities disabled
  if(g._empTimer>0){
    g._empTimer-=dt;
    if(g._empTimer<0)g._empTimer=0;
  }

  // Gravity pull toward source
  if(g._gravPullTimer>0){
    g._gravPullTimer-=dt;
    if(g._gravPullSource){
      var gpd=dst(p,g._gravPullSource);
      if(gpd>40){
        var gpa=Math.atan2(g._gravPullSource.y-p.y,g._gravPullSource.x-p.x);
        p.x+=Math.cos(gpa)*220*dt;
        p.y+=Math.sin(gpa)*220*dt;
      }
    }
    if(g._gravPullTimer<=0){g._gravPullTimer=0;g._gravPullSource=null;}
  }

  // Passive gravity in G8 ‚Äî gentle constant drift toward center of world
  if(twist==='gravity'&&!g._gravPullTimer){
    var wx=WORLD/2,wy=WORLD/2,wd=dst(p,{x:wx,y:wy});
    if(wd>200){var wa=Math.atan2(wy-p.y,wx-p.x);p.x+=Math.cos(wa)*28*dt;p.y+=Math.sin(wa)*28*dt;}
  }

  // Poison clouds ‚Äî deal damage if player inside
  if(g.poisonClouds){
    for(var pci=g.poisonClouds.length-1;pci>=0;pci--){
      var pc2=g.poisonClouds[pci];pc2.life-=dt;
      if(pc2.life<=0){g.poisonClouds.splice(pci,1);continue;}
      if(dst(p,pc2)<pc2.r&&p.invincible<=0){
        p.hp-=6*dt;p.hp=Math.max(1,p.hp);
      }
    }
  }

  // Freeze player
  if(g._freezePlayerTimer>0){
    g._freezePlayerTimer-=dt;
    if(g._freezePlayerTimer<0)g._freezePlayerTimer=0;
  }

  // Periodic twist spawns ‚Äî leviathan field: enemies phase in
  if(twist==='leviathan'&&g.bossAlive){
    g._leviathanTimer=(g._leviathanTimer||0)+dt;
    if(g._leviathanTimer>8){g._leviathanTimer=0;fmsg('VOID SHIMMER','#8844ff');}
  }

  if(g.waveTimer>=g.waveInterval){
    g.waveTimer=0;g.wave++;g.spawnRate=Math.max(0.28,g.spawnRate*(0.88-c*.002));
    document.getElementById('wd').textContent='SECTOR '+g.wave;
    showWA('SECTOR '+g.wave,'#00f5ff');
    // killsForBoss is cumulative ‚Äî do NOT reset on wave tick
  }

  // Kill-based boss spawn ‚Äî fixed threshold per galaxy, cumulative kills
  if(!g.bossAlive&&!g.bossFought){
    var thresh=100+((g.galaxy||0)*200); // 100, 300, 500, 700...
    var kw=g.killsForBoss||0;
    var sm=document.getElementById('sectorMeter');
    var smf=document.getElementById('sectorMeterFill');
    var smc=document.getElementById('sectorMeterCount');
    if(sm){sm.style.display='block';if(smf)smf.style.width=Math.min(100,(kw/thresh)*100)+'%';if(smc)smc.textContent=kw+'/'+thresh;}
    if(kw>=thresh){
      g.bossAlive=true;
      if(sm)sm.style.display='none';
      // Clear all existing enemies before boss spawns
      for(var ci=g.enemies.length-1;ci>=0;ci--){var ce=g.enemies[ci];if(!ce.isBoss){burst(g,ce.x,ce.y,ce.color,6,80);g.enemies.splice(ci,1);}}
      var boss=mkBoss(g.galaxy||0,p.x,p.y);
      g.enemies.push(boss);
      document.getElementById('bb').style.display='block';
      showWA('‚ö† BOSS INCOMING ‚ö†\n'+boss.name,boss.color||'#ffd700');
    }
  } else if(g.bossFought&&!g.bossAlive){
    var sm2=document.getElementById('sectorMeter');if(sm2)sm2.style.display='none';
  }
  document.getElementById('chd').textContent=c>0?'CHAOS x'+c:'';

  var dx=g.joystick.dx,dy=g.joystick.dy;
  if(keys.KeyW||keys.ArrowUp)dy-=1;if(keys.KeyS||keys.ArrowDown)dy+=1;
  if(keys.KeyA||keys.ArrowLeft)dx-=1;if(keys.KeyD||keys.ArrowRight)dx+=1;
  var jl=Math.sqrt(dx*dx+dy*dy);if(jl>1){dx/=jl;dy/=jl;}
  p.thruster=jl>0.1;

  if(p.dashQ&&p.dashQ.length>0){var dq=p.dashQ[0];if(!dq.delay||dq.delay<=0){p.x+=dq.vx*3;p.y+=dq.vy*3;dq.frames--;if(dq.frames<=0)p.dashQ.shift();}else dq.delay--;}
  var ms=p.spd*(g.speedActive?2:1);
  p.x=Math.max(30,Math.min(WORLD-30,p.x+dx*ms*dt));p.y=Math.max(30,Math.min(WORLD-30,p.y+dy*ms*dt));
  if(p.invincible>0)p.invincible-=dt;
  if(p.regen>0){p.regenT+=dt;if(p.regenT>=1){p.regenT=0;p.hp=Math.min(p.maxHp,p.hp+p.regen);}}

  // Shield regen
  if(p.shield){
    if(p.shield.hp<p.shield.maxHp){
      p.shield.regenTimer+=dt;
      if(p.shield.regenTimer>=p.shield.regenDelay){
        p.shield.hp=Math.min(p.shield.maxHp,p.shield.hp+p.shield.regen*dt);
      }
    }
  }
  updateShieldHUD(p);
  g.camera.x=p.x-W/2;g.camera.y=p.y-H/2;

  var closest=null,cDist=Infinity;
  for(var ei=0;ei<g.enemies.length;ei++){var ed=dst(p,g.enemies[ei]);if(ed<cDist){cDist=ed;closest=g.enemies[ei];}}
  if(closest)p.aimAngle=Math.atan2(closest.y-p.y,closest.x-p.x);

  var gun=g.gun,gcd=gun.cd*(g.adrActive?.25:1);
  gun.t+=dt;
  if(gun.t>=gcd&&closest){gun.t=0;SFX.shoot();
    {
      var angs=[0];if(gun.spread>=1)angs.push(-.22,.22);if(gun.spread>=2)angs.push(-.4,.4);if(gun.spread>=3)angs.push(-.58,.58);if(gun.spread>=4)angs.push(-.76,.76);if(gun.spread>=5)angs.push(-.94,.94);
      for(var ai=0;ai<angs.length;ai++){var aa=p.aimAngle+angs[ai];g.bullets.push({x:p.x,y:p.y,vx:Math.cos(aa)*gun.spd,vy:Math.sin(aa)*gun.spd,dmg:gun.dmg*(g.rageActive?2:1),size:gun.size,pierce:gun.pierce,pc:0,color:gun.color,life:2.2,isEnemy:false,homing:gun.homing,target:closest,chain:gun.chain});}
    }
    burst(g,p.x,p.y,gun.color,3,40);
    // Relic: sniper module
    if(g._sniperMod>0){g._sniperCounter=(g._sniperCounter||0)+1;if(g._sniperCounter>=(8-Math.min(4,g._sniperMod))){g._sniperCounter=0;g.bullets.push({x:p.x,y:p.y,vx:Math.cos(p.aimAngle)*950,vy:Math.sin(p.aimAngle)*950,dmg:gun.dmg*2.5,size:12,pierce:99,pc:0,color:'#ffd700',life:2.2,isEnemy:false,homing:false,target:null,chain:false});}}
  }


  var heatBar=document.getElementById('beamHeatBar');
  if(heatBar)heatBar.style.display='none';

  // Escort gunships
  if(g.escorts&&g.escorts.length>0){
    for(var ei2=0;ei2<g.escorts.length;ei2++){
      var es=g.escorts[ei2];
      es.angle+=dt*1.4;
      es.x=p.x+Math.cos(es.angle)*es.orbitR;
      es.y=p.y+Math.sin(es.angle)*es.orbitR;
      es.shootT+=dt;
      if(es.shootT>=es.shootCd&&g.enemies.length>0){
        es.shootT=0;
        // Find closest enemy
        var closest=null,cDist=99999;
        for(var ei3=0;ei3<g.enemies.length;ei3++){var ed=dst(es,g.enemies[ei3]);if(ed<cDist){cDist=ed;closest=g.enemies[ei3];}}
        if(closest){
          var ea=Math.atan2(closest.y-es.y,closest.x-es.x);
          g.bullets.push({x:es.x,y:es.y,vx:Math.cos(ea)*600,vy:Math.sin(ea)*600,dmg:es.dmg,size:8,pierce:0,pc:0,color:'#ff6a00',life:3,isEnemy:false,homing:true,target:closest,chain:false,isMissile:true});
        }
      }
    }
  }
  if(g.orbit.active){g.orbit.angle+=g.orbit.angSpd*dt;for(var oi=0;oi<g.orbit.blades;oi++){var oa=g.orbit.angle+(Math.PI*2/g.orbit.blades)*oi;var bx=p.x+Math.cos(oa)*g.orbit.r,by=p.y+Math.sin(oa)*g.orbit.r;for(var oei=0;oei<g.enemies.length;oei++)if(dst({x:bx,y:by},g.enemies[oei])<g.orbit.size+g.enemies[oei].r)hitE(g,g.enemies[oei],g.orbit.dmg*dt*3);}}
  if(g.nova.active){g.nova.t+=dt;if(g.nova.t>=g.nova.cd){g.nova.t=0;for(var ni=0;ni<g.enemies.length;ni++)if(dst(p,g.enemies[ni])<g.nova.r)hitE(g,g.enemies[ni],g.nova.dmg);g.particles.push({type:'ring',x:p.x,y:p.y,radius:0,maxR:g.nova.r,life:.4,maxLife:.4,color:g.nova.color});burst(g,p.x,p.y,g.nova.color,14,130);}}

  if(g.supernovaActive){var sn=g.supernovaActive;sn.life-=dt;sn.radius+=dt*(sn.maxR/.8);
    if(sn.life>1.2){for(var si=0;si<g.enemies.length;si++){var se=g.enemies[si];var sang=Math.atan2(p.y-se.y,p.x-se.x);if(dst(p,se)<sn.radius){se.x+=Math.cos(sang)*130*dt;se.y+=Math.sin(sang)*130*dt;}}}
    g.particles.push({type:'ring',x:p.x,y:p.y,radius:Math.max(0,sn.radius-8),maxR:sn.radius+10,life:.12,maxLife:.12,color:'#ff3366'});
    if(sn.life<=0){for(var xi=g.enemies.length-1;xi>=0;xi--){var xe=g.enemies[xi],xd=dst(p,xe);if(xd<sn.maxR){var xm=480*(1-xd/(sn.maxR+50));xe.hp-=xm;xe.flashTimer=.2;if(xe.hp<=0&&!xe.isBoss){burst(g,xe.x,xe.y,xe.color,18,150);addOrb(g,xe);g.enemies.splice(xi,1);g.kills++;}}}g.particles.push({type:'ring',x:p.x,y:p.y,radius:0,maxR:sn.maxR,life:.8,maxLife:.8,color:'#ff6a00'});burst(g,p.x,p.y,'#ff6a00',55,320);g.supernovaActive=null;}
  }

  // Bullets
  for(var bi=g.bullets.length-1;bi>=0;bi--){
    var b=g.bullets[bi];
    if(b.homing&&b.target&&g.enemies.indexOf(b.target)>=0){var ha=Math.atan2(b.target.y-b.y,b.target.x-b.x),hs=Math.sqrt(b.vx*b.vx+b.vy*b.vy);b.vx+=(Math.cos(ha)*hs-b.vx)*.07;b.vy+=(Math.sin(ha)*hs-b.vy)*.07;}
    // Chain bullet: seek nearest unhit enemy after hitting one
    if(b.chain&&b.pc>0&&b.pc<=b.pierce){if(g._chainExplosive>0){burst(g,b.x,b.y,'#9b59ff',10,100);for(var cxi=g.enemies.length-1;cxi>=0;cxi--){if(!g.enemies[cxi].isBoss&&dst(b,g.enemies[cxi])<90)hitE(g,g.enemies[cxi],b.dmg*0.6);}}var cn=null,cd2=Infinity;for(var ci=0;ci<g.enemies.length;ci++){var ce=g.enemies[ci];if(dst(b,ce)<cd2){cd2=dst(b,ce);cn=ce;}}if(cn){var ca=Math.atan2(cn.y-b.y,cn.x-b.x),cs=Math.sqrt(b.vx*b.vx+b.vy*b.vy)||gun.spd;b.vx=Math.cos(ca)*cs;b.vy=Math.sin(ca)*cs;}}
    b.x+=b.vx*dt;b.y+=b.vy*dt;b.life-=dt;
    // Bouncing bullets
    if(b.bouncing&&b.bounces>0){
      if(b.x<0||b.x>WORLD){b.vx*=-1;b.bounces--;burst(g,b.x,b.y,b.color,3,40);}
      if(b.y<0||b.y>WORLD){b.vy*=-1;b.bounces--;burst(g,b.x,b.y,b.color,3,40);}
    }
    if(b.life<=0){g.bullets.splice(bi,1);continue;}
    if(!b.isEnemy){
      var bhit=false;
      for(var bei=0;bei<g.enemies.length;bei++){if(dst(b,g.enemies[bei])<b.size+g.enemies[bei].r){hitE(g,g.enemies[bei],b.dmg);burst(g,b.x,b.y,b.color,3,55);b.pc++;if(b.pc>b.pierce){bhit=true;break;}}}
      if(!bhit){
        for(var asti=g.liveAsteroids.length-1;asti>=0;asti--){
          var ast=g.liveAsteroids[asti];
          if(dst(b,ast)<b.size+ast.r){
            ast.hp-=b.dmg;ast.flashTimer=.15;burst(g,b.x,b.y,'#aaaaaa',4,60);b.pc++;
            SFX.asteroidHit();
            if(ast.hp<=0){
              SFX.asteroidBreak();
              var gems=Math.ceil(ast.gemVal*(g.gemMult||1)*(g._relicGemMult||1));
              crystals+=gems;lsS('vr_crystals',crystals);g.crystalsRun+=gems;
              tutCheckCrystal();
              incLS('gemsCollected',gems);incLS('asteroidsDestroyed');
              burst(g,ast.x,ast.y,'#00f5ff',14,120);
              for(var gi=0;gi<Math.min(gems,6);gi++)g.particles.push({type:'gem',x:ast.x+(Math.random()-.5)*ast.r*2,y:ast.y+(Math.random()-.5)*ast.r*2,vx:(Math.random()-.5)*80,vy:(Math.random()-.5)*80,life:.9,sz:5,color:'#00f5ff'});
              fmsg('üíé +'+(g.gemMult>1?gems+' x'+g.gemMult:gems),'#00f5ff');
              SFX.gemCollect();
              g.liveAsteroids.splice(asti,1);
              setTimeout(function(){if(G)spawnLiveAsteroids(G,1);},3000+Math.random()*5000);
            }
            if(b.pc>b.pierce){bhit=true;break;}
          }
        }
      }
      if(bhit){g.bullets.splice(bi,1);continue;}
    }else{if(p.invincible<=0&&dst(p,b)<p.r+b.size){
        if(b.freezing&&p.invincible<=0){g._freezePlayerTimer=2;p.spd*=0.25;setTimeout(function(){if(G&&G.player)G.player.spd=G.player.spd*4;},2000);fmsg('FROZEN','#88ddff');}
        if(p.shield&&p.shield.hp>0){
          var absorbed2=Math.min(p.shield.hp,b.dmg);
          p.shield.hp-=absorbed2;p.shield.regenTimer=0;burst(g,p.x,p.y,'#33aaff',4,60);
          var overflow2=b.dmg-absorbed2;
          if(overflow2>0&&!p.shielded){p.hp-=overflow2;p.invincible=.4;burst(g,p.x,p.y,'#ff3366',6,80);SFX.playerHit();if(p.hp<=0){gameOver();return;}}
        } else if(!p.shielded){p.hp-=b.dmg;p.invincible=.4;burst(g,p.x,p.y,'#ff3366',6,80);SFX.playerHit();tutCheckDamage();if(p.hp<=0){gameOver();return;}}
        g.bullets.splice(bi,1);}}
  }

  // Ability cooldowns UI
  for(var abi=0;abi<g.abilities.length;abi++){var ab=g.abilities[abi];if(ab.timer>0){ab.timer=Math.max(0,ab.timer-dt);var pct=(ab.timer/ab.effCd())*100;var ov2=document.getElementById('abo'+abi);var abtn=document.getElementById('ab'+abi);var albl=document.getElementById('abl'+abi);var rank=pRank('p_'+ab.id);if(ov2)ov2.style.height=pct+'%';if(abtn)abtn.className='abn'+(rank>0?' upg':'')+(ab.timer===0?' rdy':'');if(albl)albl.textContent=ab.timer>0?ab.timer.toFixed(1)+'s':(rank>0?'‚òÖ'.repeat(rank):ab.label);}}

  // Spawn enemies ‚Äî STOP during boss fight
  // No spawning during boss fight OR after boss dies (until next galaxy loads)
  if(!g.bossAlive&&!g.bossFought&&!g.portal){
    g.spawnT+=dt;
    if(g.spawnT>=g.spawnRate){g.spawnT=0;spawnEnemy();
      if(g.wave>2&&Math.random()<.5)spawnEnemy();if(g.wave>5&&Math.random()<.4)spawnEnemy();
      if(g.wave>8&&Math.random()<.35)spawnEnemy();
      if(Math.random()<Math.min(.6,c*.04))spawnEnemy();if(c>12&&Math.random()<.2)spawnEnemy();
    }
  }

  // Update enemies
  for(var eni=g.enemies.length-1;eni>=0;eni--){
    var en=g.enemies[eni];if(en.flashTimer>0)en.flashTimer-=dt;if(en.frozen>0){en.frozen-=dt;continue;}
    if(en.isBoss){en.phaseTimer=(en.phaseTimer||0)+dt;
      // Enrage at 35% HP
      if(!en.enraged&&en.hp/en.maxHp<.35){en.enraged=true;en.spd*=1.6;en.shootCd*=0.6;showWA(en.name+'\nENRAGED','#ff3366');burst(g,en.x,en.y,'#ff3366',35,200);}

      // Phase shield ‚Äî immune window
      en.phaseShieldCd=(en.phaseShieldCd||22);
      en.phaseShieldTimer=(en.phaseShieldTimer||0)+dt;
      var shieldInterval=en.enraged?12:en.phaseShieldCd;
      if(!en.phaseShield&&en.phaseShieldTimer>=shieldInterval){en.phaseShield=true;en.phaseShieldTimer=0;en.phaseShieldLife=2.5+(en.enraged?0:-1);burst(g,en.x,en.y,en.color,18,100);fmsg('PHASE SHIELD','#88aaff');}
      if(en.phaseShield){en.phaseShieldLife=(en.phaseShieldLife||2)-dt;if(en.phaseShieldLife<=0){en.phaseShield=false;en.phaseShieldTimer=0;}}

      // Charge beam telegraph + fire
      if(en.charging){
        en.chargeTimer-=dt;
        burst(g,en.x,en.y,en.color,3,60);
        if(en.chargeTimer<=0){
          en.charging=false;
          if(en.chargeTarget){var ca=Math.atan2(en.chargeTarget.y-en.y,en.chargeTarget.x-en.x);for(var ci=0;ci<8;ci++){var cang=ca+(Math.random()-.5)*.15;g.bullets.push({x:en.x,y:en.y,vx:Math.cos(cang)*600,vy:Math.sin(cang)*600,dmg:en.dmg*1.2,size:14,pierce:99,pc:0,color:en.color,life:2,isEnemy:true,homing:false});}burst(g,en.x,en.y,en.color,30,200);}
        }
      }

      // Shoot pattern
      if(!en.charging){
        en.shootTimer=(en.shootTimer||0)+dt;
        var scd2=(en.shootCd||1.5)*(en.enraged?0.55:1);
        if(en.shootTimer>=scd2){en.shootTimer=0;if(en.shoot)en.shoot(g,en,p);}
      }

      // Update boss HP bar
      var bfEl=document.getElementById('bf2');if(bfEl)bfEl.style.width=(Math.max(0,en.hp/en.maxHp)*100)+'%';
      var bblEl=document.getElementById('bbl');
      if(bblEl){var shieldTxt=en.phaseShield?' üõ°':'';var chargeTxt=en.charging?' ‚ö°':'';bblEl.textContent=(en.enraged?'‚ò¢ ':'')+en.name+shieldTxt+chargeTxt+' | '+Math.ceil(Math.max(0,en.hp))+'/'+en.maxHp;}
    }
    if(en.kamikaze&&dst(p,en)<58){burst(g,en.x,en.y,en.color,16,120);g.enemies.splice(eni,1);if(p.shield&&p.shield.hp>0){var ka=Math.min(p.shield.hp,30);p.shield.hp-=ka;if(30-ka>0&&!p.shielded){p.hp-=30-ka;if(p.hp<=0){gameOver();return;}}}else if(p.invincible<=0&&!p.shielded){p.hp-=30;if(p.hp<=0){gameOver();return;}}continue;}
    if(en.isClone&&!en.isBoss){
      en.shootTimer=(en.shootTimer||0)+dt;
      if(en.shootTimer>=(en.shootCd||1.5)){
        en.shootTimer=0;
        var ca3=Math.atan2(p.y-en.y,p.x-en.x);
        g.bullets.push({x:en.x,y:en.y,vx:Math.cos(ca3)*320,vy:Math.sin(ca3)*320,dmg:en.dmg,size:8,pierce:0,pc:0,color:en.color,life:3,isEnemy:true,homing:false});
      }
    }
    if(en.shoots&&!en.isBoss){en.shootTimer=(en.shootTimer||0)+dt;var scd=Math.max(.7,3.2-c*.06);if(en.shootTimer>scd){en.shootTimer=0;var sba=Math.atan2(p.y-en.y,p.x-en.x);g.bullets.push({x:en.x,y:en.y,vx:Math.cos(sba)*210,vy:Math.sin(sba)*210,dmg:12,size:7,pierce:0,pc:0,color:'#9b59ff',life:2.5,isEnemy:true,homing:false});}}
    var eang=Math.atan2(p.y-en.y,p.x-en.x);en.x+=Math.cos(eang)*en.spd*dt;en.y+=Math.sin(eang)*en.spd*dt;
    if(p.invincible<=0&&dst(p,en)<p.r+en.r){
      var dmgAmt=(en.isBoss?en.dmg*dt*2:en.dmg)*(1-(g._dmgReduction||0));
      if(p.shield&&p.shield.hp>0){
        // Shield fully absorbs ALL damage until depleted
        var absorbed=Math.min(p.shield.hp,dmgAmt);
        p.shield.hp-=absorbed;p.shield.regenTimer=0;burst(g,p.x,p.y,'#33aaff',4,60);
        var overflow=dmgAmt-absorbed;
        if(overflow>0&&!p.shielded){p.hp-=overflow;if(p.hp<=0){gameOver();return;}}
      } else if(!p.shielded){if(en.isBoss){p.hp-=dmgAmt;burst(g,p.x,p.y,'#ff3366',4,60);}else{p.hp-=dmgAmt;p.invincible=.75;burst(g,p.x,p.y,'#ff3366',8,100);SFX.playerHit();}}
      if(p.hp<=0){gameOver();return;}}
  }

  // Update live asteroids
  for(var lasi=0;lasi<g.liveAsteroids.length;lasi++){var las=g.liveAsteroids[lasi];las.rot+=las.rotSpd*dt;las.x+=las.vx*dt;las.y+=las.vy*dt;if(las.x<50)las.vx=Math.abs(las.vx);if(las.x>WORLD-50)las.vx=-Math.abs(las.vx);if(las.y<50)las.vy=Math.abs(las.vy);if(las.y>WORLD-50)las.vy=-Math.abs(las.vy);if(las.flashTimer>0)las.flashTimer-=dt;}

  // Mining laser update
  if(miningTouch.active && miningTouch.astIdx>=0){
    var mAst=g.liveAsteroids[miningTouch.astIdx];
    if(mAst){
      var mDmg=55*dt; // ~2 seconds to break a mid-size asteroid
      mAst.hp-=mDmg; mAst.flashTimer=0.1;
      miningTouch.laserLife=0.12; // keep laser visible
      // Update mining bar
      var mPct=Math.max(0,mAst.hp/mAst.maxHp);
      var mFill=document.getElementById('miningFill');
      if(mFill)mFill.style.width=((1-mPct)*100)+'%';
      if(mAst.hp<=0){
        SFX.asteroidBreak();
        var gems=Math.ceil(mAst.gemVal*(g.gemMult||1));
        crystals+=gems;lsS('vr_crystals',crystals);g.crystalsRun+=gems;
        incLS('gemsCollected',gems);incLS('asteroidsDestroyed');
        burst(g,mAst.x,mAst.y,'#00f5ff',14,120);
        for(var mgi=0;mgi<Math.min(gems,8);mgi++)g.particles.push({type:'gem',x:mAst.x+(Math.random()-.5)*mAst.r*2,y:mAst.y+(Math.random()-.5)*mAst.r*2,vx:(Math.random()-.5)*80,vy:(Math.random()-.5)*80,life:.9,sz:5,color:'#00f5ff'});
        fmsg('‚õè MINED +'+gems+' üíé','#00f5ff');
        SFX.gemCollect();
        g.liveAsteroids.splice(miningTouch.astIdx,1);
        miningTouch.active=false;miningTouch.astIdx=-1;
        var mb=document.getElementById('miningBar');if(mb)mb.style.display='none';
        var mf=document.getElementById('miningFill');if(mf)mf.style.width='0%';
        setTimeout(function(){if(G)spawnLiveAsteroids(G,1);},3000+Math.random()*5000);
      }
      // Store laser endpoints for rendering
      g.miningLaser={sx:p.x,sy:p.y,ex:mAst.x,ey:mAst.y,life:0.12};
    } else {
      miningTouch.active=false;miningTouch.astIdx=-1;
      var mb=document.getElementById('miningBar');if(mb)mb.style.display='none';
    }
  }
  if(g.miningLaser&&g.miningLaser.life>0)g.miningLaser.life-=dt;

  // Mining laser update
  if(miningTouch.active && miningTouch.astIdx>=0){
    var mast=g.liveAsteroids[miningTouch.astIdx];
    if(!mast){miningTouch.active=false;}
    else{
      var miningDmg=18*dt; // ~2.5s to break a mid asteroid
      mast.hp-=miningDmg; mast.flashTimer=0.05; miningTouch.laserLife=0.08;
      if(mast.hp<=0){
        SFX.asteroidBreak();
        var gems=Math.ceil(mast.gemVal*(g.gemMult||1));
        crystals+=gems;lsS('vr_crystals',crystals);g.crystalsRun+=gems;
        incLS('gemsCollected',gems);incLS('asteroidsDestroyed');
        burst(g,mast.x,mast.y,'#00f5ff',14,120);
        for(var gi=0;gi<Math.min(gems,6);gi++)g.particles.push({type:'gem',x:mast.x+(Math.random()-.5)*mast.r*2,y:mast.y+(Math.random()-.5)*mast.r*2,vx:(Math.random()-.5)*80,vy:(Math.random()-.5)*80,life:.9,sz:5,color:'#00f5ff'});
        fmsg('‚õè MINED +'+gems+(g.gemMult>1?' x'+g.gemMult:''),'#00f5ff');
        SFX.gemCollect();
        g.liveAsteroids.splice(miningTouch.astIdx,1);
        miningTouch.active=false;miningTouch.astIdx=-1;
        setTimeout(function(){if(G)spawnLiveAsteroids(G,1);},3000+Math.random()*5000);
      }
    }
  }
  if(miningTouch.laserLife>0)miningTouch.laserLife-=dt;

  // XP orbs
  for(var ori=g.orbs.length-1;ori>=0;ori--){var orb=g.orbs[ori];orb.life-=dt;if(orb.life<=0){g.orbs.splice(ori,1);continue;}var od=dst(p,orb);if(od<p.pickR){var oa2=Math.atan2(p.y-orb.y,p.x-orb.x),os=Math.max(230,(p.pickR-od)*6);orb.x+=Math.cos(oa2)*os*dt;orb.y+=Math.sin(oa2)*os*dt;}if(dst(p,orb)<p.r+9){g.orbs.splice(ori,1);p.xp+=orb.val;SFX.xpCollect();incLS('xpOrbsCollected');if(p.xp>=p.xpNext){p.xp-=p.xpNext;p.xpNext=Math.floor(p.xpNext*1.28);p.level++;if(p.level>LS.highestLevel){LS.highestLevel=p.level;saveLS();checkBadgeUnlocks();}SFX.levelUp();persistLevelUp(g);showLU();}}}

  // World pickups
  g.pickupT+=dt;if(g.pickupT>=g.pickupInterval){g.pickupT=0;spawnPickup();}
  for(var pki=g.worldPickups.length-1;pki>=0;pki--){var pk=g.worldPickups[pki];pk.bob+=dt*2;pk.life-=dt;if(pk.life<=0){g.worldPickups.splice(pki,1);continue;}if(dst(p,pk)<p.r+24){g.worldPickups.splice(pki,1);collectPK(g,pk.type);}}
  // Portal update
  if(g.portal){
    g.portal.angle+=dt*2.2;g.portal.pulseT+=dt;
    if(dst(p,g.portal)<g.portal.r-10){
      var dest=g.portal.galaxyTo;
      g.portal=null;
      if(dest<GALAXIES.length) startGemRush(dest);
      else fmsg('YOU HAVE CONQUERED THE VOID','#ffd700');
    }
  }

  // Active buffs countdown
  for(var bfi=g.activeBuffs.length-1;bfi>=0;bfi--){g.activeBuffs[bfi].t-=dt;if(g.activeBuffs[bfi].t<=0){var bf3=g.activeBuffs[bfi];if(bf3.onEnd)bf3.onEnd(g);g.activeBuffs.splice(bfi,1);}}
  renderBuffs();if(g.killStreakT>0)g.killStreakT-=dt;else g.killStreak=0;

  // Ability timers
  if(g._singularityCd>0)g._singularityCd-=dt;
  // Rail laser sustained beam
  if(g._railLaser&&g._railLaser.life>0){
    g._railLaser.life-=dt;
    g._railLaser.dmgTick-=dt;
    if(g._railLaser.dmgTick<=0){
      g._railLaser.dmgTick=0.06; // damage every 60ms
      var rl=g._railLaser,p2=g.player,a2=p2.aimAngle;
      var cos2=Math.cos(a2),sin2=Math.sin(a2);
      var dmg=rl.dmgPerSec*0.06;
      for(var rli=0;rli<g.enemies.length;rli++){
        var re=g.enemies[rli];
        var rdx=re.x-p2.x,rdy=re.y-p2.y;
        var rdot=rdx*cos2+rdy*sin2;
        var rpx=rdx-rdot*cos2,rpy=rdy-rdot*sin2;
        if(rdot>0&&Math.sqrt(rpx*rpx+rpy*rpy)<55){
          hitE(g,re,dmg);
          // Small impact sparks
          if(Math.random()<0.4) burst(g,re.x,re.y,'#ff3366',4,80);
        }
      }
    }
    if(g._railLaser.life<=0) g._railLaser=null;
  }
  if(g._chainExplosive>0)g._chainExplosive-=dt;
  if(g._scatterFrenzy>0){
    g._scatterFrenzy-=dt;
    if(g._scatterFrenzy<=0){var bd2=BEAM_DEFS.find(function(b){return b.id===ownedBeam();});if(bd2){var bs2=getBeamStats();g.gun.cd=bs2.cd;}fmsg('SCATTER FRENZY ENDED','#ff6a00');}
  }

  // Particles
  for(var pti=g.particles.length-1;pti>=0;pti--){var pt=g.particles[pti];pt.life-=dt;if(pt.life<=0){g.particles.splice(pti,1);continue;}if(pt.type!=='ring'){pt.x+=pt.vx*dt;pt.y+=pt.vy*dt;pt.vx*=.88;pt.vy*=.88;}else pt.radius+=(pt.maxR/pt.maxLife)*dt;}
}

function hitE(g,e,dmg){
  if(g.enemies.indexOf(e)<0)return;
  // Phase shield blocks all damage
  if(e.phaseShield){burst(g,e.x,e.y,'#88aaff',3,50);return;}
  // Beam overheat ‚Äî only blocks turret/beam during boss fight
  if(g.beamOverheated&&e.isBoss&&dmg>50){dmg*=0.05;}
  e.hp-=dmg;e.flashTimer=.1;
  if(e.hp<=0){
    // Elite glow
    if(e.isElite&&!e.isBoss){
      ctx.strokeStyle='#ffd700';ctx.lineWidth=3+Math.sin(gtime*8)*1.5;
      ctx.shadowBlur=18;ctx.shadowColor='#ffd700';
      ctx.beginPath();ctx.arc(0,0,e.r+5,0,Math.PI*2);ctx.stroke();ctx.shadowBlur=0;
      ctx.font='bold 7px Orbitron,monospace';ctx.fillStyle='#ffd700';ctx.textAlign='center';ctx.textBaseline='bottom';
      ctx.fillText('ELITE',0,-e.r-6);
    }
    if(e.isBoss){
      SFX.bossDie();
      g.bossAlive=false;g.bossFought=true;g.killsForBoss=0;
      document.getElementById('bb').style.display='none';
      for(var i=0;i<22;i++){(function(ii){setTimeout(function(){burst(g,e.x+(Math.random()-.5)*100,e.y+(Math.random()-.5)*100,e.color,20,250);},ii*70);})(i);}
      var co=e.coins||25;crystals+=co;lsS('vr_crystals',crystals);g.crystalsRun+=co;fmsg('OVERLORD SLAIN +'+co+' CRYSTALS','#ffd700');
      for(var oi=0;oi<12;oi++)g.orbs.push({x:e.x+(Math.random()-.5)*120,y:e.y+(Math.random()-.5)*120,val:Math.round(e.xpVal/12*(g.player.xpMult||1)),life:20});
      incLS('bossKills');
      markBossDefeated(g.galaxy||0);
      var essGain=3+(g.galaxy||0)+(g._essenceBonus||0);
      voidEssence+=essGain; lsS('vr_essence',voidEssence);
      fmsg('\u{1F49C} +'+essGain+' VOID ESSENCE','#aa00ff');; lsS('vr_bossesDefeated',bossesDefeated);
      // Drop Void Essence ‚Äî 1 base + 1 per prestige
      var _vb=getVoidBonus();
      var essenceDrop = 1 + prestigeCount + (_vb.essenceBonus||0);
      voidEssence += essenceDrop; lsS('vr_essence', voidEssence);
      fmsg('üü£ +'+essenceDrop+' VOID ESSENCE','#9b59ff');
      // Spawn relic orb if enabled and cap not reached
      if(g.relics.length<RELIC_CAP){
        var relic=pickRelicForGalaxy(g.galaxy||0);
        g.worldPickups.push({x:e.x,y:e.y+(e.r+40),type:{id:'relic_'+relic.id,icon:relic.icon,label:relic.name,color:'#9b59ff',dur:0,
          onGet:function(){collectRelic(g,relic);}},bob:0,life:99,isRelic:true});
        var _rcx=G?G.camera.x:0,_rcy=G?G.camera.y:0;
        var _rx=(e.x-_rcx)+W/2,_ry=(e.y+(e.r+40)-_rcy)+H/2;
        tutCheckRelic(relic, _rx, _ry);
      }
      // Spawn galaxy portal at boss location
      g.portal={x:e.x,y:e.y,r:55,angle:0,life:0,pulseT:0,galaxyTo:currentGalaxy+1};
      showWA('PORTAL OPENED\nENTER TO WARP','#9b59ff');
      tutCheckWarp();
    }else{g.kills++;g.killsForBoss=(g.killsForBoss||0)+1;
      if(g.vampActive||g._lifeSteal>0){var heal=(g.vampActive?5:0)+(g._lifeSteal||0);g.player.hp=Math.min(g.player.maxHp,g.player.hp+heal);}
      g.killStreak++;g.killStreakT=1.5;showKill(g.killStreak);burst(g,e.x,e.y,e.color,10,100);addOrb(g,e);SFX.enemyDie();
      // Elite drop
      if(e.isElite){var ec=30+Math.floor(Math.random()*30);crystals+=ec;lsS('vr_crystals',crystals);fmsg('üëë ELITE SLAIN +'+ec+' CRYSTALS','#ffd700');burst(g,e.x,e.y,'#ffd700',20,160);}
      // Relic: ring resonance
      if(g._ringResonance>0&&Math.random()<0.25*g._ringResonance){g.particles.push({type:'ring',x:p.x,y:p.y,radius:0,maxR:120+g._ringResonance*30,life:.5,maxLife:.5,color:'#9b59ff'});for(var ri=0;ri<g.enemies.length;ri++){if(!g.enemies[ri].isBoss&&dst(p,g.enemies[ri])<140)hitE(g,g.enemies[ri],40*g._ringResonance);}}
      // Relic: spiral core ‚Äî bonus XP orb
      if(g._spiralCore>0&&Math.random()<g._spiralCore){g.orbs.push({x:e.x,y:e.y,val:Math.round(e.xpVal*(g.player.xpMult||1)*2),life:15});}
      // Relic: parasite swarm
      if(g._parasiteChance>0&&Math.random()<g._parasiteChance){
        var da=g.player.aimAngle;
        g.worldPickups.push({x:e.x,y:e.y,type:{id:'drone',icon:'ü§ñ',label:'COMBAT DRONE',color:'#9b59ff',dur:8,
          onGet:function(gg){gg.activeDrones=(gg.activeDrones||0)+1;setTimeout(function(){gg.activeDrones=Math.max(0,(gg.activeDrones||0)-1);},8000);},
          onEnd:function(){}},bob:0,life:6});
      }
      incLS('kills');
      if(g.killStreak>LS.highestKillStreak){LS.highestKillStreak=g.killStreak;saveLS();checkBadgeUnlocks();}
    }
    g.enemies.splice(g.enemies.indexOf(e),1);
  }
}
function collectPK(g,t){if(t.id!=='cryst')fmsg(t.icon+' '+t.label,t.color);t.onGet(g);SFX.pickup();incLS('pickupsCollected');if(t.dur>0)g.activeBuffs.push({icon:t.icon,label:t.label,color:t.color,t:t.dur,maxT:t.dur,onEnd:t.onEnd});}
function renderBuffs(){var row=document.getElementById('brow');row.innerHTML='';for(var i=0;i<G.activeBuffs.length;i++){var b=G.activeBuffs[i];var d=document.createElement('div');d.className='bch';d.style.borderColor=b.color+'44';d.innerHTML=b.icon+' <span style="color:'+b.color+'">'+b.label+'</span> <span class="bt2">'+b.t.toFixed(1)+'s</span>';row.appendChild(d);}}
function renderPHud(){var row=document.getElementById('prow');row.innerHTML='';var all=[].concat(PERM_DEFS.SHIP,PERM_DEFS.WEAPONS,PERM_DEFS.ABILITIES);for(var i=0;i<all.length;i++){var r=pRank(all[i].id);if(!r)continue;var d=document.createElement('div');d.className='pch';d.textContent=all[i].icon+r;row.appendChild(d);}}

// ‚îÄ‚îÄ‚îÄ RENDER ‚îÄ‚îÄ‚îÄ
var gtime=0;
function render(){
  var g=G,cx=g.camera.x,cy=g.camera.y,p=g.player;
  ctx.fillStyle='#02020a';ctx.fillRect(0,0,W,H);
  if(bgC)ctx.drawImage(bgC,-(cx*.68+WORLD/2-W/2),-(cy*.68+WORLD/2-H/2));
  ctx.strokeStyle='rgba(0,245,255,0.08)';ctx.lineWidth=2;ctx.strokeRect(-cx,-cy,WORLD,WORLD);

  var galAcc=(GALAXIES[currentGalaxy]||GALAXIES[0]).acc;

  // Background asteroids (decorative, rotate in place)
  for(var i=0;i<bgAsteroids.length;i++){
    var ast=bgAsteroids[i],sx=ast.x-cx,sy=ast.y-cy;
    if(sx<-130||sx>W+130||sy<-130||sy>H+130)continue;
    ctx.save();ctx.translate(sx,sy);ctx.rotate(gtime*ast.rotSpd);
    ctx.fillStyle='#3a3a4a';ctx.strokeStyle='#606075';ctx.lineWidth=1;
    ctx.beginPath();ctx.moveTo(ast.verts[0][0],ast.verts[0][1]);for(var v=0;v<ast.verts.length;v++)ctx.lineTo(ast.verts[v][0],ast.verts[v][1]);ctx.closePath();ctx.fill();ctx.stroke();ctx.restore();
  }

  // Poison clouds (G5 Bio-Nebula)
  if(g.poisonClouds){
    for(var pci2=0;pci2<g.poisonClouds.length;pci2++){
      var pc3=g.poisonClouds[pci2];var pcsx=pc3.x-cx,pcsy=pc3.y-cy;
      if(pcsx<-pc3.r-50||pcsx>W+pc3.r+50||pcsy<-pc3.r-50||pcsy>H+pc3.r+50)continue;
      var pcAlpha=(pc3.life/pc3.maxLife)*0.25;
      ctx.save();var pcGrad=ctx.createRadialGradient(pcsx,pcsy,0,pcsx,pcsy,pc3.r);
      pcGrad.addColorStop(0,'rgba(60,255,100,'+pcAlpha+')');pcGrad.addColorStop(0.6,'rgba(30,180,60,'+(pcAlpha*0.5)+')');pcGrad.addColorStop(1,'transparent');
      ctx.fillStyle=pcGrad;ctx.beginPath();ctx.arc(pcsx,pcsy,pc3.r,0,Math.PI*2);ctx.fill();ctx.restore();
    }
  }

  // Galaxy portal
  if(g.portal){
    var pt=g.portal,sx=pt.x-cx,sy=pt.y-cy;
    ctx.save();ctx.translate(sx,sy);
    // Outer glow ring
    ctx.shadowBlur=40;ctx.shadowColor='#9b59ff';
    for(var pi=0;pi<3;pi++){
      ctx.strokeStyle='rgba(155,89,255,'+(0.6-pi*0.15)+')';
      ctx.lineWidth=4-pi;
      ctx.beginPath();ctx.arc(0,0,pt.r+pi*8+Math.sin(gtime*3+pi)*4,0,Math.PI*2);ctx.stroke();
    }
    // Spinning inner vortex lines
    ctx.shadowBlur=20;
    for(var si=0;si<8;si++){
      var sa=pt.angle+(si/8)*Math.PI*2;
      ctx.strokeStyle='rgba(155,89,255,'+(0.4+0.4*Math.sin(gtime*4+si))+')';
      ctx.lineWidth=2;ctx.beginPath();ctx.moveTo(0,0);
      ctx.lineTo(Math.cos(sa)*(pt.r*0.8),Math.sin(sa)*(pt.r*0.8));ctx.stroke();
    }
    // Center swirl fill
    var grad=ctx.createRadialGradient(0,0,0,0,0,pt.r);
    grad.addColorStop(0,'rgba(155,89,255,0.5)');
    grad.addColorStop(0.5,'rgba(100,50,200,0.2)');
    grad.addColorStop(1,'rgba(0,0,0,0)');
    ctx.fillStyle=grad;ctx.beginPath();ctx.arc(0,0,pt.r,0,Math.PI*2);ctx.fill();
    ctx.shadowBlur=0;ctx.restore();
    // Label
    ctx.font='bold 9px Orbitron,monospace';ctx.fillStyle='#9b59ff';ctx.textAlign='center';ctx.textBaseline='bottom';
    ctx.fillText('GALAXY '+(pt.galaxyTo+1)+' PORTAL',sx,sy-pt.r-8);
    ctx.font='8px Orbitron,monospace';ctx.fillStyle='rgba(155,89,255,0.7)';
    ctx.fillText('ENTER TO WARP',sx,sy-pt.r+4);
  }

  // World pickups
  for(var i=0;i<g.worldPickups.length;i++){
    var pk=g.worldPickups[i],sx=pk.x-cx,sy=pk.y-cy;if(sx<-60||sx>W+60||sy<-60||sy>H+60)continue;
    var bob=Math.sin(pk.bob)*6,pulse=.7+.3*Math.sin(pk.bob*1.3);
    ctx.save();ctx.shadowBlur=22;ctx.shadowColor=pk.type.color;
    ctx.beginPath();ctx.arc(sx,sy+bob,20,0,Math.PI*2);ctx.fillStyle=pk.type.color+'18';ctx.fill();ctx.strokeStyle=pk.type.color;ctx.lineWidth=1.5;ctx.stroke();
    // Draw heart shape for health pickups, icon for others
    var isHp=pk.type.id==='hp25'||pk.type.id==='hp50'||pk.type.id==='hpfull';
    if(isHp){
      ctx.save();ctx.translate(sx,sy+bob);ctx.scale(pulse,pulse);
      ctx.fillStyle=pk.type.color;ctx.shadowColor=pk.type.color;ctx.shadowBlur=16;
      ctx.beginPath();
      ctx.moveTo(0,6);ctx.bezierCurveTo(0,3,-5,-2,-5,-5);ctx.bezierCurveTo(-5,-10,5,-10,0,-4);ctx.bezierCurveTo(5,-10,12,-10,12,-5);ctx.bezierCurveTo(12,-2,8,3,0,6);
      ctx.fill();ctx.restore();
      var hpAmt=pk.type.id==='hpfull'?'FULL':pk.type.id==='hp50'?'+50':'+25';
      ctx.font='bold 9px Orbitron,monospace';ctx.fillStyle=pk.type.color;ctx.textAlign='center';ctx.textBaseline='top';ctx.fillText(hpAmt,sx,sy+bob+16);
    } else {
      ctx.font=(20*pulse)+'px serif';ctx.textAlign='center';ctx.textBaseline='middle';ctx.fillStyle='#fff';ctx.fillText(pk.type.icon,sx,sy+bob);ctx.restore();
      ctx.font='bold 8px Orbitron,monospace';ctx.fillStyle=pk.type.color;ctx.textAlign='center';ctx.textBaseline='top';ctx.fillText(pk.type.label,sx,sy+bob+25);
    }
  }

  // Particles
  for(var i=0;i<g.particles.length;i++){
    var pt=g.particles[i],sx=pt.x-cx,sy=pt.y-cy;
    if(pt.type==='ring'){ctx.save();ctx.strokeStyle=pt.color;ctx.lineWidth=2;ctx.globalAlpha=Math.max(0,pt.life/pt.maxLife);ctx.beginPath();ctx.arc(sx,sy,pt.radius,0,Math.PI*2);ctx.stroke();ctx.restore();}
    else if(pt.type==='gem'){ctx.save();ctx.globalAlpha=Math.min(1,pt.life*1.4);ctx.fillStyle=pt.color;ctx.strokeStyle='#ffffff';ctx.lineWidth=1;ctx.shadowBlur=12;ctx.shadowColor=pt.color;ctx.translate(sx,sy);ctx.rotate(gtime*4+pt.vx*.01);var gs=pt.sz;ctx.beginPath();ctx.moveTo(0,-gs);ctx.lineTo(gs*.6,0);ctx.lineTo(0,gs);ctx.lineTo(-gs*.6,0);ctx.closePath();ctx.fill();ctx.stroke();ctx.restore();}
    else{ctx.save();ctx.globalAlpha=Math.min(1,pt.life*2.2);ctx.fillStyle=pt.color;ctx.shadowBlur=5;ctx.shadowColor=pt.color;ctx.beginPath();ctx.arc(sx,sy,pt.sz,0,Math.PI*2);ctx.fill();ctx.restore();}
  }

  // Escort gunships
  if(g.escorts&&g.escorts.length>0){
    for(var esi=0;esi<g.escorts.length;esi++){
      var es=g.escorts[esi];
      if(!es.x)continue;
      var esx=es.x-cx,esy=es.y-cy;
      ctx.save();ctx.translate(esx,esy);
      ctx.shadowBlur=14;ctx.shadowColor='#ff6a00';
      // Draw mini ship
      ctx.fillStyle='#ff6a00';ctx.beginPath();ctx.moveTo(0,-10);ctx.lineTo(-6,7);ctx.lineTo(0,4);ctx.lineTo(6,7);ctx.closePath();ctx.fill();
      // Engine glow
      var eg=ctx.createRadialGradient(0,8,0,0,8,6);eg.addColorStop(0,'rgba(255,200,0,0.8)');eg.addColorStop(1,'rgba(255,100,0,0)');
      ctx.fillStyle=eg;ctx.beginPath();ctx.arc(0,9,5,0,Math.PI*2);ctx.fill();
      ctx.restore();
    }
  }

  // XP orbs
  for(var i=0;i<g.orbs.length;i++){var orb=g.orbs[i],sx=orb.x-cx,sy=orb.y-cy;if(sx<-20||sx>W+20||sy<-20||sy>H+20)continue;var pulse=.65+.35*Math.sin(gtime*10+orb.x);ctx.save();ctx.shadowBlur=14;ctx.shadowColor='#00f5ff';ctx.fillStyle='rgba(0,245,255,'+pulse+')';ctx.beginPath();ctx.arc(sx,sy,5*pulse,0,Math.PI*2);ctx.fill();ctx.restore();}

  // Live destroyable asteroids
  for(var i=0;i<g.liveAsteroids.length;i++){
    var ast=g.liveAsteroids[i],sx=ast.x-cx,sy=ast.y-cy;if(sx<-130||sx>W+130||sy<-130||sy>H+130)continue;
    var hpPct=ast.hp/ast.maxHp;
    ctx.save();ctx.translate(sx,sy);ctx.rotate(ast.rot);
    ctx.fillStyle=ast.flashTimer>0?'#ffffff':'#4a4a5e';
    ctx.strokeStyle=ast.flashTimer>0?'#ffffff':galAcc+'55';ctx.lineWidth=1.5;
    ctx.shadowBlur=ast.flashTimer>0?20:5;ctx.shadowColor=ast.flashTimer>0?'#ffffff':galAcc+'44';
    ctx.beginPath();ctx.moveTo(ast.verts[0][0],ast.verts[0][1]);for(var v=0;v<ast.verts.length;v++)ctx.lineTo(ast.verts[v][0],ast.verts[v][1]);ctx.closePath();ctx.fill();ctx.stroke();
    if(hpPct>0.5){ctx.fillStyle='rgba(0,245,255,0.15)';ctx.beginPath();ctx.arc(0,0,ast.r*.35,0,Math.PI*2);ctx.fill();}
    if(hpPct<0.6){ctx.strokeStyle='rgba(255,160,80,0.45)';ctx.lineWidth=1;ctx.beginPath();ctx.moveTo(-ast.r*.5,0);ctx.lineTo(ast.r*.3,ast.r*.25);ctx.stroke();ctx.beginPath();ctx.moveTo(0,-ast.r*.4);ctx.lineTo(ast.r*.2,ast.r*.4);ctx.stroke();}
    for(var di=0;di<5;di++){ctx.beginPath();ctx.arc(-ast.r*.7+di*ast.r*.36,-ast.r-5,2.5,0,Math.PI*2);ctx.fillStyle=di<Math.ceil(hpPct*5)?galAcc:'#222';ctx.shadowBlur=di<Math.ceil(hpPct*5)?6:0;ctx.shadowColor=galAcc;ctx.fill();}
    ctx.restore();
  }

  // UFO enemies
  for(var i=0;i<g.enemies.length;i++){
    var e=g.enemies[i],sx=e.x-cx,sy=e.y-cy;if(sx<-90||sx>W+90||sy<-90||sy>H+90)continue;
    e.spinAngle=(e.spinAngle||0)+(e.isBoss?.018:.045);
    ctx.save();ctx.translate(sx,sy);
    var col=e.frozen>0?'#88ddff':e.flashTimer>0?'#ffffff':e.color;
    ctx.shadowBlur=e.isBoss?24:12;ctx.shadowColor=col;
    // ‚îÄ‚îÄ Shape draw ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    if(e.isBoss){
      drawBossShape(ctx,e,col,gtime);
    } else {
      drawEnemyShape(ctx,e,col,gtime);
    }
    // ‚îÄ‚îÄ HP bar ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    var hpPct=Math.max(0,e.hp/e.maxHp);
    ctx.fillStyle='rgba(0,0,0,0.5)';ctx.fillRect(-e.r*1.4,-e.r-9,e.r*2.8,4);
    ctx.fillStyle=hpPct>.5?'#39ff8a':hpPct>.25?'#ffcc22':'#ff3366';ctx.fillRect(-e.r*1.4,-e.r-9,e.r*2.8*hpPct,4);
    if(e.isBoss){
      var bpulse=1+.12*Math.sin(gtime*4);
      if(e.phaseShield){
        ctx.strokeStyle='#88aaff';ctx.lineWidth=5+3*Math.sin(gtime*12);
        ctx.shadowBlur=30;ctx.shadowColor='#88aaff';
        ctx.globalAlpha=0.7+0.3*Math.sin(gtime*10);
        ctx.beginPath();ctx.arc(0,0,e.r+16,0,Math.PI*2);ctx.stroke();
        ctx.globalAlpha=1;ctx.shadowBlur=0;
      }
      if(e.charging){
        ctx.globalAlpha=0.4+0.4*Math.sin(gtime*20);
        ctx.fillStyle=e.color;ctx.beginPath();ctx.arc(0,0,e.r*1.6,0,Math.PI*2);ctx.fill();
        ctx.globalAlpha=1;
      }
      ctx.strokeStyle=e.enraged?'#ff3366':e.color;ctx.lineWidth=3;ctx.shadowBlur=22;ctx.shadowColor=e.enraged?'#ff3366':e.color;
      ctx.beginPath();ctx.arc(0,0,e.r*bpulse+7,0,Math.PI*2);ctx.stroke();ctx.shadowBlur=0;
      ctx.font='bold 9px Orbitron,monospace';ctx.fillStyle=e.enraged?'#ff3366':'#ffd700';
      ctx.textAlign='center';ctx.textBaseline='bottom';
      ctx.fillText((e.enraged?'‚ò¢ ':e.phaseShield?'üõ° ':'')+e.name,0,-e.r-12);
    }
    if(e.isElite){
      ctx.strokeStyle='#ffd700';ctx.lineWidth=2;ctx.setLineDash([4,3]);
      ctx.beginPath();ctx.arc(0,0,e.r+5,0,Math.PI*2);ctx.stroke();ctx.setLineDash([]);
    }
    if(e.frozen>0){ctx.strokeStyle='#88ddff';ctx.lineWidth=2;ctx.beginPath();ctx.arc(0,0,e.r+2,0,Math.PI*2);ctx.stroke();}
    ctx.restore();
  }


// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ENEMY SHAPE RENDERING ‚Äî per-galaxy themed designs
// Galaxy themes:
//  0 Drift Sector    ‚Äî classic UFOs / scout fighters
//  1 Leviathan Field ‚Äî serpent/eel segments
//  2 Machine Remnant ‚Äî angular drones / turret hexagons
//  3 Meteor Storm    ‚Äî jagged rock parasites
//  4 Bio-Nebula      ‚Äî pulsing sacs / spores
//  5 Cryo Ring       ‚Äî crystalline shards / snowflakes
//  6 Pulsar Corridor ‚Äî energy beings / lightning nodes
//  7 Graviton Abyss  ‚Äî void orbs / distorted shapes
//  8 Mirror Expanse  ‚Äî clone ships (mirror of player)
//  9 Void Heart      ‚Äî hybrid elites from all prior
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

function drawEnemyShape(ctx,e,col,t){
  var r=e.r,g2=e.galaxy||0,ti=e.typeIdx||0,ang=e.spinAngle||0;
  ctx.strokeStyle=col;ctx.fillStyle=col;

  // Elite golden aura drawn before shape
  if(e.isElite){ctx.save();ctx.shadowBlur=28;ctx.shadowColor='#ffd700';ctx.restore();}

  switch(g2){
    // ‚îÄ‚îÄ G0 Drift Sector: UFO scouts + fighters ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    case 0: default:
      ctx.save();ctx.rotate(ang);
      if(ti===4){
        // Kamikaze ‚Äî sharp dart
        ctx.fillStyle=col+'44';ctx.beginPath();ctx.moveTo(0,-r*1.4);ctx.lineTo(r*.7,r*.8);ctx.lineTo(0,r*.3);ctx.lineTo(-r*.7,r*.8);ctx.closePath();ctx.fill();
        ctx.strokeStyle=col;ctx.lineWidth=1.5;ctx.beginPath();ctx.moveTo(0,-r*1.4);ctx.lineTo(r*.7,r*.8);ctx.lineTo(0,r*.3);ctx.lineTo(-r*.7,r*.8);ctx.closePath();ctx.stroke();
      } else if(ti===3){
        // Heavy ‚Äî wide saucer
        ctx.fillStyle=col+'33';ctx.beginPath();ctx.ellipse(0,0,r*1.5,r*.55,0,0,Math.PI*2);ctx.fill();
        ctx.strokeStyle=col;ctx.lineWidth=2;ctx.beginPath();ctx.ellipse(0,0,r*1.5,r*.55,0,0,Math.PI*2);ctx.stroke();
        ctx.fillStyle=col+'66';ctx.beginPath();ctx.ellipse(0,-r*.15,r*.8,r*.5,0,Math.PI,Math.PI*2);ctx.fill();
      } else {
        // Standard UFO
        ctx.fillStyle=col+'33';ctx.beginPath();ctx.ellipse(0,0,r*1.35,r*.45,0,0,Math.PI*2);ctx.fill();
        ctx.strokeStyle=col;ctx.lineWidth=1.5;ctx.beginPath();ctx.ellipse(0,0,r*1.35,r*.45,0,0,Math.PI*2);ctx.stroke();
        ctx.fillStyle=col+'55';ctx.beginPath();ctx.ellipse(0,-r*.15,r*.65,r*.42,0,Math.PI,Math.PI*2);ctx.fill();
        ctx.strokeStyle=col;ctx.lineWidth=1;ctx.beginPath();ctx.ellipse(0,-r*.15,r*.65,r*.42,0,Math.PI,Math.PI*2);ctx.stroke();
        for(var li=0;li<4;li++){var la=(li/4)*Math.PI*2,lp=.4+.6*Math.sin(t*5+li*1.6);ctx.fillStyle='rgba(255,255,80,'+lp+')';ctx.beginPath();ctx.arc(Math.cos(la)*r*.95,Math.sin(la)*r*.35,2,0,Math.PI*2);ctx.fill();}
      }
      ctx.restore();
      break;

    // ‚îÄ‚îÄ G1 Leviathan Field: serpent segments ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    case 1:
      ctx.save();ctx.rotate(ang);
      // Eel body segment ‚Äî oval with spines
      var pulse=0.9+0.1*Math.sin(t*4+e.x*.01);
      ctx.fillStyle=col+'22';ctx.beginPath();ctx.ellipse(0,0,r*1.1*pulse,r*.7,0,0,Math.PI*2);ctx.fill();
      ctx.strokeStyle=col;ctx.lineWidth=2;ctx.beginPath();ctx.ellipse(0,0,r*1.1*pulse,r*.7,0,0,Math.PI*2);ctx.stroke();
      // Spines along top
      ctx.lineWidth=1.5;
      for(var si2=0;si2<3;si2++){var sx2=(si2-1)*r*.5,shy=-r*.7-r*.35*(1-Math.abs(si2-1)*.4);ctx.strokeStyle=col;ctx.beginPath();ctx.moveTo(sx2,shy+r*.25);ctx.lineTo(sx2+(si2-1)*r*.2,shy);ctx.stroke();}
      // Eyes
      ctx.fillStyle='#fff';ctx.shadowBlur=0;
      ctx.beginPath();ctx.arc(-r*.28,-r*.15,r*.16,0,Math.PI*2);ctx.fill();
      ctx.beginPath();ctx.arc(r*.28,-r*.15,r*.16,0,Math.PI*2);ctx.fill();
      ctx.fillStyle='#111';
      ctx.beginPath();ctx.arc(-r*.28,-r*.15,r*.08,0,Math.PI*2);ctx.fill();
      ctx.beginPath();ctx.arc(r*.28,-r*.15,r*.08,0,Math.PI*2);ctx.fill();
      ctx.restore();
      break;

    // ‚îÄ‚îÄ G2 Machine Remnant: angular drones / hex turrets ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    case 2:
      ctx.save();ctx.rotate(ang);
      if(ti===2||ti===4){
        // Shooter/kamikaze ‚Äî thin diamond drone
        ctx.fillStyle=col+'22';ctx.beginPath();ctx.moveTo(0,-r*1.2);ctx.lineTo(r*.7,0);ctx.lineTo(0,r*1.2);ctx.lineTo(-r*.7,0);ctx.closePath();ctx.fill();
        ctx.strokeStyle=col;ctx.lineWidth=1.5;ctx.beginPath();ctx.moveTo(0,-r*1.2);ctx.lineTo(r*.7,0);ctx.lineTo(0,r*1.2);ctx.lineTo(-r*.7,0);ctx.closePath();ctx.stroke();
        // Center core
        ctx.fillStyle=col;ctx.beginPath();ctx.arc(0,0,r*.25,0,Math.PI*2);ctx.fill();
        // Wing scan lines
        ctx.lineWidth=1;ctx.strokeStyle=col+'66';
        ctx.beginPath();ctx.moveTo(-r*.5,0);ctx.lineTo(r*.5,0);ctx.stroke();
        ctx.beginPath();ctx.moveTo(0,-r*.8);ctx.lineTo(0,r*.8);ctx.stroke();
      } else {
        // Standard ‚Äî hexagon turret
        ctx.fillStyle=col+'22';ctx.beginPath();
        for(var hi=0;hi<6;hi++){var ha=hi/6*Math.PI*2;ctx.lineTo(Math.cos(ha)*r,Math.sin(ha)*r);}
        ctx.closePath();ctx.fill();
        ctx.strokeStyle=col;ctx.lineWidth=2;ctx.beginPath();
        for(var hi=0;hi<6;hi++){var ha=hi/6*Math.PI*2;ctx.lineTo(Math.cos(ha)*r,Math.sin(ha)*r);}
        ctx.closePath();ctx.stroke();
        // Inner structure
        ctx.lineWidth=1;ctx.strokeStyle=col+'55';ctx.beginPath();
        for(var hi=0;hi<6;hi++){var ha=hi/6*Math.PI*2;ctx.moveTo(0,0);ctx.lineTo(Math.cos(ha)*r*.7,Math.sin(ha)*r*.7);}
        ctx.stroke();
        ctx.fillStyle=col;ctx.beginPath();ctx.arc(0,0,r*.22,0,Math.PI*2);ctx.fill();
        // Scan pulse ring
        var sp=0.5+0.5*Math.sin(t*6);
        ctx.strokeStyle=col+'44';ctx.lineWidth=1;ctx.beginPath();ctx.arc(0,0,r*.5+sp*r*.3,0,Math.PI*2);ctx.stroke();
      }
      ctx.restore();
      break;

    // ‚îÄ‚îÄ G3 Meteor Storm: jagged rock parasites ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    case 3:
      ctx.save();ctx.rotate(ang);
      // Jagged asteroid shape
      ctx.fillStyle=col+'33';ctx.beginPath();
      var pts3=7+ti;
      for(var pi3=0;pi3<=pts3;pi3++){
        var pa=(pi3/pts3)*Math.PI*2;
        var pr=r*(0.6+0.4*Math.sin(pi3*2.3+e.x*.05));
        if(pi3===0)ctx.moveTo(Math.cos(pa)*pr,Math.sin(pa)*pr);
        else ctx.lineTo(Math.cos(pa)*pr,Math.sin(pa)*pr);
      }
      ctx.closePath();ctx.fill();
      ctx.strokeStyle=col;ctx.lineWidth=2;ctx.beginPath();
      for(var pi3=0;pi3<=pts3;pi3++){
        var pa=(pi3/pts3)*Math.PI*2;
        var pr=r*(0.6+0.4*Math.sin(pi3*2.3+e.x*.05));
        if(pi3===0)ctx.moveTo(Math.cos(pa)*pr,Math.sin(pa)*pr);
        else ctx.lineTo(Math.cos(pa)*pr,Math.sin(pa)*pr);
      }
      ctx.closePath();ctx.stroke();
      // Parasite eyes ‚Äî orange glowing dots
      var ep=0.5+0.5*Math.sin(t*3+e.y*.01);
      ctx.fillStyle='rgba(255,140,0,'+ep+')';ctx.shadowColor='#ff8800';ctx.shadowBlur=8;
      ctx.beginPath();ctx.arc(-r*.25,-r*.2,r*.12,0,Math.PI*2);ctx.fill();
      ctx.beginPath();ctx.arc(r*.25,-r*.2,r*.12,0,Math.PI*2);ctx.fill();
      ctx.restore();
      break;

    // ‚îÄ‚îÄ G4 Bio-Nebula: pulsing sacs / spores ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    case 4:
      ctx.save();ctx.rotate(ang);
      var bpulse2=0.88+0.12*Math.sin(t*3.5+e.x*.008);
      // Outer membrane
      ctx.fillStyle=col+'18';ctx.beginPath();ctx.arc(0,0,r*1.15*bpulse2,0,Math.PI*2);ctx.fill();
      // Membrane wall
      ctx.strokeStyle=col+'99';ctx.lineWidth=3;ctx.beginPath();ctx.arc(0,0,r*1.0*bpulse2,0,Math.PI*2);ctx.stroke();
      // Inner nucleus
      ctx.fillStyle=col+'55';ctx.beginPath();ctx.arc(0,0,r*.5*bpulse2,0,Math.PI*2);ctx.fill();
      ctx.fillStyle=col;ctx.beginPath();ctx.arc(0,0,r*.2,0,Math.PI*2);ctx.fill();
      // Flagella tentacles
      ctx.lineWidth=1.5;ctx.strokeStyle=col+'77';
      for(var fi=0;fi<5;fi++){
        var fa=fi/5*Math.PI*2+ang*0.5;
        var fw=Math.sin(t*4+fi)*r*.3;
        ctx.beginPath();ctx.moveTo(Math.cos(fa)*r,Math.sin(fa)*r);
        ctx.quadraticCurveTo(Math.cos(fa+0.5)*r*1.4+fw,Math.sin(fa+0.5)*r*1.4,Math.cos(fa+0.8)*r*1.7,Math.sin(fa+0.8)*r*1.7);
        ctx.stroke();
      }
      ctx.restore();
      break;

    // ‚îÄ‚îÄ G5 Cryo Ring: crystalline shards ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    case 5:
      ctx.save();ctx.rotate(ang);
      // Crystal facets
      var facets=ti===3?8:ti===4?5:6;
      ctx.fillStyle=col+'25';ctx.beginPath();
      for(var ci2=0;ci2<facets;ci2++){
        var ca2=(ci2/facets)*Math.PI*2;
        var cr=ci2%2===0?r:r*.6;
        if(ci2===0)ctx.moveTo(Math.cos(ca2)*cr,Math.sin(ca2)*cr);
        else ctx.lineTo(Math.cos(ca2)*cr,Math.sin(ca2)*cr);
      }
      ctx.closePath();ctx.fill();
      ctx.strokeStyle=col;ctx.lineWidth=2;ctx.beginPath();
      for(var ci2=0;ci2<facets;ci2++){
        var ca2=(ci2/facets)*Math.PI*2;
        var cr=ci2%2===0?r:r*.6;
        if(ci2===0)ctx.moveTo(Math.cos(ca2)*cr,Math.sin(ca2)*cr);
        else ctx.lineTo(Math.cos(ca2)*cr,Math.sin(ca2)*cr);
      }
      ctx.closePath();ctx.stroke();
      // Inner ice core glow
      var icep=0.4+0.3*Math.sin(t*2);
      ctx.fillStyle='rgba(180,240,255,'+icep+')';ctx.beginPath();ctx.arc(0,0,r*.3,0,Math.PI*2);ctx.fill();
      ctx.restore();
      break;

    // ‚îÄ‚îÄ G6 Pulsar Corridor: energy beings ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    case 6:
      ctx.save();ctx.rotate(ang);
      // Core orb
      ctx.fillStyle=col+'22';ctx.beginPath();ctx.arc(0,0,r,0,Math.PI*2);ctx.fill();
      ctx.strokeStyle=col;ctx.lineWidth=2;ctx.beginPath();ctx.arc(0,0,r*.75,0,Math.PI*2);ctx.stroke();
      // Energy arcs
      var arcs=ti===3?6:4;
      for(var ai2=0;ai2<arcs;ai2++){
        var aa2=ai2/arcs*Math.PI*2+t*2;
        var ax1=Math.cos(aa2)*r*.4,ay1=Math.sin(aa2)*r*.4;
        var ax2=Math.cos(aa2+0.9)*r*1.1,ay2=Math.sin(aa2+0.9)*r*1.1;
        var jitter=Math.sin(t*15+ai2*2)*r*.15;
        ctx.strokeStyle=col;ctx.lineWidth=1.5;ctx.shadowBlur=16;ctx.shadowColor=col;
        ctx.beginPath();ctx.moveTo(ax1,ay1);ctx.quadraticCurveTo(jitter,jitter*.5,ax2,ay2);ctx.stroke();
      }
      // Pulsing center
      var ep2=0.6+0.4*Math.sin(t*8+e.x*.01);
      ctx.fillStyle=col;ctx.beginPath();ctx.arc(0,0,r*.2+ep2*r*.1,0,Math.PI*2);ctx.fill();
      ctx.restore();
      break;

    // ‚îÄ‚îÄ G7 Graviton Abyss: void orbs ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    case 7:
      ctx.save();ctx.rotate(ang);
      // Distorted void sphere ‚Äî rings of different sizes
      ctx.fillStyle=col+'11';ctx.beginPath();ctx.arc(0,0,r*1.1,0,Math.PI*2);ctx.fill();
      for(var ri2=0;ri2<3;ri2++){
        var rr=r*(0.4+ri2*.25);var rop=0.3+0.2*Math.sin(t*2+ri2*1.5);
        ctx.strokeStyle=col;ctx.lineWidth=1+ri2*.5;ctx.globalAlpha=rop;
        ctx.beginPath();ctx.arc(0,0,rr,0,Math.PI*2);ctx.stroke();
      }
      ctx.globalAlpha=1;
      // Dark center ‚Äî event horizon
      var dark=ctx.createRadialGradient(0,0,0,0,0,r*.5);
      dark.addColorStop(0,'rgba(0,0,0,0.9)');dark.addColorStop(1,'transparent');
      ctx.fillStyle=dark;ctx.beginPath();ctx.arc(0,0,r*.5,0,Math.PI*2);ctx.fill();
      // Lensing distortion arms
      ctx.strokeStyle=col+'55';ctx.lineWidth=1;
      for(var di=0;di<4;di++){var da2=di/4*Math.PI*2+t*.5;ctx.beginPath();ctx.moveTo(0,0);ctx.lineTo(Math.cos(da2)*r*1.2,Math.sin(da2)*r*1.2);ctx.stroke();}
      ctx.restore();
      break;

    // ‚îÄ‚îÄ G8 Mirror Expanse: clone ships ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    case 8:
      ctx.save();ctx.rotate(ang+Math.PI);
      // Draw a mirrored ship silhouette (matches player look)
      ctx.fillStyle=col+'44';
      ctx.beginPath();ctx.moveTo(0,-r*1.1);ctx.lineTo(-r*.65,r*.8);ctx.lineTo(0,r*.35);ctx.lineTo(r*.65,r*.8);ctx.closePath();ctx.fill();
      ctx.strokeStyle=col;ctx.lineWidth=1.5;
      ctx.beginPath();ctx.moveTo(0,-r*1.1);ctx.lineTo(-r*.65,r*.8);ctx.lineTo(0,r*.35);ctx.lineTo(r*.65,r*.8);ctx.closePath();ctx.stroke();
      // Engine glow
      var ep3=0.5+0.5*Math.sin(t*6+e.x*.02);
      ctx.fillStyle='rgba(170,255,220,'+ep3+')';ctx.shadowColor=col;ctx.shadowBlur=14;
      ctx.beginPath();ctx.arc(-r*.3,r*.75,r*.15,0,Math.PI*2);ctx.fill();
      ctx.beginPath();ctx.arc(r*.3,r*.75,r*.15,0,Math.PI*2);ctx.fill();
      ctx.restore();
      break;

    // ‚îÄ‚îÄ G9 Void Heart: hybrid elites ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    case 9:
      ctx.save();ctx.rotate(ang);
      // Multi-form hybrid ‚Äî outer ring + inner body
      ctx.fillStyle=col+'15';ctx.beginPath();ctx.arc(0,0,r*1.2,0,Math.PI*2);ctx.fill();
      ctx.strokeStyle=col;ctx.lineWidth=2;ctx.setLineDash([4,4]);
      ctx.beginPath();ctx.arc(0,0,r*1.1,0,Math.PI*2);ctx.stroke();ctx.setLineDash([]);
      // Inner shape from previous galaxy type
      var innerType=ti%4;
      if(innerType===0){ctx.fillStyle=col+'33';ctx.beginPath();for(var vi=0;vi<6;vi++){var va=vi/6*Math.PI*2;ctx.lineTo(Math.cos(va)*r*.7,Math.sin(va)*r*.7);}ctx.closePath();ctx.fill();}
      else if(innerType===1){ctx.strokeStyle=col;ctx.lineWidth=1.5;ctx.beginPath();ctx.arc(0,0,r*.6,0,Math.PI*2);ctx.stroke();}
      else if(innerType===2){ctx.fillStyle=col+'33';ctx.beginPath();ctx.moveTo(0,-r*.7);ctx.lineTo(r*.5,r*.5);ctx.lineTo(-r*.5,r*.5);ctx.closePath();ctx.fill();}
      else{ctx.fillStyle=col+'33';ctx.beginPath();ctx.moveTo(0,-r*.7);ctx.lineTo(r*.5,0);ctx.lineTo(0,r*.7);ctx.lineTo(-r*.5,0);ctx.closePath();ctx.fill();}
      // Void eye
      var vep=0.5+0.5*Math.sin(t*5);ctx.fillStyle=col;ctx.beginPath();ctx.arc(0,0,r*.2+vep*r*.05,0,Math.PI*2);ctx.fill();
      ctx.restore();
      break;
  }
}

function drawBossShape(ctx,e,col,t){
  var r=e.r, ang=e.spinAngle||0, g2=e.galaxy||0;
  // Enrage glow overlay
  if(e.enraged){
    ctx.shadowBlur=40; ctx.shadowColor='#ff3366';
  } else {
    ctx.shadowBlur=28; ctx.shadowColor=col;
  }
  ctx.save(); ctx.rotate(ang*0.3);

  switch(g2){

  // ‚îÄ‚îÄ G0 CARRIER MOTHERSHIP ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  // Matches G0 UFO theme: tiered saucer with glowing deck lights
  case 0:{
    // Bottom disk ‚Äî wide flat
    ctx.fillStyle=col+'1a'; ctx.beginPath(); ctx.ellipse(0,0,r*1.6,r*0.5,0,0,Math.PI*2); ctx.fill();
    ctx.strokeStyle=col; ctx.lineWidth=2; ctx.beginPath(); ctx.ellipse(0,0,r*1.6,r*0.5,0,0,Math.PI*2); ctx.stroke();
    // Mid tier
    ctx.fillStyle=col+'28'; ctx.beginPath(); ctx.ellipse(0,-r*0.18,r*1.0,r*0.42,0,0,Math.PI*2); ctx.fill();
    ctx.strokeStyle=col; ctx.lineWidth=1.5; ctx.beginPath(); ctx.ellipse(0,-r*0.18,r*1.0,r*0.42,0,0,Math.PI*2); ctx.stroke();
    // Top dome
    ctx.fillStyle=col+'44'; ctx.beginPath(); ctx.ellipse(0,-r*0.28,r*0.55,r*0.38,0,Math.PI,Math.PI*2); ctx.fill();
    ctx.strokeStyle=col; ctx.lineWidth=1; ctx.beginPath(); ctx.ellipse(0,-r*0.28,r*0.55,r*0.38,0,Math.PI,Math.PI*2); ctx.stroke();
    // Landing bay slit
    ctx.fillStyle=col+'55'; ctx.beginPath(); ctx.rect(-r*0.35,-r*0.04,r*0.7,r*0.08); ctx.fill();
    // Deck port lights ‚Äî 10 pulsing
    for(var di=0;di<10;di++){
      var da=di/10*Math.PI*2, dp=0.3+0.7*Math.abs(Math.sin(t*4+di*0.9));
      var lx=Math.cos(da)*r*1.3, ly=Math.sin(da)*r*0.46;
      ctx.fillStyle='rgba(255,255,80,'+dp+')'; ctx.shadowColor='#ffff44'; ctx.shadowBlur=10;
      ctx.beginPath(); ctx.arc(lx,ly,3.5,0,Math.PI*2); ctx.fill();
    }
    // Fighter bays ‚Äî two glowing slits on underside
    ctx.fillStyle=col+'66'; ctx.shadowColor=col; ctx.shadowBlur=14;
    ctx.beginPath(); ctx.ellipse(-r*0.6,r*0.18,r*0.12,r*0.06,0,0,Math.PI*2); ctx.fill();
    ctx.beginPath(); ctx.ellipse(r*0.6,r*0.18,r*0.12,r*0.06,0,0,Math.PI*2); ctx.fill();
    break;
  }

  // ‚îÄ‚îÄ G1 VOID LEVIATHAN ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  // Matches G1 eel segment theme: massive serpent head with spines + glowing eyes
  case 1:{
    var pulse=0.88+0.12*Math.sin(t*2.2);
    // Head body ‚Äî horizontal oval
    ctx.fillStyle=col+'22'; ctx.beginPath(); ctx.ellipse(0,0,r*1.25*pulse,r*0.9,0,0,Math.PI*2); ctx.fill();
    ctx.strokeStyle=col; ctx.lineWidth=2.5; ctx.beginPath(); ctx.ellipse(0,0,r*1.25*pulse,r*0.9,0,0,Math.PI*2); ctx.stroke();
    // Neck scales ‚Äî 3 ridge plates
    ctx.fillStyle=col+'33';
    for(var si=0;si<3;si++){
      var sy=-r*0.9-si*r*0.22;
      ctx.beginPath(); ctx.ellipse(0,sy,r*(0.55-si*0.1),r*0.12,0,0,Math.PI*2); ctx.fill();
      ctx.strokeStyle=col; ctx.lineWidth=1; ctx.stroke();
    }
    // Jaw spines ‚Äî 7 across top
    ctx.lineWidth=2.5; ctx.strokeStyle=col;
    for(var si=0;si<7;si++){
      var sx=(si-3)*r*0.22, shy=-r*0.9-r*0.3*(1-Math.abs(si-3)*0.28);
      ctx.beginPath(); ctx.moveTo(sx,-r*0.78); ctx.lineTo(sx+(si-3)*r*0.06,shy); ctx.stroke();
    }
    // Side frills
    ctx.fillStyle=col+'33'; ctx.strokeStyle=col; ctx.lineWidth=1.5;
    ctx.beginPath(); ctx.moveTo(-r*1.2,r*0.1); ctx.lineTo(-r*1.7,-r*0.2); ctx.lineTo(-r*1.55,r*0.35); ctx.closePath(); ctx.fill(); ctx.stroke();
    ctx.beginPath(); ctx.moveTo(r*1.2,r*0.1); ctx.lineTo(r*1.7,-r*0.2); ctx.lineTo(r*1.55,r*0.35); ctx.closePath(); ctx.fill(); ctx.stroke();
    // Glowing slit eyes
    var ep=0.6+0.4*Math.sin(t*5);
    ctx.fillStyle='rgba(255,0,255,'+ep+')'; ctx.shadowColor='#ff00ff'; ctx.shadowBlur=24;
    ctx.beginPath(); ctx.ellipse(-r*0.32,-r*0.18,r*0.2,r*0.1,0,0,Math.PI*2); ctx.fill();
    ctx.beginPath(); ctx.ellipse(r*0.32,-r*0.18,r*0.2,r*0.1,0,0,Math.PI*2); ctx.fill();
    ctx.fillStyle='#000'; ctx.shadowBlur=0;
    ctx.beginPath(); ctx.ellipse(-r*0.32,-r*0.18,r*0.1,r*0.06,0.3,0,Math.PI*2); ctx.fill();
    ctx.beginPath(); ctx.ellipse(r*0.32,-r*0.18,r*0.1,r*0.06,-0.3,0,Math.PI*2); ctx.fill();
    // Mouth glow
    var mp=0.3+0.3*Math.sin(t*3);
    ctx.fillStyle='rgba(255,0,255,'+mp+')'; ctx.beginPath(); ctx.ellipse(0,r*0.5,r*0.7,r*0.12,0,0,Math.PI*2); ctx.fill();
    break;
  }

  // ‚îÄ‚îÄ G2 AI WAR CORE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  // Matches G2 hexagon drone theme: massive octagonal AI hub with grid + scan
  case 2:{
    // Outer octagon shell
    ctx.fillStyle=col+'14'; ctx.beginPath();
    for(var i=0;i<8;i++){var a=i/8*Math.PI*2; ctx.lineTo(Math.cos(a)*r*1.2,Math.sin(a)*r*1.2);} ctx.closePath(); ctx.fill();
    ctx.strokeStyle=col; ctx.lineWidth=2.5; ctx.beginPath();
    for(var i=0;i<8;i++){var a=i/8*Math.PI*2; ctx.lineTo(Math.cos(a)*r*1.2,Math.sin(a)*r*1.2);} ctx.closePath(); ctx.stroke();
    // Inner hexagon plate
    ctx.fillStyle=col+'22'; ctx.beginPath();
    for(var i=0;i<6;i++){var a=i/6*Math.PI*2; ctx.lineTo(Math.cos(a)*r*0.75,Math.sin(a)*r*0.75);} ctx.closePath(); ctx.fill();
    ctx.strokeStyle=col+'88'; ctx.lineWidth=1.5; ctx.beginPath();
    for(var i=0;i<6;i++){var a=i/6*Math.PI*2; ctx.lineTo(Math.cos(a)*r*0.75,Math.sin(a)*r*0.75);} ctx.closePath(); ctx.stroke();
    // Grid spokes ‚Äî 8
    ctx.lineWidth=1; ctx.strokeStyle=col+'44';
    for(var i=0;i<8;i++){var a=i/8*Math.PI*2; ctx.beginPath(); ctx.moveTo(0,0); ctx.lineTo(Math.cos(a)*r*1.1,Math.sin(a)*r*1.1); ctx.stroke();}
    // Concentric rings
    for(var ri=1;ri<=3;ri++){ctx.beginPath(); ctx.arc(0,0,r*ri*0.3,0,Math.PI*2); ctx.stroke();}
    // Rotating scan line
    var scanA=t*1.8;
    ctx.strokeStyle=col+'77'; ctx.lineWidth=2; ctx.shadowColor=col; ctx.shadowBlur=16;
    ctx.beginPath(); ctx.moveTo(0,0); ctx.lineTo(Math.cos(scanA)*r*1.1,Math.sin(scanA)*r*1.1); ctx.stroke();
    // Scan sweep arc
    ctx.globalAlpha=0.15; ctx.fillStyle=col;
    ctx.beginPath(); ctx.moveTo(0,0); ctx.arc(0,0,r*1.1,scanA-0.5,scanA); ctx.closePath(); ctx.fill();
    ctx.globalAlpha=1;
    // Corner turret nodes ‚Äî 4
    for(var i=0;i<4;i++){
      var na=i/4*Math.PI*2+Math.PI/8, np=0.5+0.5*Math.sin(t*3+i*1.2);
      ctx.fillStyle=col; ctx.shadowColor=col; ctx.shadowBlur=12+np*10;
      ctx.beginPath(); ctx.arc(Math.cos(na)*r*1.1,Math.sin(na)*r*1.1,5,0,Math.PI*2); ctx.fill();
    }
    // Central AI eye ‚Äî fast pulse
    var aip=0.6+0.4*Math.sin(t*10); ctx.shadowBlur=28; ctx.shadowColor=col;
    var eg=ctx.createRadialGradient(0,0,0,0,0,r*0.28+aip*r*0.08);
    eg.addColorStop(0,'#ffffff'); eg.addColorStop(0.3,col); eg.addColorStop(1,'transparent');
    ctx.fillStyle=eg; ctx.beginPath(); ctx.arc(0,0,r*0.28+aip*r*0.08,0,Math.PI*2); ctx.fill();
    break;
  }

  // ‚îÄ‚îÄ G3 ASTEROID TITAN ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  // Matches G3 jagged rock parasite theme: massive cracked boulder with lava seams
  case 3:{
    // Outer rocky silhouette ‚Äî 14-point jagged
    var pts=14;
    ctx.fillStyle=col+'22'; ctx.beginPath();
    for(var i=0;i<=pts;i++){
      var pa=i/pts*Math.PI*2;
      var pr=r*(0.72+0.28*Math.sin(i*2.1+1.7));
      if(i===0) ctx.moveTo(Math.cos(pa)*pr,Math.sin(pa)*pr);
      else ctx.lineTo(Math.cos(pa)*pr,Math.sin(pa)*pr);
    }
    ctx.closePath(); ctx.fill();
    ctx.strokeStyle=col; ctx.lineWidth=3; ctx.beginPath();
    for(var i=0;i<=pts;i++){
      var pa=i/pts*Math.PI*2; var pr=r*(0.72+0.28*Math.sin(i*2.1+1.7));
      if(i===0) ctx.moveTo(Math.cos(pa)*pr,Math.sin(pa)*pr);
      else ctx.lineTo(Math.cos(pa)*pr,Math.sin(pa)*pr);
    }
    ctx.closePath(); ctx.stroke();
    // Inner boulder fill ‚Äî darker
    ctx.fillStyle='#1a0800'; ctx.beginPath();
    for(var i=0;i<=pts;i++){
      var pa=i/pts*Math.PI*2; var pr=r*(0.65+0.2*Math.sin(i*2.1+1.7));
      if(i===0) ctx.moveTo(Math.cos(pa)*pr,Math.sin(pa)*pr);
      else ctx.lineTo(Math.cos(pa)*pr,Math.sin(pa)*pr);
    }
    ctx.closePath(); ctx.fill();
    // Lava crack seams ‚Äî glowing orange
    ctx.lineWidth=2; ctx.shadowColor='#ff6600'; ctx.shadowBlur=14;
    var cracks=[[0,0, 0.4,r*0.7],[0,0,-0.8,r*0.65],[-0.6,r*0.2,0.3,r*0.55],[0.7,r*0.1,-0.2,r*0.6],[0,0,1.5,r*0.5]];
    for(var ci=0;ci<cracks.length;ci++){
      var cr=cracks[ci], ca=cr[2];
      var lp=0.4+0.5*Math.abs(Math.sin(t*2+ci*1.4));
      ctx.strokeStyle='rgba(255,'+(120+Math.round(80*Math.sin(t+ci)))+',0,'+lp+')';
      ctx.beginPath(); ctx.moveTo(cr[0],cr[1]); ctx.lineTo(Math.cos(ca)*cr[3],Math.sin(ca)*cr[3]); ctx.stroke();
    }
    // 4 glowing parasite eyes around surface
    for(var ei=0;ei<4;ei++){
      var ea=ei/4*Math.PI*2+0.3, ep=0.5+0.5*Math.abs(Math.sin(t*3+ei*0.8));
      var ex2=Math.cos(ea)*r*0.45, ey2=Math.sin(ea)*r*0.4;
      ctx.fillStyle='rgba(255,140,0,'+ep+')'; ctx.shadowColor='#ff8800'; ctx.shadowBlur=18;
      ctx.beginPath(); ctx.arc(ex2,ey2,r*0.1,0,Math.PI*2); ctx.fill();
    }
    break;
  }

  // ‚îÄ‚îÄ G4 GAS COLOSSUS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  // Matches G4 pulsing bio sac theme: giant multi-layer membrane + 10 tentacles
  case 4:{
    var pulse=0.86+0.14*Math.sin(t*1.8);
    // Outer transparent membrane
    ctx.fillStyle=col+'0e'; ctx.beginPath(); ctx.arc(0,0,r*1.45*pulse,0,Math.PI*2); ctx.fill();
    ctx.strokeStyle=col+'55'; ctx.lineWidth=3; ctx.beginPath(); ctx.arc(0,0,r*1.35*pulse,0,Math.PI*2); ctx.stroke();
    // 10 animated tentacles ‚Äî quadratic bezier curves
    ctx.lineWidth=3; ctx.shadowColor=col; ctx.shadowBlur=12;
    for(var ti=0;ti<10;ti++){
      var ta=ti/10*Math.PI*2+ang*0.5;
      var tw1=Math.sin(t*2.5+ti*0.9)*r*0.6;
      var tw2=Math.cos(t*2+ti*1.1)*r*0.4;
      var tp=0.3+0.5*Math.abs(Math.sin(t*3+ti));
      ctx.strokeStyle='rgba('+parseInt(col.slice(1,3),16)+','+parseInt(col.slice(3,5),16)+','+parseInt(col.slice(5,7),16)+','+tp+')';
      var tx1=Math.cos(ta)*r*1.3, ty1=Math.sin(ta)*r*1.3;
      var tx2=Math.cos(ta+0.4)*r*2.0+tw1, ty2=Math.sin(ta+0.4)*r*2.0+tw2;
      var tx3=Math.cos(ta+0.75)*r*2.5, ty3=Math.sin(ta+0.75)*r*2.5;
      ctx.beginPath(); ctx.moveTo(tx1,ty1); ctx.quadraticCurveTo(tx2,ty2,tx3,ty3); ctx.stroke();
      // Sucker tip
      ctx.fillStyle=col+'88'; ctx.beginPath(); ctx.arc(tx3,ty3,4,0,Math.PI*2); ctx.fill();
    }
    // Middle membrane ring
    ctx.fillStyle=col+'22'; ctx.strokeStyle=col+'99'; ctx.lineWidth=2.5;
    ctx.beginPath(); ctx.arc(0,0,r*0.85*pulse,0,Math.PI*2); ctx.fill(); ctx.stroke();
    // Inner nucleus
    ctx.fillStyle=col+'55'; ctx.beginPath(); ctx.arc(0,0,r*0.45*pulse,0,Math.PI*2); ctx.fill();
    ctx.strokeStyle=col; ctx.lineWidth=2; ctx.stroke();
    // Core
    var cg=ctx.createRadialGradient(0,0,0,0,0,r*0.25);
    cg.addColorStop(0,'#ffffff'); cg.addColorStop(0.4,col); cg.addColorStop(1,'transparent');
    ctx.fillStyle=cg; ctx.shadowColor=col; ctx.shadowBlur=24;
    ctx.beginPath(); ctx.arc(0,0,r*0.25,0,Math.PI*2); ctx.fill();
    break;
  }

  // ‚îÄ‚îÄ G5 CRYO DREADNOUGHT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  // Matches G5 crystal shard theme: angular ice cruiser with 3 spike extensions
  case 5:{
    // Main hull ‚Äî wide hexagonal crystal
    ctx.fillStyle=col+'1e'; ctx.beginPath();
    ctx.moveTo(0,-r*1.35); ctx.lineTo(r*0.9,-r*0.4); ctx.lineTo(r*0.8,r*0.9);
    ctx.lineTo(0,r*0.6); ctx.lineTo(-r*0.8,r*0.9); ctx.lineTo(-r*0.9,-r*0.4);
    ctx.closePath(); ctx.fill();
    ctx.strokeStyle=col; ctx.lineWidth=2.5; ctx.beginPath();
    ctx.moveTo(0,-r*1.35); ctx.lineTo(r*0.9,-r*0.4); ctx.lineTo(r*0.8,r*0.9);
    ctx.lineTo(0,r*0.6); ctx.lineTo(-r*0.8,r*0.9); ctx.lineTo(-r*0.9,-r*0.4);
    ctx.closePath(); ctx.stroke();
    // Inner facet panel
    ctx.fillStyle=col+'22'; ctx.beginPath();
    ctx.moveTo(0,-r*0.8); ctx.lineTo(r*0.5,-r*0.15); ctx.lineTo(r*0.4,r*0.5);
    ctx.lineTo(0,r*0.32); ctx.lineTo(-r*0.4,r*0.5); ctx.lineTo(-r*0.5,-r*0.15);
    ctx.closePath(); ctx.fill();
    // 3 crystal spike extensions + forward spike
    ctx.strokeStyle=col; ctx.lineWidth=2.5; ctx.shadowColor=col; ctx.shadowBlur=18;
    // Top spike
    ctx.beginPath(); ctx.moveTo(0,-r*1.35); ctx.lineTo(0,-r*2.1); ctx.stroke();
    ctx.beginPath(); ctx.moveTo(-r*0.18,-r*1.7); ctx.lineTo(0,-r*2.1); ctx.lineTo(r*0.18,-r*1.7); ctx.stroke();
    // Left spike
    ctx.beginPath(); ctx.moveTo(-r*0.9,-r*0.4); ctx.lineTo(-r*1.8,-r*0.75); ctx.stroke();
    ctx.beginPath(); ctx.moveTo(-r*1.5,-r*0.3); ctx.lineTo(-r*1.8,-r*0.75); ctx.lineTo(-r*1.45,-r*0.95); ctx.stroke();
    // Right spike
    ctx.beginPath(); ctx.moveTo(r*0.9,-r*0.4); ctx.lineTo(r*1.8,-r*0.75); ctx.stroke();
    ctx.beginPath(); ctx.moveTo(r*1.5,-r*0.3); ctx.lineTo(r*1.8,-r*0.75); ctx.lineTo(r*1.45,-r*0.95); ctx.stroke();
    // Icy interior glow ‚Äî pulsing
    var icp=0.25+0.2*Math.sin(t*2.5);
    var ig=ctx.createRadialGradient(0,0,0,0,0,r*0.5);
    ig.addColorStop(0,'rgba(200,245,255,'+icp+')'); ig.addColorStop(1,'transparent');
    ctx.fillStyle=ig; ctx.beginPath(); ctx.arc(0,0,r*0.5,0,Math.PI*2); ctx.fill();
    // Facet glint lines
    ctx.lineWidth=1; ctx.strokeStyle=col+'66';
    ctx.beginPath(); ctx.moveTo(-r*0.6,-r*0.7); ctx.lineTo(r*0.1,-r*0.15); ctx.stroke();
    ctx.beginPath(); ctx.moveTo(r*0.6,-r*0.7); ctx.lineTo(-r*0.1,-r*0.15); ctx.stroke();
    ctx.beginPath(); ctx.moveTo(-r*0.55,r*0.2); ctx.lineTo(r*0.55,r*0.2); ctx.stroke();
    break;
  }

  // ‚îÄ‚îÄ G6 PULSAR AVATAR ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  // Matches G6 energy being theme: blazing energy orb with 10 radiating lightning arcs
  case 6:{
    // Outer corona
    var corona=0.88+0.12*Math.sin(t*3);
    ctx.fillStyle=col+'0e'; ctx.beginPath(); ctx.arc(0,0,r*1.4*corona,0,Math.PI*2); ctx.fill();
    // 10 arcing tendrils of energy
    for(var ai=0;ai<10;ai++){
      var aa=ai/10*Math.PI*2+t*1.2;
      var ax1=Math.cos(aa)*r*0.45, ay1=Math.sin(aa)*r*0.45;
      var ax2=Math.cos(aa+0.7)*r*1.35, ay2=Math.sin(aa+0.7)*r*1.35;
      var jx=Math.sin(t*10+ai*1.5)*r*0.28, jy=Math.cos(t*8+ai*1.3)*r*0.22;
      var ap=0.4+0.6*Math.abs(Math.sin(t*4+ai*0.7));
      ctx.strokeStyle=col.replace('#','rgba(').replace(/(.{2})(.{2})(.{2})/,'rgba($1,$2,$3,').replace('rgba(','rgba(').slice(0,4)+'...';
      // simpler: just use col with alpha trick
      ctx.globalAlpha=ap; ctx.strokeStyle=col; ctx.lineWidth=2.5;
      ctx.shadowColor=col; ctx.shadowBlur=20;
      ctx.beginPath(); ctx.moveTo(ax1,ay1); ctx.quadraticCurveTo(jx,jy,ax2,ay2); ctx.stroke();
    }
    ctx.globalAlpha=1;
    // Main orb body
    ctx.fillStyle=col+'33'; ctx.strokeStyle=col; ctx.lineWidth=2;
    ctx.beginPath(); ctx.arc(0,0,r*0.85,0,Math.PI*2); ctx.fill(); ctx.stroke();
    // Inner rings ‚Äî 2 rotating opposite directions
    ctx.lineWidth=1.5; ctx.strokeStyle=col+'77';
    ctx.save(); ctx.rotate(t*1.5);
    ctx.beginPath(); ctx.arc(0,0,r*0.55,0,Math.PI*2); ctx.stroke();
    ctx.restore();
    ctx.save(); ctx.rotate(-t*1.0);
    ctx.beginPath(); ctx.arc(0,0,r*0.38,0,Math.PI*2); ctx.stroke();
    ctx.restore();
    // Blazing core
    var pcp=0.6+0.4*Math.sin(t*8);
    var pg=ctx.createRadialGradient(0,0,0,0,0,r*(0.22+pcp*0.08));
    pg.addColorStop(0,'#ffffff'); pg.addColorStop(0.4,col); pg.addColorStop(1,'transparent');
    ctx.fillStyle=pg; ctx.shadowColor='#ffffff'; ctx.shadowBlur=35;
    ctx.beginPath(); ctx.arc(0,0,r*(0.22+pcp*0.08),0,Math.PI*2); ctx.fill();
    break;
  }

  // ‚îÄ‚îÄ G7 SINGULARITY ENTITY ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  // Matches G7 void orb theme: black hole with accretion disk, lensing, event horizon
  case 7:{
    // 2 accretion disks ‚Äî tilted at different angles
    ctx.save(); ctx.rotate(t*0.65);
    ctx.fillStyle=col+'18'; ctx.beginPath(); ctx.ellipse(0,0,r*2.0,r*0.35,0,0,Math.PI*2); ctx.fill();
    ctx.strokeStyle=col+'88'; ctx.lineWidth=2; ctx.beginPath(); ctx.ellipse(0,0,r*1.85,r*0.3,0,0,Math.PI*2); ctx.stroke();
    ctx.restore();
    ctx.save(); ctx.rotate(-t*0.4+Math.PI*0.35);
    ctx.fillStyle=col+'10'; ctx.beginPath(); ctx.ellipse(0,0,r*1.5,r*0.25,0,0,Math.PI*2); ctx.fill();
    ctx.restore();
    // Event horizon ‚Äî true darkness
    var dark=ctx.createRadialGradient(0,0,0,0,0,r*0.95);
    dark.addColorStop(0,'rgba(0,0,0,1)'); dark.addColorStop(0.75,'rgba(0,0,0,0.95)'); dark.addColorStop(1,'transparent');
    ctx.fillStyle=dark; ctx.beginPath(); ctx.arc(0,0,r*0.95,0,Math.PI*2); ctx.fill();
    // Photon sphere ‚Äî glowing rim
    ctx.strokeStyle=col; ctx.lineWidth=3.5; ctx.shadowColor=col; ctx.shadowBlur=32;
    ctx.beginPath(); ctx.arc(0,0,r*0.9,0,Math.PI*2); ctx.stroke();
    // Gravitational lensing arcs ‚Äî 8 bent light arcs around rim
    ctx.lineWidth=1.5; ctx.shadowBlur=12;
    for(var li=0;li<8;li++){
      var la=li/8*Math.PI*2+t*0.25;
      var lr=r*0.65, lp=0.25+0.35*Math.sin(t*2+li);
      ctx.globalAlpha=lp; ctx.strokeStyle=col;
      ctx.beginPath(); ctx.arc(Math.cos(la)*r*0.45,Math.sin(la)*r*0.45,lr*0.45,la,la+Math.PI*0.8); ctx.stroke();
    }
    ctx.globalAlpha=1;
    // Singularity point ‚Äî tiny intense core
    var sg=ctx.createRadialGradient(0,0,0,0,0,r*0.12);
    sg.addColorStop(0,'#ffffff'); sg.addColorStop(0.5,col); sg.addColorStop(1,'transparent');
    ctx.fillStyle=sg; ctx.shadowColor='#ffffff'; ctx.shadowBlur=40;
    ctx.beginPath(); ctx.arc(0,0,r*0.12,0,Math.PI*2); ctx.fill();
    break;
  }

  // ‚îÄ‚îÄ G8 ECHO COMMANDER ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  // Matches G8 mirror ship theme: large inverted player ship with mirrored twin wings
  case 8:{
    ctx.save(); ctx.rotate(Math.PI); // always faces player
    // Outer wing extensions
    ctx.fillStyle=col+'22'; ctx.strokeStyle=col; ctx.lineWidth=1.5;
    ctx.beginPath(); ctx.moveTo(-r*0.9,r*0.2); ctx.lineTo(-r*1.7,-r*0.1); ctx.lineTo(-r*1.5,r*0.7); ctx.closePath(); ctx.fill(); ctx.stroke();
    ctx.beginPath(); ctx.moveTo(r*0.9,r*0.2); ctx.lineTo(r*1.7,-r*0.1); ctx.lineTo(r*1.5,r*0.7); ctx.closePath(); ctx.fill(); ctx.stroke();
    // Main hull
    ctx.fillStyle=col+'33';
    ctx.beginPath();
    ctx.moveTo(0,-r*1.3); ctx.lineTo(-r*0.9,r*0.2); ctx.lineTo(-r*0.45,r*0.0); ctx.lineTo(0,r*0.55);
    ctx.lineTo(r*0.45,r*0.0); ctx.lineTo(r*0.9,r*0.2); ctx.closePath(); ctx.fill();
    ctx.strokeStyle=col; ctx.lineWidth=2.5; ctx.beginPath();
    ctx.moveTo(0,-r*1.3); ctx.lineTo(-r*0.9,r*0.2); ctx.lineTo(-r*0.45,r*0.0); ctx.lineTo(0,r*0.55);
    ctx.lineTo(r*0.45,r*0.0); ctx.lineTo(r*0.9,r*0.2); ctx.closePath(); ctx.stroke();
    // Fuselage gradient
    var fg=ctx.createLinearGradient(0,-r*1.3,0,r*0.55);
    fg.addColorStop(0,col+'55'); fg.addColorStop(1,'transparent');
    ctx.fillStyle=fg;
    ctx.beginPath(); ctx.moveTo(0,-r*1.3); ctx.lineTo(-r*0.45,r*0.0); ctx.lineTo(0,r*0.4); ctx.lineTo(r*0.45,r*0.0); ctx.closePath(); ctx.fill();
    // Wing detail lines
    ctx.lineWidth=1; ctx.strokeStyle=col+'66';
    ctx.beginPath(); ctx.moveTo(-r*0.75,r*0.1); ctx.lineTo(-r*0.1,-r*0.8); ctx.stroke();
    ctx.beginPath(); ctx.moveTo(r*0.75,r*0.1); ctx.lineTo(r*0.1,-r*0.8); ctx.stroke();
    ctx.beginPath(); ctx.moveTo(-r*0.55,r*0.0); ctx.lineTo(r*0.55,r*0.0); ctx.stroke();
    // Pulsing mirror engines x2
    var mep=0.5+0.5*Math.sin(t*5);
    var meg=ctx.createRadialGradient(-r*0.6,r*0.15,0,-r*0.6,r*0.15,r*0.2);
    meg.addColorStop(0,'#ffffff'); meg.addColorStop(0.4,col); meg.addColorStop(1,'transparent');
    ctx.fillStyle=meg; ctx.shadowColor=col; ctx.shadowBlur=22+mep*10;
    ctx.beginPath(); ctx.arc(-r*0.6,r*0.15,r*0.16+mep*r*0.05,0,Math.PI*2); ctx.fill();
    var meg2=ctx.createRadialGradient(r*0.6,r*0.15,0,r*0.6,r*0.15,r*0.2);
    meg2.addColorStop(0,'#ffffff'); meg2.addColorStop(0.4,col); meg2.addColorStop(1,'transparent');
    ctx.fillStyle=meg2;
    ctx.beginPath(); ctx.arc(r*0.6,r*0.15,r*0.16+mep*r*0.05,0,Math.PI*2); ctx.fill();
    // Forward cannon
    ctx.lineWidth=2; ctx.strokeStyle=col; ctx.shadowBlur=14;
    ctx.beginPath(); ctx.moveTo(-r*0.08,-r*1.3); ctx.lineTo(-r*0.08,-r*1.7); ctx.stroke();
    ctx.beginPath(); ctx.moveTo(r*0.08,-r*1.3); ctx.lineTo(r*0.08,-r*1.7); ctx.stroke();
    // Muzzle glow
    var gp=0.5+0.5*Math.abs(Math.sin(t*6));
    ctx.fillStyle=col; ctx.globalAlpha=gp; ctx.shadowColor=col; ctx.shadowBlur=18;
    ctx.beginPath(); ctx.arc(0,-r*1.72,r*0.1,0,Math.PI*2); ctx.fill();
    ctx.globalAlpha=1;
    ctx.restore();
    break;
  }

  // ‚îÄ‚îÄ G9 THE ARCHITECT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  // Matches G9 void heart hybrid theme: all prior shapes merged into one entity
  case 9: default:{
    // Enraged pulse rate
    var enR=e.enraged?1.8:1.0;
    // Outer dashed rotating ring ‚Äî void shell
    ctx.save(); ctx.rotate(t*0.4);
    ctx.strokeStyle=col; ctx.lineWidth=2.5; ctx.setLineDash([8,5]);
    ctx.beginPath(); ctx.arc(0,0,r*1.35,0,Math.PI*2); ctx.stroke(); ctx.setLineDash([]);
    ctx.restore();
    // Second counter-rotating ring
    ctx.save(); ctx.rotate(-t*0.25);
    ctx.strokeStyle=col+'66'; ctx.lineWidth=1.5; ctx.setLineDash([4,6]);
    ctx.beginPath(); ctx.arc(0,0,r*1.15,0,Math.PI*2); ctx.stroke(); ctx.setLineDash([]);
    ctx.restore();
    // Body ‚Äî merged octagon
    ctx.fillStyle=col+'1a'; ctx.beginPath();
    for(var i=0;i<8;i++){var a=i/8*Math.PI*2; ctx.lineTo(Math.cos(a)*r*0.92,Math.sin(a)*r*0.92);} ctx.closePath(); ctx.fill();
    ctx.strokeStyle=col; ctx.lineWidth=2.5; ctx.beginPath();
    for(var i=0;i<8;i++){var a=i/8*Math.PI*2; ctx.lineTo(Math.cos(a)*r*0.92,Math.sin(a)*r*0.92);} ctx.closePath(); ctx.stroke();
    // 4 orbiting shard fragments with trails
    for(var fi=0;fi<4;fi++){
      var fa=fi/4*Math.PI*2+t*0.7*enR;
      var fx=Math.cos(fa)*r*1.22, fy=Math.sin(fa)*r*1.22;
      // Trail
      for(var tr=1;tr<=4;tr++){
        var tra=fa-tr*0.14; var trx=Math.cos(tra)*r*1.22, tryy=Math.sin(tra)*r*1.22;
        ctx.globalAlpha=0.15*(5-tr); ctx.fillStyle=col;
        ctx.beginPath(); ctx.arc(trx,tryy,5-tr,0,Math.PI*2); ctx.fill();
      }
      ctx.globalAlpha=1;
      // Fragment shape
      ctx.save(); ctx.translate(fx,fy); ctx.rotate(t*2.2+fi*1.57);
      ctx.fillStyle=col+'aa'; ctx.strokeStyle=col; ctx.lineWidth=1.5; ctx.shadowColor=col; ctx.shadowBlur=16;
      ctx.beginPath(); ctx.moveTo(0,-r*0.22); ctx.lineTo(r*0.19,r*0.19); ctx.lineTo(-r*0.19,r*0.19); ctx.closePath();
      ctx.fill(); ctx.stroke(); ctx.restore();
    }
    // Inner void core ‚Äî dark center
    var dark3=ctx.createRadialGradient(0,0,0,0,0,r*0.5);
    dark3.addColorStop(0,'rgba(0,0,0,0.9)'); dark3.addColorStop(0.7,'rgba(0,0,0,0.5)'); dark3.addColorStop(1,'transparent');
    ctx.fillStyle=dark3; ctx.beginPath(); ctx.arc(0,0,r*0.5,0,Math.PI*2); ctx.fill();
    // Grid spokes inside body
    ctx.lineWidth=1; ctx.strokeStyle=col+'33';
    for(var i=0;i<8;i++){var a=i/8*Math.PI*2; ctx.beginPath(); ctx.moveTo(0,0); ctx.lineTo(Math.cos(a)*r*0.85,Math.sin(a)*r*0.85); ctx.stroke();}
    // Blazing white singularity core
    var acp=0.55+0.45*Math.sin(t*6*enR);
    var acg=ctx.createRadialGradient(0,0,0,0,0,r*(0.18+acp*0.1));
    acg.addColorStop(0,'#ffffff'); acg.addColorStop(0.35,col); acg.addColorStop(1,'transparent');
    ctx.fillStyle=acg; ctx.shadowColor='#ffffff'; ctx.shadowBlur=38;
    ctx.beginPath(); ctx.arc(0,0,r*(0.18+acp*0.1),0,Math.PI*2); ctx.fill();
    // Phase 2 rage ring
    if(e.enraged){
      ctx.strokeStyle='#ff3366'; ctx.lineWidth=3; ctx.globalAlpha=0.5+0.5*Math.sin(t*12);
      ctx.shadowColor='#ff3366'; ctx.shadowBlur=28;
      ctx.beginPath(); ctx.arc(0,0,r*1.05,0,Math.PI*2); ctx.stroke();
      ctx.globalAlpha=1;
    }
    break;
  }
  }
  ctx.restore();
}


  // Orbit blades
  if(g.orbit.active){for(var oi=0;oi<g.orbit.blades;oi++){var oa=g.orbit.angle+(Math.PI*2/g.orbit.blades)*oi;var obx=p.x+Math.cos(oa)*g.orbit.r-cx,oby=p.y+Math.sin(oa)*g.orbit.r-cy;ctx.save();ctx.shadowBlur=22;ctx.shadowColor=g.orbit.color;ctx.fillStyle=g.orbit.color;ctx.translate(obx,oby);ctx.rotate(oa+Math.PI/4);ctx.fillRect(-g.orbit.size/2,-3,g.orbit.size,6);ctx.restore();}}

  // Supernova glow
  if(g.supernovaActive){var sn2=g.supernovaActive,snx=p.x-cx,sny=p.y-cy;ctx.save();ctx.globalAlpha=.3;var grad=ctx.createRadialGradient(snx,sny,0,snx,sny,sn2.radius);grad.addColorStop(0,'rgba(255,180,0,0.7)');grad.addColorStop(.6,'rgba(255,80,0,0.15)');grad.addColorStop(1,'transparent');ctx.fillStyle=grad;ctx.beginPath();ctx.arc(snx,sny,sn2.radius,0,Math.PI*2);ctx.fill();ctx.restore();}

  // Bullets
  for(var i=0;i<g.bullets.length;i++){var b=g.bullets[i],sx=b.x-cx,sy=b.y-cy;var bang2=Math.atan2(b.vy,b.vx);ctx.save();ctx.shadowBlur=b.isEnemy?18:13;ctx.shadowColor=b.color;ctx.fillStyle=b.color;ctx.translate(sx,sy);ctx.rotate(bang2);ctx.beginPath();ctx.ellipse(0,0,b.size*2.5,b.size,0,0,Math.PI*2);ctx.fill();ctx.restore();}

  // Mining laser
  if(g.miningLaser&&g.miningLaser.life>0){
    var ml=g.miningLaser,alpha=ml.life/0.12;
    ctx.save();ctx.globalAlpha=alpha*0.85;ctx.strokeStyle='#00f5ff';ctx.lineWidth=3+alpha*3;ctx.shadowBlur=20+alpha*20;ctx.shadowColor='#00f5ff';
    ctx.beginPath();ctx.moveTo(ml.sx-cx,ml.sy-cy);ctx.lineTo(ml.ex-cx,ml.ey-cy);ctx.stroke();
    // Inner bright core
    ctx.globalAlpha=alpha*0.5;ctx.strokeStyle='#ffffff';ctx.lineWidth=1.5;ctx.shadowBlur=8;
    ctx.beginPath();ctx.moveTo(ml.sx-cx,ml.sy-cy);ctx.lineTo(ml.ex-cx,ml.ey-cy);ctx.stroke();
    ctx.restore();
  }

  // Rail laser singularity beam
  if(g._railLaser&&g._railLaser.life>0){
    var rl2=g._railLaser;
    var rAlpha=Math.min(1,rl2.life/(rl2.maxLife*0.25)); // fade out at end
    var rFlicker=0.85+0.15*Math.sin(gtime*60); // high-freq flicker
    var rLen=2200;
    var rA=p.aimAngle;
    var rSx=p.x-cx, rSy=p.y-cy;
    var rEx=rSx+Math.cos(rA)*rLen, rEy=rSy+Math.sin(rA)*rLen;
    ctx.save();
    // Outer glow ‚Äî wide soft
    ctx.globalAlpha=rAlpha*0.35*rFlicker;
    ctx.strokeStyle='#ff3366'; ctx.lineWidth=44;
    ctx.shadowColor='#ff3366'; ctx.shadowBlur=60;
    ctx.lineCap='round';
    ctx.beginPath(); ctx.moveTo(rSx,rSy); ctx.lineTo(rEx,rEy); ctx.stroke();
    // Mid glow
    ctx.globalAlpha=rAlpha*0.65*rFlicker;
    ctx.strokeStyle='#ff6688'; ctx.lineWidth=18; ctx.shadowBlur=30;
    ctx.beginPath(); ctx.moveTo(rSx,rSy); ctx.lineTo(rEx,rEy); ctx.stroke();
    // Core beam
    ctx.globalAlpha=rAlpha*rFlicker;
    ctx.strokeStyle='#ffffff'; ctx.lineWidth=5; ctx.shadowBlur=16; ctx.shadowColor='#ffffff';
    ctx.beginPath(); ctx.moveTo(rSx,rSy); ctx.lineTo(rEx,rEy); ctx.stroke();
    // Muzzle flash at origin
    ctx.globalAlpha=rAlpha*rFlicker;
    ctx.fillStyle='#ffffff'; ctx.shadowColor='#ff3366'; ctx.shadowBlur=40;
    ctx.beginPath(); ctx.arc(rSx,rSy,10+rFlicker*6,0,Math.PI*2); ctx.fill();
    ctx.restore();
  }

  // Player ship
  var px=p.x-cx,py=p.y-cy,fl=p.invincible>0&&Math.floor(gtime*12)%2===0;
  ctx.save();if(fl)ctx.globalAlpha=.25;
  if(p.shielded){ctx.beginPath();ctx.arc(px,py,p.r+12,0,Math.PI*2);ctx.strokeStyle='rgba(0,245,255,0.65)';ctx.lineWidth=2.5;ctx.shadowBlur=20;ctx.shadowColor='#00f5ff';ctx.stroke();}
  // Permanent shield ring (pulsing blue)
  if(p.shield&&p.shield.hp>0){
    var shp=p.shield.hp/p.shield.maxHp;
    var spulse=0.5+0.5*Math.sin(gtime*3);
    ctx.beginPath();ctx.arc(px,py,p.r+20+spulse*3,0,Math.PI*2*shp);
    ctx.strokeStyle='#33aaff';ctx.lineWidth=3;ctx.shadowBlur=16;ctx.shadowColor='#33aaff';ctx.stroke();
    // Background ring
    ctx.beginPath();ctx.arc(px,py,p.r+20+spulse*3,0,Math.PI*2);
    ctx.strokeStyle='rgba(50,100,180,0.2)';ctx.lineWidth=3;ctx.shadowBlur=0;ctx.stroke();
  }
  drawShip(ctx,activeSkin,px,py,p.aimAngle,1,p.thruster);
  ctx.restore();

  // Mining laser render
  if(miningTouch.active&&miningTouch.astIdx>=0&&miningTouch.laserLife>0){
    var mast2=G.liveAsteroids[miningTouch.astIdx];
    if(mast2){
      var lx1=px,ly1=py,lx2=mast2.x-cx,ly2=mast2.y-cy;
      ctx.save();ctx.globalAlpha=Math.min(1,miningTouch.laserLife*15);
      ctx.strokeStyle='#00f5ff';ctx.lineWidth=2+Math.random()*2;ctx.shadowBlur=18;ctx.shadowColor='#00f5ff';
      ctx.beginPath();ctx.moveTo(lx1,ly1);ctx.lineTo(lx2,ly2);ctx.stroke();
      // Impact sparks
      ctx.fillStyle='#ffffff';ctx.shadowBlur=8;
      for(var si=0;si<3;si++){ctx.beginPath();ctx.arc(lx2+(Math.random()-.5)*8,ly2+(Math.random()-.5)*8,1.5,0,Math.PI*2);ctx.fill();}
      ctx.restore();
    }
  }

  // Pickup range indicator
  ctx.save();ctx.strokeStyle='rgba(0,245,255,0.04)';ctx.lineWidth=1;ctx.beginPath();ctx.arc(px,py,p.pickR,0,Math.PI*2);ctx.stroke();ctx.restore();
}

function upgradeRankDesc(id){
  // Returns a description of what the upgrade does at its current rank in G
  var g=G,p=g.player;
  switch(id){
    case'dmg':   var r=g._upRanks&&g._upRanks.dmg||0;   return 'ATK '+(r)+' ‚Üí '+(r+1)+' ¬∑ GUN DMG +'+(Math.round((Math.pow(1.3,r+1)/Math.pow(1.3,r)-1)*100))+'%';
    case'spd':   var r=g._upRanks&&g._upRanks.spd||0;   return 'FIRE RATE '+(r)+' ‚Üí '+(r+1)+' ¬∑ CD -20%';
    case'pierce':var r=g._upRanks&&g._upRanks.pierce||0; return 'PIERCE '+(r)+' ‚Üí '+(r+1)+' ¬∑ +1 ENEMY PENETRATION';
    case'mvspd': var r=g._upRanks&&g._upRanks.mvspd||0; return 'SPEED '+(r)+' ‚Üí '+(r+1)+' ¬∑ ENGINE +15%';
    case'maxhp': var r=g._upRanks&&g._upRanks.maxhp||0; return 'HULL '+(r)+' ‚Üí '+(r+1)+' ¬∑ +50 MAX HP';
    case'regen': var r=g._upRanks&&g._upRanks.regen||0; return 'REPAIR '+(r)+' ‚Üí '+(r+1)+' ¬∑ +1 HP/SEC';
    case'orbit': var r=g._upRanks&&g._upRanks.orbit||0; return 'GRID '+(r)+' ‚Üí '+(r+1)+' ¬∑ '+(r===0?'ACTIVATE':'DMG +30% ¬∑ BLADES +1');
    case'nova':  var r=g._upRanks&&g._upRanks.nova||0;  return 'NOVA '+(r)+' ‚Üí '+(r+1)+' ¬∑ '+(r===0?'ACTIVATE ¬∑ 115 RANGE':'DMG +40% ¬∑ RANGE +'+(r*8));
    case'magnet':var r=g._upRanks&&g._upRanks.magnet||0;return 'PULL '+(r)+' ‚Üí '+(r+1)+' ¬∑ RANGE +60%';
    case'spread':var r=g._upRanks&&g._upRanks.spread||0;return 'SPREAD '+(r)+' ‚Üí '+(r+1)+' ¬∑ +1 EXTRA BOLT';
    case'escort':var r=g._upRanks&&g._upRanks.escort||0;return 'ESCORT '+(r)+' ‚Üí '+(r+1)+' ¬∑ '+(r===0?'DEPLOY 1 GUNSHIP':'+'+(r+1)+' GUNSHIP ¬∑ '+(r+1)+' MISSILES');
    default: return '';
  }
}

function showLU(){
  tutCheckLevelUp();
  if(!G._upRanks)G._upRanks={};
  G.paused=true;var panel=document.getElementById('lup');
  panel.querySelector('h2').textContent='RANK UP ¬∑ LEVEL '+G.player.level;
  panel.querySelector('.sub').textContent='+8 HULL ¬∑ +3% WEAPON DAMAGE ¬∑ SELECT BONUS';
  // Apply persistent bonuses for this level
  G.player.maxHp+=8;G.player.hp=Math.min(G.player.hp+8,G.player.maxHp);
  G.gun.dmg*=1.03;
  var uc=document.getElementById('uc');uc.innerHTML='';
  var pool=[].concat(UPGRADES).sort(function(){return Math.random()-.5;}).slice(0,3);
  for(var i=0;i<pool.length;i++){(function(u){
    var desc=upgradeRankDesc(u.id);
    var card=document.createElement('div');card.className='uc';
    card.innerHTML='<div class="ui">'+u.icon+'</div><div class="un">'+u.name+'</div><div class="ud">'+desc+'</div>';
    card.addEventListener('pointerdown',function(){
      if(!G._upRanks[u.id])G._upRanks[u.id]=0;
      G._upRanks[u.id]++;
      u.apply(G);incLS('upgradesCollected');
      panel.style.display='none';G.paused=false;
    });
    uc.appendChild(card);
  })(pool[i]);}
  panel.style.display='flex';document.getElementById('lvl').textContent=G.player.level;
}

function showWA(msg,color){var el=document.getElementById('wa');el.textContent=msg;el.style.color=color||'#ff3366';el.style.textShadow='0 0 20px '+(color||'#ff3366');el.style.opacity='1';clearTimeout(el._t);el._t=setTimeout(function(){el.style.opacity='0';},2400);}
function updateHUD(){
  var p=G.player;
  document.getElementById('hpF').style.width=(Math.max(0,p.hp/p.maxHp)*100)+'%';
  document.getElementById('xpF').style.width=(p.xp/p.xpNext*100)+'%';
  var m=Math.floor(G.time/60).toString().padStart(2,'0'),s=Math.floor(G.time%60).toString().padStart(2,'0');
  document.getElementById('td').textContent=m+':'+s;
  updateBeamSelector();
  // Singularity button
  var sb=document.getElementById('singBtn');
  if(sb){
    var show=!!(ownedBeam()&&G&&G.running&&!G.paused);
    sb.style.display=show?'flex':'none';
    if(show){
      if(G._singularityCd>0){sb.style.opacity='0.4';sb.textContent='‚ö° '+Math.ceil(G._singularityCd)+'s';}
      else{sb.style.opacity='1';sb.textContent='‚ö° SINGULARITY';}
    }
  }
}

function gameOver(){
  G.running=false;
  // Save XP progress
  persistXP=G.player.xp;persistXPNext=G.player.xpNext;
  lsS('vr_pxp',persistXP);lsS('vr_pxpnext',persistXPNext);
  var rr=document.getElementById('relicRow');if(rr)rr.innerHTML='';
  // Track lifetime stats
  incLS('totalRuns');
  incLS('totalPlayTime', Math.floor(G.time));
  if(G.wave > LS.highestWave){ LS.highestWave=G.wave; saveLS(); checkBadgeUnlocks(); }
  SFX.gameOver();stopMusic();
  document.getElementById('pauseBtn').style.display='none';
  document.getElementById('pauseMenu').style.display='none';
  var earned=G.crystalsRun+Math.floor(G.kills/5);crystals+=earned;lsS('vr_crystals',crystals);
  var m=Math.floor(G.time/60).toString().padStart(2,'0'),s=Math.floor(G.time%60).toString().padStart(2,'0');
  var ov=document.getElementById('menu');
  ov.innerHTML='<h1 style="color:var(--r)">DESTROYED</h1><div class="tl">SECTOR '+G.wave+' ¬∑ '+G.kills+' KILLS ¬∑ '+m+':'+s+'</div><div style="font-family:Orbitron,sans-serif;font-size:13px;color:var(--g);margin-bottom:20px;letter-spacing:2px;">+'+earned+' CRYSTALS ¬∑ TOTAL: '+crystals+'</div><button class="btn" id="goRBtn">‚ñ∂ RETRY</button><button class="btng btn" id="goPBtn">‚¨° UPGRADES</button><button class="btno btn" id="goHBtn">‚óà HANGAR</button>';
  ov.style.display='flex';
  document.getElementById('goPBtn').addEventListener('pointerdown',function(){SFX.click();ov.style.display='none';openPerm(true);});
  document.getElementById('goHBtn').addEventListener('pointerdown',function(){SFX.click();ov.style.display='none';openHangar(true);});
  document.getElementById('goRBtn').addEventListener('pointerdown',function(){SFX.click();ov.style.display='none';last=0;loopRunning=false;document.getElementById('pauseBtn').style.display='flex';document.getElementById('pauseBtn').textContent='‚è∏';newGame();startMusic();safeRAF();});
}

var permFromDeath=false,hangarFromDeath=false;
function openPerm(fd){permFromDeath=!!fd;renderPermPanel(0);document.getElementById('pp').style.display='flex';}
function openHangar(fd){hangarFromDeath=!!fd;renderHangar();document.getElementById('sp').style.display='flex';}

function renderPermPanel(tab){
  document.getElementById('pcoins').textContent='üíé '+crystals+' CRYSTALS';
  var tabs=document.getElementById('ptabs');tabs.innerHTML='';
  for(var i=0;i<PERM_TABS.length;i++){(function(ti){var b=document.createElement('div');b.className='ptab'+(ti===tab?' act':'');b.textContent=PERM_TABS[ti];b.addEventListener('pointerdown',function(){renderPermPanel(ti);});tabs.appendChild(b);})(i);}
  var cards=document.getElementById('pcards');
  var bgrid=document.getElementById('badgeGrid');
  var bcount=document.getElementById('badgeCount');
  // Toggle badge vs card view
  if(PERM_TABS[tab]==='BADGES'){
    cards.style.display='none';
    cards.className='';
    bgrid.style.display='flex';bcount.style.display='block';
    renderBadgePanel();
  } else {
    cards.removeAttribute('style');
    cards.className='pcards';
    bgrid.style.display='none';bcount.style.display='none';
    cards.innerHTML='';
    var defs=PERM_DEFS[PERM_TABS[tab]];
    for(var i=0;i<defs.length;i++){(function(def){
      var rank=pRank(def.id),maxed=rank>=def.maxRank,cost=pCost(def);
      var gReq=def.galaxyReq||0;
      var maxVisited=visitedGalaxies.length>0?Math.max.apply(null,visitedGalaxies):0;
      var glocked=gReq>0&&maxVisited<gReq;
      var card=document.createElement('div');
      card.className='pcard'+(maxed?' mx':'')+(glocked?' glocked':'');
      card.innerHTML=
        '<div class="pi">'+def.icon+'</div>'
        +'<div class="pmid"><div class="pn">'+def.name+'</div><div class="pd">'+def.desc+'</div></div>'
        +'<div class="pright"><div class="prk">'+rank+'/'+def.maxRank+'</div>'
        +'<div class="pc2">'+(glocked?'üîí G'+(gReq+1):maxed?'MAX':'üíé '+cost)+'</div></div>';
      if(!maxed&&!glocked)card.addEventListener('pointerdown',function(){buyPerm(def,tab);});
      cards.appendChild(card);
    })(defs[i]);}
  }
}
function buyPerm(def,tab){var cost=pCost(def);if(crystals<cost){fmsg('NOT ENOUGH CRYSTALS','#ff3366');SFX.click();return;}crystals-=cost;lsS('vr_crystals',crystals);permData[def.id]=(permData[def.id]||0)+1;lsS('vr_perm',permData);renderPermPanel(tab);fmsg(def.icon+' '+def.name+' UPGRADED','#9b59ff');SFX.upgrade();incLS('permUpgradesBought');}

function stopHangarAnims(){}  // no-op, kept for compatibility

function renderHangar(){
  document.getElementById('scoins').textContent=crystals+' CRYSTALS';
    var sg=document.getElementById('sg');
  sg.innerHTML='';
  for(var i=0;i<SKINS.length;i++){(function(sk){
    var owned=ownedSkins.indexOf(sk.id)>=0;
    var sel=activeSkin===sk.id;
    var row=document.createElement('div');
    row.className='sk'+(sel?' sel':'');

    // Color dot
    var dot=document.createElement('div');
    dot.className='skdot';
    dot.style.background=owned?sk.col:'#223';
    dot.style.boxShadow=owned?'0 0 8px '+sk.col:'none';
    row.appendChild(dot);

    // Name + desc + passive
    var mid=document.createElement('div');
    mid.className='skmid';
    var nm=document.createElement('div');
    nm.className='sn';
    nm.style.color=owned?sk.col:'#334';
    nm.textContent=sk.name;
    var ds=document.createElement('div');
    ds.className='sd';
    ds.textContent=sk.desc;
    var ps=document.createElement('div');
    ps.style.cssText='font-size:9px;letter-spacing:1px;margin-top:3px;color:'+(owned?(sel?sk.col:'#557'):'#223')+';font-family:Orbitron,sans-serif;';
    ps.textContent=sk.cost===0?'NO PASSIVE':'PASSIVE: '+sk.passiveDesc;
    mid.appendChild(nm);mid.appendChild(ds);mid.appendChild(ps);
    row.appendChild(mid);

    // Right side: status
    var right=document.createElement('div');
    right.className='skright';
    if(sel){
      right.textContent='ACTIVE';
      right.style.color='#ffd700';
    } else if(owned){
      right.textContent='EQUIP';
      right.style.color=sk.col;
    } else {
      right.textContent=sk.cost+' CR';
      right.style.color='#446';
    }
    row.appendChild(right);

    row.addEventListener('pointerdown',function(){
      SFX.click();
      if(!owned){
        if(crystals<sk.cost){fmsg('NOT ENOUGH CRYSTALS','#ff3366');return;}
        crystals-=sk.cost;lsS('vr_crystals',crystals);
        ownedSkins.push(sk.id);lsS('vr_skins',ownedSkins);
        owned=true;
      }
      if(activeSkin===sk.id)return;
      activeSkin=sk.id;lsS('vr_skin',activeSkin);
      fmsg(sk.name+' EQUIPPED','#ff6a00');
      renderHangar();
    });
    sg.appendChild(row);
  })(SKINS[i]);}
}


function backFromPanel(){
  stopHangarAnims();
  document.getElementById('pp').style.display='none';document.getElementById('sp').style.display='none';
  var ov=document.getElementById('menu');
  if(permFromDeath||hangarFromDeath){
    ov.style.display='flex';
    permFromDeath=false;hangarFromDeath=false;
    ov.innerHTML='<h1>VOID RUNNERS</h1><div class="tl" style="margin-bottom:18px;">DEEP SPACE SURVIVAL</div><button class="btn" id="sBtn2">‚ñ∂ LAUNCH</button><button class="btn" id="p2" style="border-color:var(--g);color:var(--g);">‚¨° UPGRADES</button><button class="btn" id="h2" style="border-color:var(--o);color:var(--o);">‚óà HANGAR</button><button class="btn" id="b2" style="border-color:#00f5ff;color:#00f5ff;">‚ö° BEAMS</button><button class=\"btn\" id=\"gr2\" style=\"border-color:#ffd700;color:#ffd700;">üíé GEM RUSH</button><div style="font-family:Orbitron,sans-serif;font-size:13px;color:var(--g);margin-top:14px;letter-spacing:2px;">'+crystals+' CRYSTALS</div>';
    document.getElementById('sBtn2').addEventListener('pointerdown',function(){last=0;loopRunning=false;startGame();});
    document.getElementById('p2').addEventListener('pointerdown',function(){ov.style.display='none';openPerm(false);});
    document.getElementById('h2').addEventListener('pointerdown',function(){ov.style.display='none';openHangar(false);});
    document.getElementById('b2').addEventListener('pointerdown',function(){ov.style.display='none';openBeamShop(false);});
    document.getElementById('gr2')&&document.getElementById('gr2').addEventListener('pointerdown',function(){SFX.click();startGemRushStandalone();});
  } else if(G&&G.running){
    // came from pause menu ‚Äî go back to pause screen
    document.getElementById('pauseMenu').style.display='flex';
  } else {
    document.getElementById('mcd').textContent='üíé '+crystals+' CRYSTALS';
  }
}
document.getElementById('pclose').addEventListener('pointerdown',function(){SFX.click();backFromPanel();});
document.getElementById('sclose').addEventListener('pointerdown',function(){SFX.click();backFromPanel();});

// ‚îÄ‚îÄ‚îÄ JOYSTICK ‚îÄ‚îÄ‚îÄ
var jz=document.getElementById('jz'),jk=document.getElementById('jk');
var jTid=null;var JR=70;
document.addEventListener('touchstart',function(e){e.preventDefault();},{passive:false});
document.addEventListener('touchmove', function(e){e.preventDefault();},{passive:false});
document.addEventListener('touchend',  function(e){e.preventDefault();},{passive:false});
document.addEventListener('touchcancel',function(e){e.preventDefault();},{passive:false});
jz.addEventListener('touchstart',function(e){if(jTid!==null)return;var t=e.changedTouches[0];jTid=t.identifier;applyJ(t.clientX,t.clientY);},{passive:false});
document.addEventListener('touchmove',function(e){for(var i=0;i<e.changedTouches.length;i++){var t=e.changedTouches[i];if(t.identifier===jTid)applyJ(t.clientX,t.clientY);}},{passive:false});
document.addEventListener('touchend',function(e){for(var i=0;i<e.changedTouches.length;i++){var t=e.changedTouches[i];if(t.identifier===jTid){jTid=null;if(G)G.joystick={dx:0,dy:0};jk.style.transform='translate(-50%,-50%)';}}}  ,{passive:false});
document.addEventListener('touchcancel',function(){jTid=null;if(G)G.joystick={dx:0,dy:0};jk.style.transform='translate(-50%,-50%)';},{passive:false});
function applyJ(cx2,cy2){var rect=jz.getBoundingClientRect();var cx=rect.left+rect.width/2,cy=rect.top+rect.height/2;var dx=cx2-cx,dy=cy2-cy;var len=Math.sqrt(dx*dx+dy*dy);if(len>JR){dx=dx/len*JR;dy=dy/len*JR;}jk.style.transform='translate(calc(-50% + '+dx+'px), calc(-50% + '+dy+'px))';if(G)G.joystick={dx:dx/JR,dy:dy/JR};}

// ‚îÄ‚îÄ‚îÄ MINING TOUCH HANDLERS ‚îÄ‚îÄ‚îÄ
var mTid=null; // separate touch ID for mining finger
function tryStartMining(cx2,cy2,tid){
  if(!G||!G.running||G.paused)return;
  // Convert screen to world coords
  var wx=cx2+G.camera.x, wy=cy2+G.camera.y;
  for(var i=0;i<G.liveAsteroids.length;i++){
    var ast=G.liveAsteroids[i];
    var dx=ast.x-wx,dy=ast.y-wy;
    if(Math.sqrt(dx*dx+dy*dy)<ast.r+28){
      mTid=tid;
      miningTouch.active=true;miningTouch.astIdx=i;
      var mb=document.getElementById('miningBar');if(mb)mb.style.display='block';
      var mf=document.getElementById('miningFill');if(mf)mf.style.width='0%';
      return;
    }
  }
}
document.addEventListener('touchstart',function(e){
  for(var i=0;i<e.changedTouches.length;i++){
    var t=e.changedTouches[i];
    if(t.identifier===jTid)continue; // skip joystick finger
    // Skip if over any UI button
    var el=document.elementFromPoint(t.clientX,t.clientY);
    if(el&&(el.closest('#ab')||el.closest('#pauseBtn')||el.closest('#pauseMenu')))continue;
    tryStartMining(t.clientX,t.clientY,t.identifier);
  }
},{passive:false});
document.addEventListener('touchend',function(e){
  for(var i=0;i<e.changedTouches.length;i++){
    if(e.changedTouches[i].identifier===mTid){
      mTid=null;miningTouch.active=false;miningTouch.astIdx=-1;
      var mb=document.getElementById('miningBar');if(mb)mb.style.display='none';
    }
  }
},{passive:false});
document.addEventListener('touchcancel',function(){
  mTid=null;miningTouch.active=false;miningTouch.astIdx=-1;
  var mb=document.getElementById('miningBar');if(mb)mb.style.display='none';
},{passive:false});

// Mouse mining (desktop testing)
var mouseMining=false;
gc.addEventListener('mousedown',function(e){
  if(e.button!==0||!G||!G.running||G.paused)return;
  tryStartMining(e.clientX,e.clientY,'mouse');mouseMining=true;
});
gc.addEventListener('mouseup',function(){
  if(!mouseMining)return;mouseMining=false;mTid=null;
  miningTouch.active=false;miningTouch.astIdx=-1;
  var mb=document.getElementById('miningBar');if(mb)mb.style.display='none';
});

// ‚îÄ‚îÄ‚îÄ BEAM SHOP WIRING (handled at bottom) ‚îÄ‚îÄ‚îÄ

// ‚îÄ‚îÄ‚îÄ MINING TOUCH INPUT ‚îÄ‚îÄ‚îÄ
// A second touch (not joystick) held on screen triggers mining laser toward nearest asteroid
var miningTouchId=null;
document.getElementById('gc').addEventListener('touchstart',function(e){
  for(var i=0;i<e.changedTouches.length;i++){
    var t=e.changedTouches[i];
    if(t.identifier===jTid)continue; // skip joystick touch
    if(miningTouchId!==null)continue;
    miningTouchId=t.identifier;
    miningTouch.x=t.clientX;miningTouch.y=t.clientY;
    tryStartMining(t.clientX,t.clientY);
  }
},{passive:true});
document.addEventListener('touchend',function(e){
  for(var i=0;i<e.changedTouches.length;i++){
    if(e.changedTouches[i].identifier===miningTouchId){
      miningTouchId=null;miningTouch.active=false;miningTouch.astIdx=-1;
    }
  }
},{passive:true});
document.addEventListener('touchcancel',function(){
  miningTouchId=null;miningTouch.active=false;miningTouch.astIdx=-1;
},{passive:true});

function tryStartMining(cx2,cy2){
  if(!G||!G.running||G.paused)return;
  // Convert screen coords to world coords
  var wx=cx2+G.camera.x,wy=cy2+G.camera.y;
  var best=-1,bestDist=120; // must be within 120px world units
  for(var i=0;i<G.liveAsteroids.length;i++){
    var d=Math.sqrt(Math.pow(G.liveAsteroids[i].x-wx,2)+Math.pow(G.liveAsteroids[i].y-wy,2));
    if(d<bestDist){bestDist=d;best=i;}
  }
  if(best>=0){miningTouch.active=true;miningTouch.astIdx=best;miningTouch.laserLife=0.1;}
}

// Also support mouse hold for desktop testing
var mouseHeld=false;
document.getElementById('gc').addEventListener('mousedown',function(e){mouseHeld=true;tryStartMining(e.clientX,e.clientY);});
document.addEventListener('mouseup',function(){mouseHeld=false;miningTouch.active=false;miningTouch.astIdx=-1;});

var keys={};
window.addEventListener('keydown',function(e){keys[e.code]=true;});
window.addEventListener('keyup',function(e){keys[e.code]=false;});
window.addEventListener('keydown',function(e){if(!G||G.paused)return;var m={KeyQ:0,KeyE:1,KeyR:2,KeyF:3};if(m[e.code]!==undefined)useAb(m[e.code]);});

var last=0,loopRunning=false;
function safeRAF(){if(!loopRunning){loopRunning=true;requestAnimationFrame(loop);}}
function loop(ts){
  var dt=Math.min((ts-(last||ts))/1000,.05);last=ts;gtime+=dt;
  if(!G||!G.running){loopRunning=false;return;}
  try{
    if(!G.paused)update(dt);
    render();updateHUD();renderPHud();
  }catch(e){
    console.error('LOOP CRASH:',e.message,e.stack);
    // Show error on screen for mobile debugging
    var dbg=document.getElementById('dbgErr');
    if(!dbg){dbg=document.createElement('div');dbg.id='dbgErr';dbg.style.cssText='position:fixed;bottom:20px;left:10px;right:10px;background:rgba(200,0,0,0.9);color:#fff;font-size:11px;padding:8px;z-index:999;font-family:monospace;border-radius:4px;';document.body.appendChild(dbg);}
    dbg.textContent='ERR: '+e.message+' | '+(e.stack||'').split('\n')[1];
    G.running=false;return;
  }
  requestAnimationFrame(loop);
}

function startGame(){
  setTimeout(function(){ if(G&&G.running) tutCheckAbility(); }, 8000);
  currentGalaxy=0;warpAnimating=false;last=0;loopRunning=false;
  markGalaxyVisited(0);
  buildBgForGalaxy(0);
  var gb=document.getElementById('galaxyBadge');
  if(gb){gb.textContent='ANDROMEDA ¬∑ GALAXY 1';gb.style.color='#00f5ff';}
  document.getElementById('menu').style.display='none';
  document.getElementById('pauseBtn').style.display='flex';
  document.getElementById('pauseBtn').textContent='‚è∏';
  newGame();startMusic();safeRAF();
  // Welcome tooltip ‚Äî show after 1 frame so game state is ready
  setTimeout(function(){ tutCheckWelcome(); }, 100);
}

document.getElementById('bshopClose').addEventListener('pointerdown',function(){SFX.click();closeBeamShop();});
document.getElementById('mBBtn').addEventListener('pointerdown',function(){SFX.click();document.getElementById('menu').style.display='none';openBeamShop(false);});
document.getElementById('pauseBeamBtn').addEventListener('pointerdown',function(){SFX.click();document.getElementById('pauseMenu').style.display='none';openBeamShop(true);});
document.getElementById('pauseGalaxyBtn').addEventListener('pointerdown',function(){SFX.click();document.getElementById('pauseMenu').style.display='none';openGalaxySelect(true);});

function openRelicPanel(){
  if(G && G.running) G.paused = true;
  document.getElementById('pauseMenu').style.display = 'none';

  var cap = document.getElementById('relicPanelCap');
  var cards = document.getElementById('relicPanelCards');
  if(!cards) { document.getElementById('relicPanel').style.display='flex'; return; }

  // Clear
  while(cards.firstChild) cards.removeChild(cards.firstChild);

  var activeRelics = (G && G.relics) ? G.relics : [];
  if(cap) cap.textContent = activeRelics.length + ' / ' + RELIC_CAP + ' ACTIVE THIS RUN';

  var seen = Array.isArray(seenRelics) ? seenRelics : [];

  // Count stacks
  var counts = {};
  for(var i=0; i<activeRelics.length; i++){
    var rid = activeRelics[i].id;
    counts[rid] = (counts[rid]||0) + 1;
  }

  // Render each relic definition
  for(var ri=0; ri<RELICS.length; ri++){
    var r = RELICS[ri];
    var isSeen = seen.indexOf(r.id) >= 0;
    var stacks = counts[r.id] || 0;
    var isActive = stacks > 0;

    var row = document.createElement('div');
    row.style.display = 'flex';
    row.style.alignItems = 'center';
    row.style.gap = '12px';
    row.style.padding = '11px 16px';
    row.style.borderBottom = '1px solid ' + (isActive ? 'rgba(155,89,255,0.2)' : 'rgba(255,255,255,0.05)');
    row.style.background = isActive ? 'rgba(155,89,255,0.07)' : 'transparent';

    var ico = document.createElement('div');
    ico.style.fontSize = '22px';
    ico.style.width = '30px';
    ico.style.textAlign = 'center';
    ico.style.flexShrink = '0';
    ico.style.opacity = isSeen ? (isActive ? '1' : '0.35') : '0.2';
    ico.textContent = isSeen ? r.icon : '‚ùì';
    row.appendChild(ico);

    var txt = document.createElement('div');
    txt.style.flex = '1';
    txt.style.minWidth = '0';

    var nm = document.createElement('div');
    nm.style.fontFamily = 'Orbitron,sans-serif';
    nm.style.fontSize = '11px';
    nm.style.letterSpacing = '1px';
    nm.style.marginBottom = '2px';
    nm.style.color = isActive ? '#cc88ff' : (isSeen ? '#557' : '#1a1a33');
    nm.textContent = isSeen ? r.name : '???';
    txt.appendChild(nm);

    var ds = document.createElement('div');
    ds.style.fontSize = '10px';
    ds.style.color = isActive ? '#668' : (isSeen ? '#334' : '#111');
    ds.style.lineHeight = '1.4';
    ds.textContent = isSeen ? r.desc : 'Defeat a boss to reveal';
    txt.appendChild(ds);
    row.appendChild(txt);

    if(isActive){
      var badge = document.createElement('div');
      badge.style.fontFamily = 'Orbitron,sans-serif';
      badge.style.fontSize = '9px';
      badge.style.color = '#9b59ff';
      badge.style.border = '1px solid rgba(155,89,255,0.35)';
      badge.style.borderRadius = '2px';
      badge.style.padding = '2px 5px';
      badge.style.flexShrink = '0';
      badge.textContent = stacks > 1 ? 'x'+stacks : 'ACTIVE';
      row.appendChild(badge);
    }

    cards.appendChild(row);
  }

  document.getElementById('relicPanel').style.display = 'flex';
}

document.getElementById('relicPanelClose').addEventListener('pointerdown',function(){
  SFX.click();
  document.getElementById('relicPanel').style.display='none';
  document.getElementById('pauseMenu').style.display='flex';
  // Game stays paused ‚Äî pause menu is now showing, resumeBtn handles unpausing
});


document.getElementById('galaxySelectClose').addEventListener('pointerdown',function(){
  SFX.click();
  document.getElementById('galaxySelect').style.display='none';
  if(galaxySelectFromPause){
    document.getElementById('pauseMenu').style.display='flex';
  } else {
    document.getElementById('menu').style.display='flex';
  }
});

// ‚îÄ‚îÄ DEV MODE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
var devUnlocked=false;
var devFromPause=false;

function openDevPrompt(fromPause){
  devFromPause=!!fromPause;
  var inp=document.getElementById('devPasswordInput');
  var err=document.getElementById('devPasswordErr');
  var overlay=document.getElementById('devPasswordPrompt');
  if(!inp||!err||!overlay){console.error('DEV: prompt elements missing');return;}
  inp.value='';
  err.textContent='';
  overlay.style.display='flex';
  // iOS requires focus() inside a direct user gesture chain.
  // We trigger it on the next frame after display is set.
  requestAnimationFrame(function(){
    requestAnimationFrame(function(){
      try{inp.focus();inp.click();}catch(ex){}
    });
  });
}

function openDevPanel(){
  var panel=document.getElementById('devPanel');
  var content=document.getElementById('devContent');
  content.innerHTML='';

  function devRow(label,color,onclick){
    var row=document.createElement('div');
    row.style.cssText='width:100%;padding:16px 18px;display:flex;align-items:center;justify-content:space-between;border-bottom:1px solid rgba(255,255,255,0.06);cursor:pointer;box-sizing:border-box;';
    row.innerHTML='<span style="font-family:Orbitron,sans-serif;font-size:12px;letter-spacing:2px;color:'+(color||'#ffd700')+'">'+label+'</span>';
    var arrow=document.createElement('span');
    arrow.style.cssText='font-family:Orbitron,sans-serif;font-size:10px;color:#446;';
    arrow.textContent='‚ñ∂';
    row.appendChild(arrow);
    row.addEventListener('pointerdown',function(){SFX.click();onclick();});
    return row;
  }

  function devStatus(label,value){
    var row=document.createElement('div');
    row.style.cssText='width:100%;padding:12px 18px;display:flex;align-items:center;justify-content:space-between;border-bottom:1px solid rgba(255,255,255,0.04);box-sizing:border-box;';
    row.innerHTML='<span style="font-family:Orbitron,sans-serif;font-size:10px;color:#446;letter-spacing:2px;">'+label+'</span><span style="font-family:Orbitron,sans-serif;font-size:10px;color:#ffd700;">'+value+'</span>';
    return row;
  }

  content.appendChild(devStatus('CRYSTALS', crystals));
  content.appendChild(devStatus('CURRENT GALAXY', 'G'+(currentGalaxy+1)+' ‚Äî '+(GALAXIES[currentGalaxy]||GALAXIES[0]).name));
  content.appendChild(devStatus('GALAXIES VISITED', visitedGalaxies.length+' / '+GALAXIES.length));
  content.appendChild(devStatus('PERM LEVEL', persistLevel));

  content.appendChild(devRow('INFINITE CRYSTALS (+99999)','#ffd700',function(){
    crystals+=99999;lsS('vr_crystals',crystals);
    document.getElementById('devContent').querySelector('span').parentElement.innerHTML='';
    fmsg('DEV: +99999 CRYSTALS','#ffd700');
    openDevPanel();
  }));

  content.appendChild(devRow('UNLOCK ALL GALAXIES','#00f5ff',function(){
    for(var gi=0;gi<GALAXIES.length;gi++) markGalaxyVisited(gi);
    fmsg('DEV: ALL GALAXIES UNLOCKED','#00f5ff');
    openDevPanel();
  }));

  content.appendChild(devRow('UNLOCK ALL SHIPS','#ff6a00',function(){
    for(var si=0;si<SKINS.length;si++) if(ownedSkins.indexOf(SKINS[si].id)<0) ownedSkins.push(SKINS[si].id);
    lsS('vr_skins',ownedSkins);
    fmsg('DEV: ALL SHIPS UNLOCKED','#ff6a00');
    openDevPanel();
  }));

  content.appendChild(devRow('MAX ALL PERM UPGRADES','#9b59ff',function(){
    PERM_TABS.forEach(function(tab){
      var defs=PERM_DEFS[tab];if(!defs)return;
      defs.forEach(function(d){permData[d.id]=d.maxRank;});
    });
    lsS('vr_perm',permData);
    fmsg('DEV: ALL UPGRADES MAXED','#9b59ff');
    openDevPanel();
  }));

  content.appendChild(devRow('WARP TO GALAXY...','#8844ff',function(){
    var gi=parseInt(prompt('Warp to galaxy (1-10):'),10)-1;
    if(gi>=0&&gi<GALAXIES.length){
      markGalaxyVisited(gi);
      if(G&&G.running){warpToGalaxy(gi);}
      else{currentGalaxy=gi;buildBgForGalaxy(gi);}
      document.getElementById('devPanel').style.display='none';
      fmsg('DEV: WARPED TO G'+(gi+1),'#8844ff');
    }
  }));

  content.appendChild(devRow('SKIP TO BOSS','#ff3366',function(){
    if(G&&G.running){G.killsForBoss=99999;fmsg('DEV: BOSS INCOMING','#ff3366');}
    else fmsg('START A RUN FIRST','#ff3366');
    panel.style.display='none';
  }));

  content.appendChild(devRow('FILL HULL + SHIELD','#39ff8a',function(){
    if(G&&G.player){G.player.hp=G.player.maxHp;if(G.player.shield)G.player.shield.hp=G.player.shield.maxHp;fmsg('DEV: HULL RESTORED','#39ff8a');}
    else fmsg('START A RUN FIRST','#39ff8a');
    panel.style.display='none';
  }));

  content.appendChild(devRow('RESET ALL DATA','#ff3366',function(){
    panel.style.display='none';
    confirmReset();
  }));
  content.appendChild(devRow('RESET ALL SAVE DATA','#ff3366',function(){
    panel.style.display='none';
    confirmReset();
  }));
  content.appendChild(devRow('RESET DEV LOCK','#ff3366',function(){
    devUnlocked=false;fmsg('DEV: LOCKED','#ff3366');panel.style.display='none';
  }));

  panel.style.display='flex';
}

document.getElementById('devPasswordSubmit').addEventListener('pointerdown',function(){
  var pw=document.getElementById('devPasswordInput').value;
  if(pw==='Fable!'){
    devUnlocked=true;
    document.getElementById('devPasswordPrompt').style.display='none';
    openDevPanel();
  } else {
    document.getElementById('devPasswordErr').textContent='INVALID PASSWORD';
    document.getElementById('devPasswordInput').value='';
  }
});

document.getElementById('devPasswordInput').addEventListener('keydown',function(e){
  if(e.key==='Enter') document.getElementById('devPasswordSubmit').dispatchEvent(new Event('pointerdown'));
});

document.getElementById('devPasswordCancel').addEventListener('pointerdown',function(){
  document.getElementById('devPasswordPrompt').style.display='none';
});
// Tapping anywhere on the password overlay focuses the input (iOS keyboard fix)
document.getElementById('devPasswordPrompt').addEventListener('pointerdown',function(e){
  if(e.target.tagName!=='BUTTON'){
    var inp=document.getElementById('devPasswordInput');
    try{inp.focus();inp.click();}catch(ex){}
  }
});

document.getElementById('voidTreeClose').addEventListener('pointerdown',function(){
  SFX.click();
  document.getElementById('voidTreePanel').style.display='none';
  document.getElementById('menu').style.display='flex';
  document.getElementById('mcd').textContent='üíé '+crystals+' CRYSTALS';
});
document.getElementById('devClose').addEventListener('pointerdown',function(){
  SFX.click();
  document.getElementById('devPanel').style.display='none';
  // Menu/pauseMenu were never hidden ‚Äî nothing to restore
});

document.getElementById('menuDevBtn').addEventListener('pointerdown',function(e){
  e.stopPropagation();
  try{SFX.click();}catch(ex){}
  if(devUnlocked) openDevPanel();
  else openDevPrompt(false);
});

document.getElementById('pauseDevBtn').addEventListener('pointerdown',function(e){
  e.stopPropagation();
  try{SFX.click();}catch(ex){}
  if(devUnlocked) openDevPanel();
  else openDevPrompt(true);
});

function confirmReset(){
  SFX.click();
  var conf=document.createElement('div');
  conf.style.cssText='position:fixed;inset:0;background:rgba(0,0,0,0.92);z-index:100;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:14px;';
  conf.innerHTML='<div style="font-family:Orbitron,sans-serif;color:#ff3366;font-size:16px;letter-spacing:3px;text-shadow:0 0 20px #ff3366;">‚ö† RESET ALL DATA?</div>'
    +'<div style="font-size:10px;color:#446;letter-spacing:2px;text-align:center;max-width:260px;">This will erase ALL crystals, upgrades, skins, badges, and progress. Cannot be undone.</div>'
    +'<button id="confYes" style="font-family:Orbitron,monospace;font-size:11px;letter-spacing:2px;padding:10px 28px;background:transparent;border:1px solid #ff3366;color:#ff3366;cursor:pointer;border-radius:2px;">YES, RESET</button>'
    +'<button id="confNo" style="font-family:Orbitron,monospace;font-size:11px;letter-spacing:2px;padding:10px 28px;background:transparent;border:1px solid #446;color:#446;cursor:pointer;border-radius:2px;">CANCEL</button>';
  document.body.appendChild(conf);
  document.getElementById('confYes').addEventListener('pointerdown',function(){resetAllData();});
  document.getElementById('confNo').addEventListener('pointerdown',function(){SFX.click();document.body.removeChild(conf);});
}
document.getElementById('mVoidBtn').addEventListener('pointerdown',function(){ SFX.click(); openVoidTree(); });

document.getElementById('mcd').textContent='üíé '+crystals+' CRYSTALS';
document.getElementById('sBtn').addEventListener('pointerdown',function(){SFX.click();startGame();});
document.getElementById('mGBtn').addEventListener('pointerdown',function(){SFX.click();document.getElementById('menu').style.display='none';openGalaxySelect();});
document.getElementById('mPBtn').addEventListener('pointerdown',function(){SFX.click();document.getElementById('menu').style.display='none';openPerm(false);});
document.getElementById('mHBtn').addEventListener('pointerdown',function(){SFX.click();document.getElementById('menu').style.display='none';openHangar(false);});
document.getElementById('mGRBtn').addEventListener('pointerdown',function(){SFX.click();startGemRushStandalone();});

function togglePause(){
  if(!G||!G.running||warpAnimating)return;
  if(G.paused&&document.getElementById('pauseMenu').style.display==='flex'){
    resumeGame();
  } else if(!G.paused){
    G.paused=true;SFX.pause();
    document.getElementById('pauseMenu').style.display='flex';
    document.getElementById('pauseBtn').textContent='‚ñ∂';
  }
}
function resumeGame(){
  if(!G)return;
  G.paused=false;SFX.resume();
  document.getElementById('pauseMenu').style.display='none';
  document.getElementById('pauseBtn').textContent='‚è∏';
}
document.getElementById('singBtn').addEventListener('pointerdown',function(e){
  e.stopPropagation();
  if(G&&G.running&&!G.paused)fireBeamSingularity();
});
document.getElementById('pauseBtn').addEventListener('pointerdown',function(e){
  e.stopPropagation();
  togglePause();

});
document.getElementById('resumeBtn').addEventListener('pointerdown',function(){SFX.click();resumeGame();});
document.getElementById('pauseUpgBtn').addEventListener('pointerdown',function(){
  SFX.click();document.getElementById('pauseMenu').style.display='none';openPerm(false);
});
document.getElementById('pauseHangarBtn').addEventListener('pointerdown',function(){
  SFX.click();document.getElementById('pauseMenu').style.display='none';openHangar(false);
});
window.addEventListener('keydown',function(e){if(e.code==='Escape'&&G&&G.running)togglePause();});

// ‚îÄ‚îÄ‚îÄ AUDIO ENGINE ‚îÄ‚îÄ‚îÄ
var AC=null,musicNodes=[],musicPlaying=false,sfxEnabled=true,musicEnabled=true;
var gunThrottle=0; // prevent gun sound spam

function getAC(){
  if(!AC){try{AC=new(window.AudioContext||window.webkitAudioContext)();}catch(e){}}
  if(AC&&AC.state==='suspended')AC.resume();
  return AC;
}

function playTone(freq,type,vol,dur,attack,decay,freqEnd){
  var ac=getAC();if(!ac||!sfxEnabled)return;
  try{
    var o=ac.createOscillator(),g=ac.createGain();
    o.connect(g);g.connect(ac.destination);
    o.type=type||'sine';
    o.frequency.setValueAtTime(freq,ac.currentTime);
    if(freqEnd)o.frequency.exponentialRampToValueAtTime(freqEnd,ac.currentTime+(dur||0.1));
    g.gain.setValueAtTime(0,ac.currentTime);
    g.gain.linearRampToValueAtTime(vol||0.3,ac.currentTime+(attack||0.005));
    g.gain.exponentialRampToValueAtTime(0.001,ac.currentTime+(dur||0.1)-(decay||0.01));
    o.start(ac.currentTime);o.stop(ac.currentTime+(dur||0.1));
  }catch(e){}
}

function playNoise(vol,dur,filterFreq,filterQ){
  var ac=getAC();if(!ac||!sfxEnabled)return;
  try{
    var bufLen=ac.sampleRate*dur,buf=ac.createBuffer(1,bufLen,ac.sampleRate);
    var d=buf.getChannelData(0);for(var i=0;i<bufLen;i++)d[i]=Math.random()*2-1;
    var src=ac.createBufferSource(),filt=ac.createBiquadFilter(),g=ac.createGain();
    src.buffer=buf;filt.type='bandpass';filt.frequency.value=filterFreq||800;filt.Q.value=filterQ||1;
    src.connect(filt);filt.connect(g);g.connect(ac.destination);
    g.gain.setValueAtTime(vol||0.3,ac.currentTime);
    g.gain.exponentialRampToValueAtTime(0.001,ac.currentTime+dur);
    src.start();src.stop(ac.currentTime+dur);
  }catch(e){}
}

// Sound effects
var SFX={
  shoot:function(){
    if(!sfxEnabled)return;
    gunThrottle++;if(gunThrottle%3!==0)return; // only every 3rd shot
    playTone(520,'square',0.06,0.07,0.002,0.06,180);
    playNoise(0.04,0.05,3000,2);
  },
  hit:function(){
    playNoise(0.08,0.04,600,3);
    playTone(180,'sawtooth',0.05,0.05,0.001,0.04,80);
  },
  enemyDie:function(){
    playTone(300,'sawtooth',0.12,0.18,0.003,0.15,60);
    playNoise(0.1,0.12,400,2);
  },
  bossHit:function(){
    playTone(120,'sawtooth',0.15,0.08,0.003,0.07,80);
  },
  bossDie:function(){
    var ac=getAC();if(!ac||!sfxEnabled)return;
    try{
      [80,120,180,240,300].forEach(function(f,i){
        setTimeout(function(){
          playTone(f,'sawtooth',0.2,0.4,0.01,0.35,30);
          playNoise(0.15,0.3,f*2,1.5);
        },i*80);
      });
    }catch(e){}
  },
  asteroidHit:function(){
    playNoise(0.1,0.06,1200,4);
    playTone(220,'triangle',0.05,0.06,0.002,0.05,150);
  },
  asteroidBreak:function(){
    playNoise(0.18,0.2,800,2);
    playTone(280,'sawtooth',0.1,0.2,0.005,0.18,60);
    playTone(140,'sine',0.08,0.15,0.003,0.13,80);
  },
  gemCollect:function(){
    playTone(880,'sine',0.12,0.12,0.005,0.1,1200);
    playTone(1100,'sine',0.08,0.1,0.008,0.08,1400);
  },
  xpCollect:function(){
    playTone(660,'sine',0.06,0.08,0.003,0.07,880);
  },
  levelUp:function(){
    var ac=getAC();if(!ac||!sfxEnabled)return;
    [440,550,660,880].forEach(function(f,i){setTimeout(function(){playTone(f,'sine',0.15,0.2,0.01,0.18);},i*60);});
  },
  pickup:function(){
    playTone(700,'sine',0.1,0.15,0.005,0.13,900);
    playNoise(0.04,0.08,2000,3);
  },
  click:function(){
    playTone(800,'sine',0.08,0.06,0.003,0.05,600);
  },
  ability:function(){
    playTone(440,'square',0.1,0.12,0.005,0.1,280);
    playNoise(0.06,0.08,1500,3);
  },
  playerHit:function(){
    playTone(160,'sawtooth',0.18,0.15,0.003,0.13,80);
    playNoise(0.12,0.1,300,2);
  },
  warp:function(){
    var ac=getAC();if(!ac||!sfxEnabled)return;
    try{
      var o=ac.createOscillator(),g=ac.createGain();
      o.connect(g);g.connect(ac.destination);
      o.type='sawtooth';o.frequency.setValueAtTime(80,ac.currentTime);
      o.frequency.exponentialRampToValueAtTime(3000,ac.currentTime+1.5);
      g.gain.setValueAtTime(0,ac.currentTime);g.gain.linearRampToValueAtTime(0.15,ac.currentTime+0.3);
      g.gain.linearRampToValueAtTime(0,ac.currentTime+1.8);
      o.start();o.stop(ac.currentTime+1.8);
    }catch(e){}
  },
  gameOver:function(){
    var ac=getAC();if(!ac||!sfxEnabled)return;
    [440,330,220,110].forEach(function(f,i){setTimeout(function(){playTone(f,'sawtooth',0.2,0.5,0.01,0.45);},i*180);});
  },
  pause:function(){
    playTone(600,'sine',0.08,0.1,0.003,0.09,400);
  },
  resume:function(){
    playTone(400,'sine',0.08,0.1,0.003,0.09,700);
  },
  upgrade:function(){
    [550,700,880,1100].forEach(function(f,i){setTimeout(function(){playTone(f,'sine',0.12,0.15,0.005,0.13);},i*50);});
  },
};

// ‚îÄ‚îÄ‚îÄ MUSIC ‚îÄ‚îÄ‚îÄ
function startMusic(){
  var ac=getAC();if(!ac||!musicEnabled)return;
  if(musicPlaying)return;
  musicPlaying=true;
  stopMusic();

  // Ambient drone layer
  function makeDrone(freq,vol){
    try{
      var o=ac.createOscillator(),lfo=ac.createOscillator(),lfoG=ac.createGain(),g=ac.createGain();
      lfo.frequency.value=0.3+Math.random()*0.4;lfoG.gain.value=vol*0.3;
      lfo.connect(lfoG);lfoG.connect(g.gain);
      o.type='sine';o.frequency.value=freq;o.connect(g);g.connect(ac.destination);
      g.gain.value=vol;lfo.start();o.start();
      musicNodes.push(o,lfo,g,lfoG);
    }catch(e){}
  }
  makeDrone(55,0.04);makeDrone(82,0.025);makeDrone(110,0.02);makeDrone(165,0.015);

  // Rhythmic pulse
  var pulseInterval;
  var beat=0;
  var scale=[110,130,146,165,196,220,247,293];
  function pulse(){
    if(!musicPlaying||!musicEnabled)return;
    try{
      var ac2=getAC();if(!ac2)return;
      // Kick-like thud on beat 0 and 2
      if(beat%4===0||beat%4===2){
        var o=ac2.createOscillator(),g=ac2.createGain();
        o.type='sine';o.frequency.setValueAtTime(120,ac2.currentTime);o.frequency.exponentialRampToValueAtTime(40,ac2.currentTime+0.15);
        g.gain.setValueAtTime(0.18,ac2.currentTime);g.gain.exponentialRampToValueAtTime(0.001,ac2.currentTime+0.18);
        o.connect(g);g.connect(ac2.destination);o.start();o.stop(ac2.currentTime+0.18);
      }
      // Hihat on beat 1 and 3
      if(beat%4===1||beat%4===3){
        var bufLen=ac2.sampleRate*.06,buf=ac2.createBuffer(1,bufLen,ac2.sampleRate);
        var d=buf.getChannelData(0);for(var i=0;i<bufLen;i++)d[i]=Math.random()*2-1;
        var src=ac2.createBufferSource(),filt=ac2.createBiquadFilter(),g2=ac2.createGain();
        src.buffer=buf;filt.type='highpass';filt.frequency.value=8000;
        g2.gain.setValueAtTime(0.04,ac2.currentTime);g2.gain.exponentialRampToValueAtTime(0.001,ac2.currentTime+0.06);
        src.connect(filt);filt.connect(g2);g2.connect(ac2.destination);src.start();src.stop(ac2.currentTime+0.06);
      }
      // Occasional melodic note
      if(beat%8===0||beat%8===5){
        var note=scale[Math.floor(Math.random()*scale.length)];
        var o2=ac2.createOscillator(),g3=ac2.createGain();
        o2.type='triangle';o2.frequency.value=note;
        g3.gain.setValueAtTime(0,ac2.currentTime);g3.gain.linearRampToValueAtTime(0.05,ac2.currentTime+0.04);
        g3.gain.exponentialRampToValueAtTime(0.001,ac2.currentTime+0.35);
        o2.connect(g3);g3.connect(ac2.destination);o2.start();o2.stop(ac2.currentTime+0.35);
      }
    }catch(e){}
    beat++;
  }
  pulseInterval=setInterval(pulse,200);
  musicNodes.push({stop:function(){clearInterval(pulseInterval);}});
}

function stopMusic(){
  musicPlaying=false;
  for(var i=0;i<musicNodes.length;i++){try{if(musicNodes[i].stop)musicNodes[i].stop();}catch(e){}}
  musicNodes=[];
}

// ‚îÄ‚îÄ‚îÄ AUDIO CONTROLS UI ‚îÄ‚îÄ‚îÄ
var audioControlsHTML='<div id="audioBar" style="position:fixed;bottom:175px;left:50%;transform:translateX(-50%);display:none;gap:8px;z-index:12;pointer-events:all;align-items:center;"></div>';
document.body.insertAdjacentHTML('beforeend',audioControlsHTML);

// Singularity tap zone ‚Äî shown when beam rank >= 5
function updateBeamSelector(){
  var sel=document.getElementById('beamSelector');
  if(!sel||!G||!G.running) return;
  var unlockedBeams=BEAM_DEFS.filter(function(d){return (beamRanks[d.id]||0)>=1;});
  var allBeams=BEAM_DEFS; // show all, gray locked ones
  // Rebuild only if needed (check child count)
  if(sel.children.length!==allBeams.length){
    sel.innerHTML='';
    allBeams.forEach(function(def){
      var btn=document.createElement('button');
      btn.setAttribute('data-beam',def.id);
      btn.style.cssText='font-family:Orbitron,monospace;font-size:11px;padding:6px 10px;background:rgba(0,8,24,0.92);border-radius:3px;cursor:pointer;pointer-events:all;letter-spacing:1px;transition:none;';
      btn.textContent=def.icon;
      btn.title=def.name;
      btn.addEventListener('pointerdown',function(e){
        e.stopPropagation();
        var rank=beamRanks[def.id]||0;
        if(rank<1){
          // Locked ‚Äî open shop
          SFX.click&&SFX.click();
          if(G) G.paused=true;
          openBeamShop(true);
          return;
        }
        activeBeam=def.id; lsS('vr_activeBeam',activeBeam);
        if(G&&G.running) applyBeamToGun();
        SFX.click&&SFX.click();
        fmsg(def.icon+' '+def.name+' EQUIPPED',def.color);
        updateBeamSelector();
      });
      sel.appendChild(btn);
    });
  }
  // Update styles
  allBeams.forEach(function(def,i){
    var btn=sel.children[i];
    if(!btn) return;
    var rank=beamRanks[def.id]||0;
    var isActive=activeBeam===def.id;
    var unlocked=rank>=1;
    btn.style.border='1px solid '+(isActive?def.color:unlocked?def.color+'66':'#223');
    btn.style.color=isActive?def.color:unlocked?def.color+'88':'#334';
    btn.style.opacity=unlocked?'1':'0.45';
    btn.style.boxShadow=isActive?'0 0 10px '+def.color+'66':'none';
  });
  var show=G&&G.running&&!G.paused&&allBeams.length>0;
  sel.style.display=show?'flex':'none';
}
function updateSingularityBtn(){
  var btn=document.getElementById('singBtn');
  if(!btn)return;
  var show=!!(ownedBeam()&&G&&G.running);
  btn.style.display=show?'flex':'none';
  if(show) tutCheckSingularity();
  if(G&&G._singularityCd>0){btn.style.opacity='0.35';btn.textContent='‚ö° '+(Math.ceil(G._singularityCd))+'s';}
  else{btn.style.opacity='1';btn.textContent='‚ö° SINGULARITY';}
}
function buildAudioBar(){
  var bar=document.getElementById('audioBar');
  bar.innerHTML='';
  var mBtn=document.createElement('button');
  mBtn.style.cssText='font-family:Orbitron,monospace;font-size:9px;letter-spacing:1px;padding:5px 8px;background:rgba(2,2,16,0.9);border:1px solid rgba(0,245,255,0.2);color:'+(musicEnabled?'#00f5ff':'#334')+';cursor:pointer;border-radius:2px;';
  mBtn.textContent=musicEnabled?'‚ô™ ON':'‚ô™ OFF';
  mBtn.addEventListener('pointerdown',function(){
    musicEnabled=!musicEnabled;SFX.click();
    if(musicEnabled&&G&&G.running)startMusic();else stopMusic();
    buildAudioBar();
  });
  var sBtn2=document.createElement('button');
  sBtn2.style.cssText='font-family:Orbitron,monospace;font-size:9px;letter-spacing:1px;padding:5px 8px;background:rgba(2,2,16,0.9);border:1px solid rgba(0,245,255,0.2);color:'+(sfxEnabled?'#00f5ff':'#334')+';cursor:pointer;border-radius:2px;';
  sBtn2.textContent=sfxEnabled?'SFX ON':'SFX OFF';
  sBtn2.addEventListener('pointerdown',function(){sfxEnabled=!sfxEnabled;SFX.click();buildAudioBar();});
  bar.appendChild(mBtn);bar.appendChild(sBtn2);
}
buildAudioBar();

buildBgForGalaxy(0);

// ‚ïê‚ïê TUTORIAL SYSTEM ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
var tutSeen = lsG('vr_tut', {});
function tutDone(key){ return !!tutSeen[key]; }
function tutMark(key){ tutSeen[key]=1; lsS('vr_tut',tutSeen); }

// Queue ‚Äî only one bubble on screen at a time
var _tutQueue = [];
var _tutActive = false;

function showTutBubble(opts){
  if(tutDone(opts.key)) return;
  // If one is already showing, queue this one
  if(_tutActive){ _tutQueue.push(opts); return; }
  _showNextBubble(opts);
}

function _showNextBubble(opts){
  if(!opts) return;
  if(tutDone(opts.key)){
    // Already seen (e.g. queued then seen another way) ‚Äî skip, try next in queue
    var next = _tutQueue.shift();
    if(next) _showNextBubble(next);
    return;
  }
  tutMark(opts.key);
  _tutActive = true;

  // Pause game while tooltip is showing
  if(G && G.running && !G.paused){
    G.paused = true;
    G._tutPaused = true;
  }

  var el = document.createElement('div');
  el.className = 'tut-bubble';

  var titleEl = document.createElement('div');
  titleEl.className = 'tut-title';
  titleEl.textContent = opts.title || '';
  el.appendChild(titleEl);

  var bodyEl = document.createElement('div');
  bodyEl.textContent = opts.text;
  el.appendChild(bodyEl);

  var okBtn = document.createElement('button');
  okBtn.className = 'tut-ok';
  okBtn.textContent = 'OK, GOT IT';
  el.appendChild(okBtn);

  document.body.appendChild(el);

  requestAnimationFrame(function(){
    var w = el.offsetWidth, h = el.offsetHeight;
    var bw = window.innerWidth, bh = window.innerHeight;
    var px = opts.x || bw/2, py = opts.y || bh/2;
    var anchor = opts.anchor || 'bc';
    var left, top;
    if(anchor==='bl'){left=px; top=py-h-12;}
    else if(anchor==='br'){left=px-w; top=py-h-12;}
    else if(anchor==='tl'){left=px; top=py+12;}
    else if(anchor==='tr'){left=px-w; top=py+12;}
    else if(anchor==='tc'){left=px-w/2; top=py+12;}
    else{left=px-w/2; top=py-h-12;}
    left = Math.max(8, Math.min(bw-w-8, left));
    top  = Math.max(8, Math.min(bh-h-8, top));
    el.style.left = left+'px';
    el.style.top  = top+'px';
    el.classList.add('show');
  });

  okBtn.addEventListener('pointerdown', function(e){
    e.stopPropagation();
    el.style.opacity = '0';
    setTimeout(function(){
      if(el.parentNode) el.parentNode.removeChild(el);
      _tutActive = false;
      // Resume game if it was running when paused by tut
      if(G && G.running && G._tutPaused){
        G._tutPaused = false;
        G.paused = false;
        if(!loopRunning){ last=0; safeRAF(); }
      }
      var next = _tutQueue.shift();
      if(next) _showNextBubble(next);
    }, 420);
  });
}

// ‚îÄ‚îÄ Individual tutorial triggers ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function tutCheckWelcome(){
  if(tutDone('tut_welcome')) return;
  tutMark('tut_welcome');
  _tutActive = true;
  if(G&&G.running&&!G.paused){ G.paused=true; G._tutPaused=true; }

  var el=document.createElement('div');
  el.className='tut-bubble';
  el.style.maxWidth='300px';
  el.style.pointerEvents='all';

  var sections=[
    {type:'title',text:'WELCOME TO VOID RUNNERS'},
    {type:'body', text:'You are the last interceptor standing between humanity and an endless galactic onslaught.'},
    {type:'body', text:'Your mission: push through all 10 galaxies, defeat each Overlord boss, and survive long enough to reach the Void Heart.'},
    {type:'head', text:'HOW TO PLAY'},
    {type:'body', text:'Your ship auto-fires at enemies ‚Äî dodge their attacks and stay alive.'},
    {type:'body', text:'Mine asteroids by tapping and holding them, or let your turret destroy them passively. Crystals fund permanent upgrades that carry between runs.'},
    {type:'body', text:'Defeat enemies to level up and earn run upgrades. Beat the boss to open a warp portal to the next galaxy.'},
    {type:'note', text:'Good luck, pilot.'},
  ];
  sections.forEach(function(s){
    var d=document.createElement('div');
    if(s.type==='title') d.style.cssText='font-family:Orbitron,sans-serif;font-size:11px;color:#00f5ff;letter-spacing:2px;margin-bottom:10px;text-shadow:0 0 12px #00f5ff;';
    else if(s.type==='head') d.style.cssText='font-family:Orbitron,sans-serif;font-size:9px;color:#ffd700;letter-spacing:2px;margin:10px 0 5px;';
    else if(s.type==='note') d.style.cssText='font-size:10px;color:#446;margin-top:10px;font-style:italic;';
    else d.style.cssText='font-size:11px;color:#aab;line-height:1.55;margin-bottom:5px;';
    d.textContent=s.text;
    el.appendChild(d);
  });

  var okBtn=document.createElement('button');
  okBtn.className='tut-ok';
  okBtn.textContent='OK, GOT IT';
  el.appendChild(okBtn);
  document.body.appendChild(el);

  requestAnimationFrame(function(){
    var w=el.offsetWidth,h=el.offsetHeight;
    el.style.left=Math.max(8,(window.innerWidth-w)/2)+'px';
    el.style.top=Math.max(8,(window.innerHeight-h)/2)+'px';
    el.classList.add('show');
  });

  okBtn.addEventListener('pointerdown',function(e){
    e.stopPropagation();
    el.style.opacity='0';
    setTimeout(function(){
      if(el.parentNode) el.parentNode.removeChild(el);
      _tutActive=false;
      if(G&&G.running&&G._tutPaused){G._tutPaused=false;G.paused=false;if(!loopRunning){last=0;safeRAF();}}
      var next=_tutQueue.shift();
      if(next) _showNextBubble(next);
    },420);
  });
}
function tutCheckAsteroid(){
  showTutBubble({key:'tut_asteroid', title:'MINING',
    text:'Tap and hold an asteroid to mine it for crystals.',
    x:window.innerWidth*0.5, y:window.innerHeight*0.38, anchor:'tc'});
}
function tutCheckCrystal(){
  showTutBubble({key:'tut_crystal', title:'CRYSTALS',
    text:'Crystals fund permanent upgrades between runs. Spend them in the Hangar and Upgrades menus.',
    x:window.innerWidth*0.5, y:window.innerHeight*0.15, anchor:'tc'});
}
function tutCheckLevelUp(){
  showTutBubble({key:'tut_levelup', title:'RANK UP',
    text:'Select an upgrade to power up this run. These reset each run. Permanent upgrades live in the main menu.',
    x:window.innerWidth*0.5, y:window.innerHeight*0.82, anchor:'bc'});
}
function tutCheckAbility(){
  showTutBubble({key:'tut_ability', title:'ABILITIES',
    text:'Tap the ability buttons at the bottom to activate special powers. Each one has a cooldown timer.',
    x:window.innerWidth*0.5, y:window.innerHeight*0.88, anchor:'bc'});
}
function tutCheckSingularity(){
  showTutBubble({key:'tut_singularity', title:'SINGULARITY',
    text:'This is your beam ultimate attack. Tap SINGULARITY to unleash it. It gets more powerful as you upgrade your beam.',
    x:window.innerWidth*0.5, y:window.innerHeight*0.78, anchor:'bc'});
}
function tutCheckDamage(){
  showTutBubble({key:'tut_damage', title:'HULL DAMAGE',
    text:'Your hull is taking damage! Collect green shield pickups to repair. Your hull bar is at the top of the screen.',
    x:window.innerWidth*0.5, y:window.innerHeight*0.12, anchor:'tc'});
}
function tutCheckWarp(){
  showTutBubble({key:'tut_warp', title:'WARP PORTAL',
    text:'Boss defeated! Fly into the portal to warp to the next galaxy. Enemies get tougher but the rewards grow.',
    x:window.innerWidth*0.5, y:window.innerHeight*0.82, anchor:'bc'});
}
function tutCheckRelic(relic, screenX, screenY){
  var bx = Math.min(Math.max(screenX, 120), window.innerWidth-120);
  var by = Math.max(screenY-80, 80);
  showTutBubble({key:'tut_relic', title:'RELIC DROPPED',
    text:'A relic appeared! Fly over it to collect it. This one is ' + relic.name + ': ' + relic.desc,
    x:bx, y:by, anchor:'bc'});
}
// ‚ïê‚ïê END TUTORIAL SYSTEM ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

</script>

<!-- VOID TREE PANEL -->
<div id="voidTreePanel" style="position:fixed;inset:0;display:none;flex-direction:column;align-items:center;background:rgba(2,2,10,0.98);z-index:60;pointer-events:all;overflow-y:auto;padding:18px 0 32px;">
  <h2 style="font-family:'Orbitron',sans-serif;color:#aa00ff;font-size:18px;letter-spacing:4px;text-shadow:0 0 20px #aa00ff;margin:0 0 2px 0;">‚ú¶ VOID ASCENSION</h2>
  <div id="vtShards" style="font-family:'Orbitron',sans-serif;font-size:10px;color:#aa00ff;letter-spacing:2px;margin-bottom:2px;"></div>
  <div id="vtEssence" style="font-family:'Orbitron',sans-serif;font-size:10px;color:#9b59ff;letter-spacing:2px;margin-bottom:14px;"></div>
  <div id="vtCards" style="width:min(92vw,460px);display:flex;flex-direction:column;margin-bottom:16px;"></div>
  <button class="btn" id="vtClose">‚Üê BACK</button>
</div>

<!-- VOID TREE PANEL -->
<div id="voidTreePanel" style="position:fixed;inset:0;display:none;flex-direction:column;align-items:center;background:rgba(2,2,10,0.98);z-index:60;pointer-events:all;overflow-y:auto;padding:18px 0 32px;">
  <h2 style="font-family:'Orbitron',sans-serif;color:#9b59ff;font-size:18px;letter-spacing:4px;text-shadow:0 0 20px #9b59ff;margin:0 0 4px 0;">‚ö° VOID ASCENSION</h2>
  <div id="voidTreeEssence" style="font-family:'Orbitron',sans-serif;font-size:11px;color:#9b59ff;letter-spacing:2px;margin-bottom:2px;"></div>
  <div id="voidTreeShards" style="font-family:'Orbitron',sans-serif;font-size:9px;color:#cc88ff;letter-spacing:1px;margin-bottom:14px;"></div>
  <div id="voidTreeCards" style="width:min(92vw,460px);display:flex;flex-direction:column;margin-bottom:16px;"></div>
  <button class="btn" id="voidTreeClose">‚Üê BACK</button>
</div>
</body>
</html>
